<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Updated Title for Dual Brand -->
    <title>Bulb Cafe & Gulabi Thali</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts - Using Poppins for modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Theme Variables */
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-yellow: #FFFBEB; --bg-secondary-yellow: #FEF3C7; --text-primary-yellow: #92400E; --text-secondary-yellow: #B45309; --border-yellow: #FDE68A; --brand-primary-yellow: #F59E0B;
            --bg-primary-pink: #FFF5F7; --bg-secondary-pink: #FCE7F6; --text-primary-pink: #9D174D; --text-secondary-pink: #E94C8F; --border-pink: #FBCFE8; --brand-primary-pink: #DB2777;
            --app-height: 100vh;
        }
        /* Theme Selection - Brand Themes */
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="bulb"] { --bg-primary: var(--bg-primary-yellow); --bg-secondary: var(--bg-secondary-yellow); --text-primary: var(--text-primary-yellow); --text-secondary: var(--text-secondary-yellow); --border-color: var(--border-yellow); --brand-primary: var(--brand-primary-yellow); }
        [data-theme="gulabi"] { --bg-primary: var(--bg-primary-pink); --bg-secondary: var(--bg-secondary-pink); --text-primary: var(--text-primary-pink); --text-secondary: var(--text-secondary-pink); --border-color: var(--border-pink); --brand-primary: var(--brand-primary-pink); }


        /* Base & Utility Styles */
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Poppins', sans-serif; background-color: #000000; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        .app-container { background-color: var(--bg-primary); transition: background-color 0.5s ease; height: var(--app-height); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }
        .brand-border { border-color: var(--brand-primary); }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; } @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #splash-screen .brand-logo { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Custom UI Elements */
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .horizontal-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .spinner {
            border: 2px solid var(--bg-primary);
            border-top: 2px solid var(--brand-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tracking Tracker */
        .tracker-container { display: flex; align-items: center; justify-content: space-between; position: relative; }
        .tracker-line-container { position: absolute; top: 18px; left: 40px; right: 40px; height: 4px; background-color: var(--border-color); border-radius: 2px; }
        .tracker-progress { height: 100%; background-color: var(--brand-primary); border-radius: 2px; transition: width 0.5s ease-in-out; }
        .tracker-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 80px; position: relative; z-index: 1; }
        .tracker-icon-container { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 20px; }
        .tracker-step.active .tracker-icon-container { border-color: var(--brand-primary); background-color: var(--brand-primary); color: var(--bg-primary); transform: scale(1.1); }
        .tracker-label { margin-top: 8px; font-size: 10px; font-weight: 600; transition: color 0.3s ease; }
        .tracker-step.active .tracker-label { color: var(--brand-primary); }

        /* Menu/Cart Controls */
        .add-to-cart-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); color: var(--brand-primary); border: 2px solid var(--border-color); font-size: 24px; font-weight: 600; line-height: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .add-to-cart-btn:hover { transform: scale(1.1); background-color: var(--brand-primary); color: var(--bg-primary); border-color: var(--brand-primary); }
        .quantity-control { display: flex; align-items: center; justify-content: space-between; background-color: var(--brand-primary); color: var(--bg-primary); border-radius: 9999px; font-weight: 600; overflow: hidden; width: 100px; height: 40px; user-select: none; }
        .quantity-control button { width: 34px; height: 100%; font-size: 20px; line-height: 1; transition: background-color 0.2s ease; }
        .quantity-control button:hover { background-color: rgba(0,0,0,0.1); }
        .quantity-control span { font-size: 16px; }
        
        /* View Only Button for Gulabi Thali */
        .view-only-btn { 
            background-color: var(--bg-primary); 
            color: var(--text-secondary); 
            border: 2px solid var(--border-color); 
            font-weight: 600; 
            padding: 8px 12px;
            border-radius: 9999px;
            font-size: 0.8rem;
        }

        /* Loyalty Slider */
        #loyalty-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 4px; }
        #loyalty-slider:hover { opacity: 1; }
        #loyalty-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--brand-primary); cursor: pointer; border-radius: 50%; }
        #loyalty-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--brand-primary); cursor: pointer; border-radius: 50%; border: none; }

        /* Social/Instagram Card */
        .social-card-gradient {
            background: radial-gradient(circle at 30% 107%, #FCD34D 0%, #F59E0B 45%, #DB2777 60%, #E94C8F 90%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Gulabi Thali Switch Button Style (Prominent) */
        .gulabi-switch-btn {
            background-color: var(--bg-secondary-pink);
            color: var(--text-primary-pink);
            border: 2px solid var(--brand-primary-pink);
            transition: all 0.2s ease;
        }
        .gulabi-switch-btn:hover {
            box-shadow: 0 4px 8px rgba(219, 39, 119, 0.3);
        }

    </style>
</head>
<body data-theme="bulb">

    <!-- Splash Screen with Brand Logo -->
    <div id="splash-screen" class="fixed inset-0 bg-primary flex flex-col items-center justify-center z-[100]">
        <!-- Bulb Logo -->
        <div class="brand-logo text-7xl mb-4" style="color: var(--brand-primary);">üí°</div>
        <h1 class="text-3xl font-bold brand-text">BULB CAFE</h1>
    </div>

    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto">
            <div id="main-interface" class="hidden">
                <!-- Page Header (Sticky) -->
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-16 px-4 flex justify-between items-center border-b border-custom"></header>
                <!-- Page Content Area -->
                <div id="page-content"></div>
            </div>
            <!-- Footer Spacer -->
            <div class="h-20 flex-shrink-0"></div>
        </main>
        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-16 z-30 hidden"></nav>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed right-4 py-3 px-5 rounded-lg shadow-xl z-50 transition-all duration-300" style="background-color: var(--brand-primary); color: var(--bg-primary); bottom: 80px;">
        <p id="toast-message"></p>
    </div>

<!-- FIX: Load Supabase as a standard script before the module script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
    // FIX: Accessing createClient from the global window.supabase object.
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    }
    window.addEventListener('resize', setAppHeight);
    setAppHeight();

    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';
    
    // Check for the global variable exposed by the CDN
    const createClient = window.supabase ? window.supabase.createClient : null;
    let supabase = null;
    
    // Initialize Supabase only if createClient is found
    if (createClient) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("CRITICAL: Supabase client library not found on window.supabase. App cannot function.");
        // Fallback for UI if Supabase fails to load
        document.addEventListener('DOMContentLoaded', () => {
             $('#splash-screen').innerHTML = `<div class="text-white text-center p-4">Error loading data components. Check Console.</div>`;
             $('#splash-screen').style.backgroundColor = '#FF0000';
        });
    }

    const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'more'];

    // --- STATIC DATA ---
    const STATIC_DATA = {
        // Best sellers removed as per request. Placeholder maintained for future use.
        bestSellers: [], 
        captionIdeas: {
            cafe_vibes: [ "Fueling my day with the best coffee @bulbcafe! üí°‚òïÔ∏è", "Cozy corners and great beans at Bulb Cafe. #CafeVibes" ],
            thali_time: [ "Feast mode ON! Enjoying the delicious thali at Gulabi Thali. üçΩÔ∏èüíñ #IndianFood", "Nothing beats a traditional thali! @gulabithali." ],
            friends: [ "Great food and great company! Cheers from Bulb Cafe. üéâ", "Lunch plans sorted! @bulbcafe" ]
        },
        // Updated Video URL
        videoUrl: "https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/WhatsApp%20Video%202025-11-01%20at%2020.52.47_2473f7b8.mp4"
    };
    
    // --- SOUND EFFECTS ---
    const sound = {
        audioContext: null,
        init() {
            if (this.audioContext) return;
            try { this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
            catch (e) { console.error("Web Audio API is not supported."); }
        },
        play(type) {
            if (!this.audioContext) return;
            const o = this.audioContext.createOscillator(), g = this.audioContext.createGain();
            o.connect(g); g.connect(this.audioContext.destination); g.gain.setValueAtTime(0, this.audioContext.currentTime);
            
            // Custom Bulb Sound: High frequency sine wave for a brief "ping"
            const sounds = {
                click: { type: 'sine', freq: 800, gain: 0.15, len: 0.05 },
                add_to_cart: { type: 'sine', freq: 900, gain: 0.2, len: 0.1 },
                success: { type: 'sine', freq: 1000, gain: 0.3, len: 0.1, secondFreq: 1200 },
                win: { type: 'sine', freq: 700, gain: 0.4, len: 0.2, secondFreq: 1000 },
                draw: { type: 'sawtooth', freq: 250, gain: 0.2, len: 0.1 },
            };

            const s = sounds[type]; if (!s) return;
            o.type = s.type; o.frequency.setValueAtTime(s.freq, this.audioContext.currentTime);
            g.gain.linearRampToValueAtTime(s.gain, this.audioContext.currentTime + 0.01);
            if (s.secondFreq) { o.frequency.setValueAtTime(s.secondFreq, this.audioContext.currentTime + (s.len / 2)); }
            g.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + s.len);
            o.start(this.audioContext.currentTime); o.stop(this.audioContext.currentTime + s.len);
        }
    };


    // --- APP LOGIC ---
    const app = {
        state: {
            currentPage: 'home',
            cart: [],
            activeOrder: null,
            tableNumber: null,
            user: null,
            customerProfile: null,
            theme: localStorage.getItem('brand-theme') || 'bulb', // Default to Bulb brand theme
            menuData: [],
            allMenuItems: [],
            appSettings: {},
            orderSubscription: null,
            currentMenuCategory: 'All Menu', // Default category
            searchQuery: '',
            searchResults: [],
            pointsToRedeem: 0,
        },

        async init() {
            document.body.addEventListener('click', () => sound.init(), { once: true });
            if (!supabase) {
                console.error("Supabase failed to initialize. Cannot start app.");
                return; 
            }

            const initialHash = location.hash.substring(1);
            if (PAGES.includes(initialHash)) {
                 this.state.currentPage = initialHash;
            } else {
                 this.state.currentPage = 'home';
                 location.hash = 'home';
            }
            window.addEventListener('popstate', this.handleHardwareBack.bind(this));

            this.startAppFlow();
        },

        async startAppFlow() {
            this.applyTheme();
            $('#splash-screen').classList.remove('hidden');
            this.getTableNumberFromURL();

            try {
                // 1. ANONYMOUS SIGN-IN
                let session = null;
                try {
                    const { data } = await supabase.auth.getSession();
                    session = data.session;
                } catch(e) { console.error("Session check failed:", e); }
                
                this.state.user = session?.user;
                if (!this.state.user) {
                    console.log("No session found. Signing in anonymously...");
                    const { data: signInData, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                        console.error("Anonymous sign-in failed:", error);
                        throw new Error(`Auth failed: ${error.message}`);
                    }
                    this.state.user = signInData.user;
                    console.log("Signed in as anonymous user:", this.state.user.id);
                }

                // 2. FETCH OR CREATE PROFILE
                await this.fetchCustomerProfile();
                
                // 3. LOAD REMAINING DATA
                await Promise.all([ this.fetchMenuData(), this.fetchAppSettings() ]);

                // 4. START UI
                $('#splash-screen').style.display = 'none';
                $('#app').classList.remove('hidden');
                $('#app').classList.add('flex');

                if (!this.state.customerProfile || !this.state.customerProfile.name || !this.state.customerProfile.whatsapp_number) {
                     this.showOnboardingModal();
                } else if (this.state.tableNumber) {
                    this.startSession();
                } else {
                    this.showTableNumberModal();
                }

            } catch (error) {
                console.error("CRITICAL: App Initialization failed.", error);
                $('#splash-screen').innerHTML = `<div class="text-primary text-center p-4">Could not load app: ${error.message}</div>`;
            }
        },

        getTableNumberFromURL() {
            const params = new URLSearchParams(window.location.search);
            const tableNum = params.get('table');
            if (tableNum && !isNaN(parseInt(tableNum))) this.state.tableNumber = parseInt(tableNum);
        },

        async fetchCustomerProfile() {
            if (!this.state.user) return;
            const userId = this.state.user.id;

            try {
                // 1. Try fetching the existing profile
                const { data, error } = await supabase.from('customers')
                    .select('*, loyalty_points')
                    .eq('id', userId)
                    .single();

                // If no row found (PGRST116), we need to create it.
                if (error && error.code === 'PGRST116') {
                    console.log("Profile not found. Attempting to create profile...");
                    return this.createUserProfile(userId);
                }
                
                // If a different error occurs (e.g., RLS blocking SELECT), throw the error
                if (error) throw error;
                
                // 2. Profile found and successfully read
                if (data) {
                    data.loyalty_points = data.loyalty_points || 0;
                    this.state.customerProfile = data;
                    console.log("Profile loaded successfully.");
                    return data;
                }
                
                // Should not happen if error checking is correct, but safe fallback:
                return this.createUserProfile(userId);

            } catch (error) {
                console.error('Error fetching/creating profile:', error.message);
                ui.showToast('Could not load user profile.');
                this.state.customerProfile = { id: userId, name: 'Guest', loyalty_points: 0, whatsapp_number: null };
            }
        },
        
        async createUserProfile(userId) {
            try {
                const newProfile = { id: userId, name: 'Guest', loyalty_points: 0, whatsapp_number: null };
                const { data, error } = await supabase
                    .from('customers')
                    .insert(newProfile)
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log("New user profile created successfully.");
                this.state.customerProfile = data;
                return data;
                
            } catch (error) {
                // Handle potential race condition where profile was created just now by another call.
                if (error.code === '23505') { // Unique violation
                    console.warn("Profile creation failed due to duplicate entry. Re-fetching...");
                    // Try to fetch again now that it exists
                    return this.fetchCustomerProfile();
                }
                console.error("Error creating profile:", error.message);
                throw new Error(`Profile creation failed: ${error.message}`);
            }
        },

        async fetchMenuData() {
            try {
                const { data, error } = await supabase.from('products').select('*').order('id');
                if (error) throw error;

                this.state.allMenuItems = data.filter(i => i.is_available);

                const groupedMenu = data.reduce((acc, item) => {
                    if (!item.is_available) return acc;
                    let category = acc.find(c => c.category === item.category);
                    if (!category) {
                        category = { category: item.category, items: [] };
                        acc.push(category);
                    }
                    category.items.push(item);
                    return acc;
                }, []);

                this.state.menuData = groupedMenu;
                
                // Set initial category state now that data is loaded
                const activeBrand = document.body.dataset.theme === 'gulabi' ? 'Gulabi Thali' : 'Bulb Cafe';
                
                // FIX: Removed 'item' variable reference (typo)
                const firstCategory = groupedMenu.find(c => c.items.some(i => i?.brand === activeBrand));
                this.state.currentMenuCategory = firstCategory ? firstCategory.category : 'All Menu';


            } catch (error) {
                console.error('Error fetching menu data:', error);
                ui.showToast('Could not load the menu.');
                this.state.menuData = [];
                this.state.allMenuItems = [];
            }
        },

        async fetchAppSettings() {
            try {
                const { data, error } = await supabase.from('app_settings').select('key, value');
                if (error) throw error;
                this.state.appSettings = data.reduce((acc, { key, value }) => ({ ...acc, [key]: value }), {});
            } catch (error) { console.error('Error fetching app settings:', error); }
        },

        showOnboardingModal(){
            const tableInputHTML = !this.state.tableNumber
                ? `<input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>`
                : '';
            ui.showModal('onboarding-modal', `
                <h2 class="text-2xl font-bold text-primary mb-2">Welcome!</h2><p class="text-secondary mb-6">A few details to get you started.</p>
                <div class="space-y-4">
                    <input type="text" id="user-name-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Name" required value="${this.state.customerProfile?.name || ''}">
                    <input type="tel" id="mobile-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Mobile Number (for Loyalty Points)" required value="${this.state.customerProfile?.whatsapp_number || ''}">
                    ${tableInputHTML}
                </div>
                <button onclick="app.completeOnboarding()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">Let's Go</button>
            `);
        },

        async completeOnboarding(){
            const name = $('#user-name-input').value.trim();
            const phone = $('#mobile-number-input').value.trim();
            let tableNumber = this.state.tableNumber;

            if (!tableNumber) {
                 const tableInput = $('#table-number-input');
                 if (!tableInput || !tableInput.value) return ui.showToast("Please enter your table number.");
                 tableNumber = parseInt(tableInput.value);
            }
            if (!name) return ui.showToast("Please enter your name.");
            if (!phone || !/^\d{10}$/.test(phone.replace(/\D/g,''))) return ui.showToast("Please enter a valid 10-digit mobile number for loyalty points.");
            const cleanPhone = phone.replace(/\D/g,'');

            let finalProfileData;
            try {
                const { data: existingByPhone, error: errorByPhone } = await supabase.from('customers').select('*, loyalty_points').eq('whatsapp_number', cleanPhone).maybeSingle();

                if (existingByPhone) {
                     finalProfileData = existingByPhone;
                     console.log(`Found existing customer by phone: ${finalProfileData.id}`);
                     if (finalProfileData.name !== name || finalProfileData.id !== this.state.user.id) {
                        const { error: updateError } = await supabase.from('customers')
                            .update({ name: name, id: this.state.user.id })
                            .eq('whatsapp_number', cleanPhone);
                        if (updateError) {
                            console.warn("Could not link user ID or update name:", updateError);
                            finalProfileData.name = name; // Update local copy even if DB fails
                        } else {
                            finalProfileData.id = this.state.user.id;
                            finalProfileData.name = name;
                        }
                     }
                } else {
                     const { data: existingById, error: errorById } = await supabase.from('customers').select('*, loyalty_points').eq('id', this.state.user.id).maybeSingle();
                     if (existingById) {
                         const { data: updatedData, error: updateDetailsError } = await supabase.from('customers')
                            .update({ whatsapp_number: cleanPhone, name: name })
                            .eq('id', this.state.user.id)
                            .select('*, loyalty_points')
                            .single();
                         if (updateDetailsError) throw updateDetailsError;
                         finalProfileData = updatedData;
                         console.log(`Updated existing customer ${finalProfileData.id} with phone and name.`);
                     } else {
                         console.log("Inserting new customer profile.");
                         const { data: insertedData, error: insertError } = await supabase.from('customers').insert({
                             id: this.state.user.id,
                             name,
                             whatsapp_number: cleanPhone,
                             loyalty_points: 0
                         }).select('*, loyalty_points').single();
                         if (insertError) throw insertError;
                         finalProfileData = insertedData;
                     }
                }

                this.state.customerProfile = finalProfileData;
                this.state.customerProfile.loyalty_points = this.state.customerProfile.loyalty_points || 0;
                this.state.tableNumber = tableNumber;
                
                // FIX: Initialize main UI *before* closing the modal
                await this.startSession(); // This calls showMainInterface()
                ui.closeModal('onboarding-modal'); // Now close the modal
                this.navigateTo('home', false); // Manually set the final state

            } catch (error) {
                console.error("Onboarding/Linking Error:", error);
                if (error.message.includes('duplicate key value violates unique constraint')) {
                    ui.showToast('This phone number might be linked to another session. Please retry.');
                } else if (error.message.includes('violates row-level security policy for table')) {
                     ui.showToast('Could not save profile due to security policy. Please contact support.');
                } else {
                     ui.showToast(`Could not save profile: ${error.message}`);
                }
            }
        },


        showTableNumberModal() {
            ui.showModal('table-number-modal', `
                <h2 class="text-2xl font-bold text-primary mb-2">Welcome back, ${this.state.customerProfile.name}!</h2>
                <p class="text-secondary mb-6">Please enter your table number for today's visit.</p>
                <input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>
                <button onclick="app.completeTableNumberEntry()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">Continue</button>
            `);
        },

        completeTableNumberEntry() {
            const tableNumber = $('#table-number-input').value;
            if (!tableNumber) return ui.showToast("Please enter your table number.");
            this.state.tableNumber = parseInt(tableNumber);
            ui.closeModal('table-number-modal');
            this.startSession();
        },

        async startSession() {
            await this.fetchActiveOrder();
            this.showMainInterface();
        },

        showMainInterface(){
            $('#main-interface').classList.remove('hidden');
            $('#bottom-nav').classList.remove('hidden');
            ui.renderBottomNav();
            // Do not navigate here, let the calling function handle navigation
            // to prevent the "double-click" tab issue.
        },

        navigateTo(page, pushToHistory = true){
             if (!this.state.customerProfile) return;
             
             // If clicking the same tab, do nothing.
             if (this.state.currentPage === page && !pushToHistory && location.hash.substring(1) === page) {
                 return;
             }
             
             sound.play('click');
             
             // --- Robust Back/Forward/Modal Navigation Logic ---
             const currentHash = location.hash.substring(1);
             const openModal = $('#modal-container').children[0];

             // If a modal is open, treat the navigation attempt as a request to close the modal first.
             if (openModal && pushToHistory && currentHash !== openModal.id) {
                // If user clicks a tab while modal is open, close modal and navigate.
                ui.closeModal(openModal.id); 
                // Then, proceed with navigation logic below.
             }

             if (pushToHistory) {
                if (currentHash !== page) {
                    location.hash = page; // Pushes new state
                }
             } else {
                 // This is a 'popstate' (back button) or internal navigation (modal close)
                 if (currentHash !== page) {
                     history.replaceState(null, '', '#' + page);
                 }
             }
             
             // Always update UI after determining history state
             this.state.currentPage = page;
             ui.renderHeader(page);
             ui.renderPageContent(page);
             ui.updateActiveNav(page);
        },

        handleHardwareBack(event) {
             const openModal = $('#modal-container').children[0];

             if (openModal) {
                // 1. Close open modal
                ui.closeModal(openModal.id);
                event.preventDefault(); // Stop browser default back
                // We DON'T replace state here; closeModal will handle it.
                return;
             }
             
             // 2. Prevent infinite back loop or sudden exit on mobile
             if (this.state.currentPage !== 'home') {
                 event.preventDefault();
                 this.navigateTo('home', true); // Navigate back to home *and* push history
             }
             // If already on 'home', allow default behavior (exit or app minimum navigation)
        },

        applyTheme(){ document.body.dataset.theme = this.state.theme; },
        toggleTheme(t){ this.state.theme = t; localStorage.setItem('brand-theme', t); this.applyTheme(); this.refreshPage(); },

        addOrUpdateCart(itemId, quantityChange) {
            // Check if the item belongs to Gulabi Thali (View Mode)
            const item = this.state.allMenuItems.find(i => i.id === itemId);
            if (item && item.brand === 'Gulabi Thali') {
                return ui.showToast("Gulabi Thali items are currently view-only for dine-in. Please select Bulb Cafe items or contact staff.", 'error');
            }

            sound.play('click');
            if (!item) return;

            let cartItem = this.state.cart.find(i => i.id === itemId);
            let newQuantity = (cartItem ? cartItem.quantity : 0) + quantityChange;

            if (newQuantity <= 0) {
                this.state.cart = this.state.cart.filter(i => i.id !== itemId);
            } else {
                if (cartItem) {
                    cartItem.quantity = newQuantity;
                } else {
                    this.state.cart.push({ cartId: Date.now(), ...item, quantity: newQuantity });
                }
                if (quantityChange > 0) sound.play('add_to_cart');
            }
            this.state.pointsToRedeem = 0; // Reset points on cart change
            this.refreshPage();
        },

        setCartItemQuantity(itemId, quantity) {
            const item = this.state.allMenuItems.find(i => i.id === itemId);
            
            // Check if the item belongs to Gulabi Thali (View Mode)
            if (item && item.brand === 'Gulabi Thali' && quantity > 0) {
                 ui.closeModal('item-detail-modal');
                 return ui.showToast("Gulabi Thali items are currently view-only for dine-in. Please select Bulb Cafe items or contact staff.", 'error');
            }

            if (!item) return;

            if (quantity <= 0) {
                this.state.cart = this.state.cart.filter(i => i.id !== itemId);
            } else {
                let cartItem = this.state.cart.find(i => i.id === itemId);
                if (cartItem) {
                    cartItem.quantity = quantity;
                } else {
                    this.state.cart.push({ cartId: Date.now(), ...item, quantity: quantity });
                }
            }
            if(quantity > 0) {
                sound.play('add_to_cart');
                ui.showToast('Cart updated!');
            }
            this.state.pointsToRedeem = 0; // Reset points on quantity change
            ui.closeModal('item-detail-modal');
            this.refreshPage();
        },

        performSearch(query) {
             const searchContainer = $('#search-results-container');
             const menuContainer = $('#menu-items');
             const tabsContainer = $('#category-tabs-container');
             this.state.searchQuery = query.toLowerCase();

             if (this.state.searchQuery.length > 1) {
                if (searchContainer) searchContainer.classList.remove('hidden');
                if (menuContainer) menuContainer.classList.add('hidden');
                if (tabsContainer) tabsContainer.classList.add('hidden');
                
                // Filter all items by brand first
                const activeBrand = (document.body.dataset.theme === 'gulabi' ? 'Gulabi Thali' : 'Bulb Cafe').toLowerCase();
                const brandItems = this.state.allMenuItems.filter(item => (item?.brand?.toLowerCase() || 'undefined') === activeBrand);
                
                this.state.searchResults = brandItems.filter(item =>
                    item.name?.toLowerCase().includes(this.state.searchQuery) ||
                    (item.description && item.description.toLowerCase().includes(this.state.searchQuery))
                );
                // FIX: Use ui.renderMenuItems directly with the search results
                ui.renderMenuItems(this.state.searchResults, 'search-results-container');
             } else {
                if (searchContainer) searchContainer.classList.add('hidden');
                if (menuContainer) menuContainer.classList.remove('hidden');
                if (tabsContainer) tabsContainer.classList.remove('hidden');
                this.state.searchResults = [];
                // Go back to the currently selected category when search is cleared
                ui.filterMenuByCategory(this.state.currentMenuCategory, $(`.category-tab[data-category="${this.state.currentMenuCategory}"]`));
             }
        },

        calculateCartTotal(){
            const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
            const availablePoints = this.state.customerProfile?.loyalty_points || 0;

            // 1. Calculate max discount
            const redeemablePoints = Math.floor(availablePoints * 0.8);
            const maxRedeemableForOrder = Math.min(redeemablePoints, Math.floor(subtotal));

            // 2. Clamp current discount
            const actualPointsToRedeem = Math.min(this.state.pointsToRedeem, maxRedeemableForOrder);
            const discountAmount = actualPointsToRedeem;

            // 3. Update state if clamped
            if (this.state.pointsToRedeem !== actualPointsToRedeem) {
                console.log("Clamping points to redeem:", actualPointsToRedeem);
                this.state.pointsToRedeem = actualPointsToRedeem;
            }
            
            // 4. Calculate final totals WITH GST
            const discountedSubtotal = subtotal - discountAmount;
            const gst = discountedSubtotal * 0.05; // 5% GST
            const finalTotal = discountedSubtotal + gst;

            return { 
                subtotal, 
                discountAmount, 
                discountedSubtotal, 
                gst, 
                finalTotal: Math.max(0, finalTotal),
                maxRedeemableForOrder 
            };
        },

        updatePointsToRedeem(points) {
            this.state.pointsToRedeem = parseInt(points);
            ui.updateCartSummary();
        },

        refreshPage(){
            ui.refreshCartDependentUI();
            if (PAGES.includes(this.state.currentPage)) {
                ui.renderPageContent(this.state.currentPage);
            }
        },

        async placeOrder(paymentMethod, btnElement){
            if (!supabase) return ui.showToast("Order failed: Supabase not initialized.");
            if (this.state.cart.length === 0 || !this.state.tableNumber) return ui.showToast("Cart empty or table missing.");
            if (!this.state.customerProfile || !this.state.customerProfile.id) {
                console.error("Critical Error: Customer profile ID is missing.", this.state.customerProfile);
                return ui.showToast("Error: Your profile is not loaded correctly. Please refresh.");
            }

            btnElement.disabled = true; const originalBtnHTML = btnElement.innerHTML;
            btnElement.innerHTML = `<span class="flex items-center justify-center"><div class="spinner mr-2"></div> Processing...</span>`;

            const { subtotal, discountAmount, gst, finalTotal } = this.calculateCartTotal();
            const pointsToRedeem = this.state.pointsToRedeem;

            let orderData;

            try {
                const { data: tableData, error: tableError } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
                if (tableError || !tableData) throw new Error(`Table #${this.state.tableNumber} invalid.`);

                if (pointsToRedeem > 0) {
                    const { data: currentProfile, error: profileError } = await supabase.from('customers').select('loyalty_points').eq('id', this.state.customerProfile.id).single();
                    if (profileError || !currentProfile || currentProfile.loyalty_points < pointsToRedeem) {
                         throw new Error('Insufficient points. Please refresh cart.');
                    }
                }

                const effectiveDiscountPercent = (subtotal > 0) ? (discountAmount / subtotal) * 100 : 0;

                const orderPayload = {
                    customer_id: this.state.customerProfile.id,
                    table_id: tableData.id,
                    total_amount: finalTotal,
                    discount_percentage: effectiveDiscountPercent,
                    discount_points_redeemed: pointsToRedeem,
                    discount_amount: discountAmount,
                    final_amount: finalTotal,
                    payment_method: paymentMethod,
                    special_instructions: $('#special-instructions')?.value || '',
                    feedback_submitted: false
                };
                const { data: insertedOrder, error: orderError } = await supabase.from('orders').insert(orderPayload).select().single();
                if (orderError) {
                    console.error("Order Insert Error:", orderError);
                    throw new Error(`Order placement failed. (Hint: Check RLS policies for 'orders' table. Customer ID: ${this.state.customerProfile.id})`);
                }
                orderData = insertedOrder;

                const orderItems = this.state.cart.map(i => ({
                    order_id: orderData.id,
                    product_id: i.id,
                    quantity: i.quantity,
                    price_at_time_of_order: i.price
                }));
                const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
                if (itemsError) {
                    console.error("Order Items Insert Error:", itemsError);
                    await supabase.from('orders').delete().eq('id', orderData.id);
                    throw new Error(`Order items failed. (Hint: Check RLS policies for 'order_items' table)`);
                }

                // Points transactions
                try {
                    if (pointsToRedeem > 0) {
                         const { error: redeemError } = await supabase.rpc('redeem_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_redeem: pointsToRedeem });
                         if (redeemError) throw new Error(`Redeem failed: ${redeemError.message}`);
                         this.state.customerProfile.loyalty_points -= pointsToRedeem;
                    }

                    const pointsEarned = Math.floor(subtotal / 500) * 50;
                    if (pointsEarned > 0) {
                         const { error: incrementError } = await supabase.rpc('increment_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_add: pointsEarned });
                         if (incrementError) console.error("Award points failed:", incrementError);
                         else {
                             this.state.customerProfile.loyalty_points += pointsEarned;
                         }
                    }
                } catch (pointsError) {
                    console.warn("Points transaction failed after order success:", pointsError.message);
                    ui.showToast("Order placed, but points update failed.");
                    await this.fetchCustomerProfile();
                }

                // Success flow
                ui.closeModal('payment-modal');
                this.state.activeOrder = orderData;
                this.listenToOrderUpdates(orderData.id);
                this.state.cart = [];
                this.state.pointsToRedeem = 0;
                this.refreshPage();
                sound.play('success');
                this.navigateTo('cart');

            } catch (error) {
                console.error("Place Order Failed:", error);
                ui.showToast(`Order failed: ${error.message}`);
                if (error.message.includes('points') || error.message.includes('profile')) {
                    await this.fetchCustomerProfile();
                    this.state.pointsToRedeem = 0;
                    this.refreshPage();
                }
                btnElement.disabled = false;
                btnElement.innerHTML = originalBtnHTML;
                const otherBtn = [...$$('.payment-btn')].find(b => b !== btnElement);
                if(otherBtn) otherBtn.disabled = false;
            }
        },


        async fetchActiveOrder(){
            if (!this.state.user || !this.state.customerProfile?.id) return;
            try {
                const { data, error } = await supabase.from('orders')
                    .select(`*, order_items(*, products(name)), feedback_submitted`)
                    .eq('customer_id', this.state.customerProfile.id)
                    .in('status', ['received', 'preparing'])
                    .order('created_at', { ascending: false })
                    .limit(1).single();

                if (error && error.code !== 'PGRST116') console.error('Fetch active order error:', error);
                this.state.activeOrder = data || null;
                if (this.state.activeOrder) {
                    this.listenToOrderUpdates(this.state.activeOrder.id);
                }
            } catch (error) {
                console.error("Error fetching active order:", error);
            }
        },

        listenToOrderUpdates(orderId){
            if (!supabase) return;
            if (this.state.orderSubscription) {
                supabase.removeChannel(this.state.orderSubscription);
                this.state.orderSubscription = null;
            }
            console.log(`Listening order: ${orderId}`);
            this.state.orderSubscription = supabase.channel(`public:orders:id=eq.${orderId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, payload => {
                    if (!this.state.activeOrder || this.state.activeOrder.id !== payload.new.id) return;

                    const updatedOrder = payload.new;
                    let uiNeedsRefresh = false;

                    if (updatedOrder.status !== this.state.activeOrder.status) {
                        ui.showToast(`Your order is now: ${updatedOrder.status}`);
                        this.state.activeOrder.status = updatedOrder.status;
                        uiNeedsRefresh = true;
                    }
                    if ('feedback_submitted' in updatedOrder && updatedOrder.feedback_submitted !== this.state.activeOrder.feedback_submitted) {
                        this.state.activeOrder.feedback_submitted = updatedOrder.feedback_submitted;
                        uiNeedsRefresh = true;
                    }

                    if (['delivered', 'cancelled'].includes(updatedOrder.status)) {
                        supabase.removeChannel(this.state.orderSubscription);
                        this.state.orderSubscription = null;
                        console.log("Order finished, unsubscribed.");

                        if (updatedOrder.status === 'delivered' && !updatedOrder.feedback_submitted) {
                             ui.showModal('review-modal', `
                                <div class="text-center">
                                    <span class="text-3xl">‚≠ê</span>
                                    <h2 class="text-2xl font-bold mt-4">Order Delivered!</h2>
                                    <p class="text-secondary my-2">How was your experience? <br/>(+10 Loyalty Points for feedback!)</p>
                                    <textarea id="feedback-text" class="w-full p-3 border border-custom rounded-lg bg-secondary" rows="3" placeholder="Tell us more..."></textarea>
                                    <button onclick="app.submitFeedback('${orderId}')" class="w-full mt-4 brand-bg font-semibold py-3 rounded-lg">Submit Feedback</button>
                                    <button onclick="ui.closeModal('review-modal')" class="w-full mt-2 bg-secondary py-3 rounded-lg">Maybe Later</button>
                                </div>`);
                        } else if (updatedOrder.status === 'cancelled') {
                            ui.showToast('Your order has been cancelled.');
                        }
                        this.state.activeOrder = null;
                        uiNeedsRefresh = true;
                    }
                    if(uiNeedsRefresh && this.state.currentPage === 'cart') {
                         this.refreshPage();
                    } else if (uiNeedsRefresh && this.state.currentPage === 'home') {
                        this.refreshPage();
                    }
                }).subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        console.log(`Subscribed to order ${orderId}`);
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.error(`Subscription failed:`, status, err);
                    }
                });
        },


        async submitFeedback(orderId){
            if (!supabase) return ui.showToast("Feedback failed: Supabase not initialized.");
            if (!this.state.customerProfile || !this.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
            const content = $('#feedback-text').value.trim();
            if (!content) return ui.showToast("Please enter your feedback.");

            const submitBtn = $('#review-modal button:first-of-type');
            if (submitBtn) submitBtn.disabled = true;

            try {
                const { data: orderData, error: fetchError } = await supabase.from('orders').select('feedback_submitted').eq('id', orderId).single();
                if (fetchError || !orderData) throw new Error("Could not verify order status.");
                if (orderData.feedback_submitted) {
                    ui.showToast("Feedback already submitted for this order.");
                    ui.closeModal('review-modal');
                    return;
                }

                // 1. Insert feedback
                const { error: insertError } = await supabase.from('feedback').insert({
                    order_id: orderId,
                    customer_id: this.state.customerProfile.id,
                    content: content,
                    rating: 5
                });
                if (insertError) throw insertError;

                // 2. Mark order as feedback submitted
                 const { error: updateError } = await supabase.from('orders')
                     .update({ feedback_submitted: true })
                     .eq('id', orderId);
                 if (updateError) console.warn("Could not mark order as feedback submitted:", updateError);

                // 3. Award loyalty points
                const { error: incrementError } = await supabase.rpc('increment_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_add: 10 });
                if (incrementError) {
                    console.error("Feedback points award failed:", incrementError);
                    ui.showToast("Feedback submitted, but points award failed.");
                }
                else {
                     this.state.customerProfile.loyalty_points += 10;
                     ui.showToast("Thank you for your feedback! +10 Points added.");
                }

                ui.closeModal('review-modal');
                this.refreshPage();

            } catch (error) {
                 console.error("Feedback submission error:", error);
                 ui.showToast(`Feedback failed: ${error.message}`);
                 if (submitBtn) submitBtn.disabled = false;
            }
        },

        async sendStaffCall(callType = 'assistance') {
            if (!supabase) return ui.showToast("Call failed: Supabase not initialized.");
            if (!this.state.tableNumber) return ui.showToast('Table number not set.');
            if (!this.state.customerProfile || !this.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
            const { data: tableData } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
            if (!tableData) return ui.showToast('Invalid table number.');

            const { error } = await supabase.from('staff_calls').insert({
                table_id: tableData.id,
                customer_id: this.state.customerProfile.id,
                call_type: callType
            });

            if (error) {
                ui.showToast(`Error calling staff: ${error.message}`);
            } else {
                ui.showToast(`Staff have been notified! They'll be right over.`, 5000);
            }
        },

        copyCaption(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) ui.showToast('Copied!');
                else ui.showToast('Copy failed.');
            } catch (err) {
                console.error('Fallback copy failed', err);
                ui.showToast('Copy failed.');
            }
            document.body.removeChild(textArea);
        }
    };
    
    // --- UI RENDERING ---
    const ui = {
        showModal(id, content) {
            location.hash = id;
            const existingModal = $(`#${id}`);
            if (existingModal) existingModal.remove();

            const modalHTML = `
                <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50 p-4">
                    <div class="modal-content bg-primary rounded-t-2xl shadow-xl p-6 w-full max-w-lg">
                        ${content}
                    </div>
                </div>`;
            $('#modal-container').insertAdjacentHTML('beforeend', modalHTML);
        },

        closeModal(id) {
            const modal = $(`#${id}`);
            if (modal) modal.remove();
            
            // Navigate back to the current page without pushing a new history entry
            if (location.hash.substring(1) === id) {
                 // We only replace state, app.navigateTo will be handled by the caller
                 history.replaceState(null, '', '#' + app.state.currentPage);
            }
        },

        showToast(message, duration = 3000) {
            const toast = $('#toast'), p = $('#toast-message');
            p.textContent = message;
            toast.classList.remove('hidden');
            // Re-apply styles on toast for dynamic theming
            toast.style.backgroundColor = 'var(--brand-primary)';
            toast.style.color = 'var(--bg-primary)';

            toast.style.animation = `toast-in 0.5s ease, toast-out 0.5s ease ${duration / 1000 - 0.5}s forwards`;
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.style.animation = '';
            }, duration);
        },

        renderHeader(page) {
            const header = $('#page-header');
            const brandLogo = document.body.dataset.theme === 'gulabi' ? 'üíñ THALI' : 'üí° CAF√â';
            
            const pageConfigs = {
                home: { title: brandLogo },
                order: { title: 'Menu'},
                cart: { title: app.state.activeOrder ? 'Track Order' : 'My Cart'},
                social: { title: 'Post & Win'},
                cowork: { title: 'GULABI THALI KITCHEN'}, // Updated tab title
                more: { title: 'Options'}
            };
            const config = pageConfigs[page] || { title: brandLogo };
            header.innerHTML = `
                <div class="flex items-center space-x-2">
                    <!-- Adjusted font size to prevent overflow, added truncate -->
                    <h1 class="text-xl font-bold brand-text truncate">${config.title}</h1> 
                </div>
                <div class="text-right">
                    <p class="font-semibold text-primary text-sm">${app.state.customerProfile?.name || 'Guest'}</p>
                    <p class="text-xs text-secondary">Table #${app.state.tableNumber || 'N/A'}</p>
                </div>`;
        },

        renderPageContent(page) {
            const content = $('#page-content');
            content.innerHTML = '';
            const renderers = {
                home: this.renderHomePage,
                order: this.renderMenuPage,
                cart: this.renderCartPage,
                social: this.renderSocialPage,
                cowork: this.renderCoworkPage,
                more: this.renderMorePage,
            };
            content.classList.remove('fade-in');
            void content.offsetWidth;
            content.classList.add('fade-in');
            renderers[page]?.call(this);
        },

        renderBottomNav(){
            const icons = {
                home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
                order: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
                cart: `<div class="relative"><svg id="cart-icon-svg" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span></div>`,
                social: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-2-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`,
                cowork: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h-4v-4h-2v4H7M4 11l8-8 8 8M4 20h16a1 1 0 001-1V9.5a1 1 0 00-1-1h-2a1 1 0 00-1 1V14a1 1 0 01-1 1H8a1 1 0 01-1-1v-4.5a1 1 0 00-1-1H4a1 1 0 00-1 1V19a1 1 0 001 1z" /></svg>`, // Custom home/kitchen icon
                more: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>`
            };

            const labels = { home: 'Home', order: 'Menu', cart: 'Cart', social: 'Social', cowork: 'Thali Kitchen', more: 'More' }; // Updated tab label
            // FIX: Add onClick handler to buttons
            $('#bottom-nav').innerHTML = PAGES.map(p => `<button onclick="app.navigateTo('${p}')" class="nav-item flex-1 p-2 text-secondary" data-page="${p}">${icons[p]}<span id="${p}-tab-label" class="text-xs font-bold capitalize">${labels[p]}</span></button>`).join('');
        },

        updateActiveNav(page) {
            // FIX: Check for element existence before trying to set properties
            const cartLabel = $('#cart-tab-label'), cartIcon = $('#cart-icon-svg');
            
            if (cartLabel && cartIcon) { // Ensure elements exist
                if (app.state.activeOrder) {
                    cartLabel.textContent = 'Track';
                    cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />`;
                } else {
                    cartLabel.textContent = 'Cart';
                    cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />`;
                }
            }
            
            $$('.nav-item').forEach(item => {
                const isActive = item.dataset.page === page;
                item.classList.toggle('brand-text', isActive);
                item.classList.toggle('text-secondary', !isActive);
                item.style.transform = isActive ? 'scale(1.1)' : 'scale(1)';
            });
            this.refreshCartDependentUI();
        },

        refreshCartDependentUI() {
            const el = $('#cart-count');
            const total = app.state.cart.reduce((s, i) => s + i.quantity, 0);
            if (el) { // Add null check
                if (total > 0 && !app.state.activeOrder) {
                    el.textContent = total;
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            }
        },

        renderHomePage(){
            const settings = app.state.appSettings;
            const activeOrderHTML = app.state.activeOrder ? `<div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center"> <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2> <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p> <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button> </div>` : '';
            const loyaltyBannerHTML = `
                <div class="bg-yellow-100 border border-yellow-200 text-yellow-800 p-4 rounded-xl text-center shadow-sm">
                    <h2 class="font-bold text-lg">‚ú® Earn 10% Back! ‚ú®</h2>
                    <p class="mt-1">Get <strong class="font-semibold">50 Loyalty Points</strong> (worth ‚Çπ50) for every ‚Çπ500 spent.</p>
                    <p class="text-xs mt-1">Redeem points in your cart!</p>
                </div>`;
            
            const activeBrand = document.body.dataset.theme === 'gulabi' ? 'Gulabi Thali' : 'Bulb Cafe';
            const bulbBtnClass = document.body.dataset.theme === 'bulb' ? 'brand-bg font-bold' : 'bg-secondary text-secondary font-semibold';
            
            // Prominent Gulabi Thali button
            const gulabiButtonHTML = `
                <button onclick="app.toggleTheme('gulabi')" class="gulabi-switch-btn w-full p-4 rounded-xl text-center shadow-lg transition duration-300">
                    <div class="text-3xl">üíñ</div>
                    <p class="font-extrabold text-2xl mt-1" style="color: var(--text-primary-pink);">GULABI THALI</p>
                    <p class="text-sm mt-1" style="color: var(--text-secondary-pink);">CLICK TO SWITCH VIEW</p>
                </button>
            `;
            
            const bulbButtonHTML = `
                 <button onclick="app.toggleTheme('bulb')" class="w-full p-3 rounded-xl text-center ${bulbBtnClass}">
                    <div class="text-3xl">üí°</div>
                    <p class="font-bold text-lg mt-1 ${document.body.dataset.theme === 'bulb' ? '' : 'brand-text'}">BULB CAF√â</p>
                    <p class="text-sm ${document.body.dataset.theme === 'bulb' ? 'text-primary' : 'text-secondary'}">CLICK TO SWITCH VIEW</p>
                </button>
            `;


            $('#page-content').innerHTML = `
                <div class="space-y-6">
                    <!-- Video Hero Area -->
                    <div class="relative h-48 overflow-hidden rounded-b-2xl">
                        <video src="${STATIC_DATA.videoUrl}" 
                               autoplay loop muted playsinline preload="metadata" 
                               class="absolute top-1/2 left-1/2 w-full h-full object-cover -translate-x-1/2 -translate-y-1/2"></video>
                        <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                            <!-- Removed branding text from video -->
                        </div>
                    </div>
                    <div class="p-4 space-y-8">
                        
                        <!-- BRAND SWITCHER (Prominent) -->
                        <div class="grid grid-cols-1 gap-4">
                            ${activeBrand === 'Bulb Cafe' ? gulabiButtonHTML : bulbButtonHTML}
                        </div>
                        
                        ${loyaltyBannerHTML}
                        ${activeOrderHTML ? `<div class="mt-8">${activeOrderHTML}</div>` : ''}
                        
                        
                        <button onclick="app.navigateTo('order')" class="w-full brand-bg font-semibold py-4 px-6 rounded-lg text-lg"> View Full Menu </button>
                        
                    </div>
                </div>`;
        },
        
        showBrandSwitcherModal() {
            const currentTheme = document.body.dataset.theme;
            // Removed Light/Dark themes from the modal
            ui.showModal('brand-switcher-modal', `
                <h2 class="text-xl font-bold mb-4">Select Active Brand</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="app.toggleTheme('bulb')" class="p-4 rounded-xl text-center border-2 ${currentTheme === 'bulb' ? 'brand-border' : 'border-secondary'}" style="background-color: var(--bg-secondary-yellow); color: var(--text-primary-yellow);">
                        <span class="text-3xl">üí°</span><p class="font-semibold mt-1">Bulb Cafe</p>
                    </button>
                    <button onclick="app.toggleTheme('gulabi')" class="p-4 rounded-xl text-center border-2 ${currentTheme === 'gulabi' ? 'brand-border' : 'border-secondary'}" style="background-color: var(--bg-secondary-pink); color: var(--text-primary-pink);">
                        <span class="text-3xl">üíñ</span><p class="font-semibold mt-1">Gulabi Thali</p>
                    </button>
                </div>
                <button onclick="ui.closeModal('brand-switcher-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },


        renderMenuPage(){
            const content = $('#page-content');
            
            // 1. Filter menu data based on active brand (theme)
            const activeBrand = document.body.dataset.theme === 'gulabi' ? 'Gulabi Thali' : 'Bulb Cafe';
            
            // Filter categories based on which ones contain items for the active brand
            const filteredMenuData = app.state.menuData
                .map(categoryObj => {
                    // Filter items *within* each category
                    const items = categoryObj.items.filter(item => (item?.brand || '').toLowerCase() === activeBrand.toLowerCase());
                    return { ...categoryObj, items };
                })
                .filter(categoryObj => categoryObj.items.length > 0); // Remove categories with no items for this brand
            
            let allCategories = [{ category: 'All Menu' }, ...filteredMenuData];
            
            // Set initial category if not set or if the current one is filtered out
            if (!app.state.currentMenuCategory || !allCategories.some(c => c.category === app.state.currentMenuCategory)) {
                app.state.currentMenuCategory = 'All Menu';
            }
            
            if (filteredMenuData.length === 0 && app.state.allMenuItems.length === 0) {
                content.innerHTML = `<div class="p-4 text-center text-secondary">Loading menu...</div>`;
                return;
            }

            content.innerHTML = `
                <div id="active-order-banner" class="p-4 hidden"></div>
                <div class="p-4">
                    <input type="text" id="menu-search-input" placeholder="Search menu..." class="w-full p-3 border-2 border-custom rounded-lg bg-secondary text-primary text-lg" oninput="app.performSearch(this.value)" value="${app.state.searchQuery}">
                </div>
                <div id="category-tabs-container" class="horizontal-scroll sticky top-16 bg-primary z-10 flex space-x-4 px-4 pb-3 overflow-x-auto border-b border-custom">
                    ${allCategories.map(c => `
                        <button class="category-tab whitespace-nowrap font-semibold py-2 px-1 ${app.state.currentMenuCategory === c.category ? 'brand-text border-b-2 border-current' : 'text-secondary'}"
                                data-category="${c.category}"
                                onclick="ui.filterMenuByCategory('${c.category}', this)">
                            ${c.category}
                        </button>`).join('')}
                </div>
                <div id="menu-items" class="p-4 grid grid-cols-1 gap-4"></div>
                <div id="search-results-container" class="p-4 grid grid-cols-1 gap-4 hidden"></div>`;

            if (app.state.activeOrder) {
                $('#active-order-banner').classList.remove('hidden');
                $('#active-order-banner').innerHTML = `
                    <div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center">
                        <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2>
                        <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p>
                        <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button>
                    </div>`;
            }

            if (app.state.searchQuery.length > 1) {
                app.performSearch(app.state.searchQuery);
            } else {
                this.filterMenuByCategory(app.state.currentMenuCategory, $(`.category-tab[data-category="${app.state.currentMenuCategory}"]`));
            }
        },

        filterMenuByCategory(category, tabElement) {
            const categoryToUse = category || 'All Menu';
            app.state.currentMenuCategory = categoryToUse;
            
            // Only clear search if it's not a search result render
            if (tabElement) {
                app.state.searchQuery = '';
                const searchInput = $('#menu-search-input');
                if (searchInput) searchInput.value = '';
            }
            
            $('#search-results-container')?.classList.add('hidden');
            $('#menu-items')?.classList.remove('hidden');
            $('#category-tabs-container')?.classList.remove('hidden');

            if (tabElement) {
                $$('.category-tab').forEach(tab => {
                    tab.classList.remove('brand-text', 'border-b-2', 'border-current');
                    tab.classList.add('text-secondary');
                });
                tabElement.classList.add('brand-text', 'border-b-2', 'border-current');
            }

            let itemsToShow = [];
            const activeBrand = (document.body.dataset.theme === 'gulabi' ? 'Gulabi Thali' : 'Bulb Cafe').toLowerCase();
            
            const categoryToLower = categoryToUse.toLowerCase();

            // Filter all items that match the current active brand
            const brandItems = app.state.allMenuItems.filter(item => (item?.brand?.toLowerCase() || 'undefined') === activeBrand);

            if (categoryToUse === 'All Menu') {
                itemsToShow = brandItems;
            } else {
                // Filter by category, ensuring category is present before calling toLowerCase
                itemsToShow = brandItems.filter(item => (item?.category?.toLowerCase() || 'undefined') === categoryToLower);
            }
            
            this.renderMenuItems(itemsToShow, 'menu-items');
        },

        renderMenuItems(items, containerId) {
            const container = $(`#${containerId}`);
            if (!container) return;
            
            // Determine if the current view is Gulabi Thali (View Only)
            const isGulabiView = document.body.dataset.theme === 'gulabi';

            if (!items || items.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center col-span-full mt-8">No items found for this selection.</p>`;
                return;
            }
            
            container.innerHTML = items.map(item => {
                const cartItem = app.state.cart.find(ci => ci.id === item.id);
                let actionButtonHTML = '';
                
                if (isGulabiView) {
                     // GULABI THALI: Always show View Only button
                    actionButtonHTML = `<div class="view-only-btn">View Only</div>`;
                } else if (cartItem) {
                    // BULB CAFE: Item is in cart (Show quantity control)
                    actionButtonHTML = `
                        <div class="quantity-control" onclick="event.stopPropagation();">
                            <button onclick="app.addOrUpdateCart(${item.id}, -1)">-</button>
                            <span>${cartItem.quantity}</span>
                            <button onclick="app.addOrUpdateCart(${item.id}, 1)">+</button>
                        </div>
                    `;
                } else {
                    // BULB CAFE: Item not in cart (Show Add button)
                    actionButtonHTML = `
                        <button class="add-to-cart-btn" onclick="event.stopPropagation(); app.addOrUpdateCart(${item.id}, 1)">
                            +
                        </button>
                    `;
                }

                return `
                    <div class="bg-secondary rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="ui.showItemDetailModal(${item.id})">
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex-1 pr-4">
                                <h3 class="font-semibold text-base truncate text-primary">${item.name}</h3>
                                <p class="font-bold text-sm text-secondary mt-1">‚Çπ${item.price}</p>
                            </div>
                            <div class="flex-shrink-0">
                                ${actionButtonHTML}
                            </div>
                        </div>
                    </div>`;
            }).join('');
        },

        renderCartPage() {
            const content = $('#page-content');
            if (app.state.activeOrder) this.renderOrderTracking(content);
            else if (app.state.cart.length > 0) this.renderCart(content);
            else content.innerHTML = `
                <div class="text-center p-10">
                    <h2 class="text-2xl font-bold text-primary">Your cart is empty</h2>
                    <p class="text-secondary mt-2">Add items from the menu to get started.</p>
                    <button onclick="app.navigateTo('order')" class="mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">View Menu</button>
                </div>`;
        },

        renderCart(container){
            const { subtotal, discountAmount, gst, finalTotal, maxRedeemableForOrder } = app.calculateCartTotal();
            const loyaltyPoints = app.state.customerProfile?.loyalty_points || 0;
            
            app.state.pointsToRedeem = Math.min(app.state.pointsToRedeem, maxRedeemableForOrder);
            const currentDiscount = app.state.pointsToRedeem;

            let promoMessage = '';
            
            const loyaltyExplanation = `<p class="text-xs text-secondary mt-1 mb-3">Earn 50 points (worth ‚Çπ50) for every ‚Çπ500 spent on subtotal. Redeemable points = 80% of balance.</p>`;

            let loyaltySectionHTML = '';
            if (loyaltyPoints > 0 && maxRedeemableForOrder > 0) {
                loyaltySectionHTML = `
                    <div class="p-4 border-t border-b border-custom">
                        <h3 class="font-bold text-lg mb-2 text-primary">Redeem Loyalty Points</h3>
                        <p class="text-sm text-secondary mb-1">Available: ${loyaltyPoints} points</p>
                        ${loyaltyExplanation}
                        <p class="text-sm text-secondary mb-3">Redeemable (max ‚Çπ${maxRedeemableForOrder}):</p>
                        <input type="range" id="loyalty-slider" min="0" max="${maxRedeemableForOrder}" value="${app.state.pointsToRedeem}"
                               oninput="app.updatePointsToRedeem(this.value)" class="w-full h-2 rounded-lg cursor-pointer">
                        <div class="flex justify-between text-sm font-semibold mt-2">
                            <span>Redeem: <span id="points-to-redeem-display">${app.state.pointsToRedeem}</span> pts</span>
                            <span>Discount: - ‚Çπ<span id="discount-amount-display">${currentDiscount.toFixed(2)}</span></span>
                        </div>
                    </div>`;
            } else if (loyaltyPoints > 0) {
                 loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><p class="text-sm text-secondary text-center">You have ${loyaltyPoints} points. ${loyaltyExplanation} Earn more/increase order total to redeem.</p></div>`;
            } else {
                 loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><p class="text-sm text-secondary text-center">${loyaltyExplanation}</p></div>`;
            }


            container.innerHTML = `
                <div class="p-4 space-y-3">
                    ${app.state.cart.map(i => `
                        <div class="bg-secondary p-3 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="font-bold text-primary">${i.name}</p>
                                <p class="font-semibold text-secondary text-sm">‚Çπ${(i.price * i.quantity).toFixed(2)}</p>
                            </div>
                            <div class="quantity-control" style="background-color: var(--bg-primary); color: var(--brand-primary); border: 1px solid var(--border-color);">
                                <button onclick="app.addOrUpdateCart(${i.id}, -1)">-</button>
                                <span>${i.quantity}</span>
                                <button onclick="app.addOrUpdateCart(${i.id}, 1)">+</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${promoMessage}
                ${loyaltySectionHTML}
                <div class="p-4"><textarea id="special-instructions" class="w-full p-3 border-custom rounded-lg bg-secondary" placeholder="Add special instructions..."></textarea></div>
                <div class="p-4 bg-primary border-t-custom sticky bottom-16">
                     <div id="cart-summary" class="mb-4 space-y-1 text-primary"></div>
                    <button id="place-order-btn" onclick="ui.showPaymentModal()" class="w-full brand-bg font-bold py-4 rounded-lg">Proceed to Payment</button>
                </div>`;
            this.updateCartSummary();
        },

        updateCartSummary() {
            const { subtotal, discountAmount, gst, finalTotal } = app.calculateCartTotal();
            const currentDiscount = discountAmount;

            const pointsDisplay = $('#points-to-redeem-display');
            const discountDisplay = $('#discount-amount-display');
            if(pointsDisplay) pointsDisplay.textContent = currentDiscount.toFixed(0);
            if(discountDisplay) discountDisplay.textContent = currentDiscount.toFixed(2);

            const summaryDiv = $('#cart-summary');
            if (summaryDiv) {
                summaryDiv.innerHTML = `
                    <div class="flex justify-between items-center text-md">
                        <span>Subtotal</span>
                        <span>‚Çπ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-md text-green-600 ${currentDiscount > 0 ? '' : 'hidden'}">
                        <span>Loyalty Discount</span>
                        <span>- ‚Çπ${currentDiscount.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-md ${gst > 0 ? '' : 'hidden'}">
                        <span>GST (5%)</span>
                        <span>‚Çπ${gst.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold pt-1 border-t border-custom">
                        <span>To Pay</span>
                        <span>‚Çπ${finalTotal.toFixed(2)}</span>
                    </div>`;
            }
        },


        renderOrderTracking(container) {
            const order = app.state.activeOrder;
            if (!order) { container.innerHTML = ''; return; }
            const statuses = ['received', 'preparing', 'delivered'];
            const icons = { received: 'üìù', preparing: 'üç≥', delivered: 'üòä' };
            const currentIndex = statuses.indexOf(order.status);
            const progressPercentage = currentIndex > 0 ? (currentIndex / (statuses.length - 1)) * 100 : 0;
            container.innerHTML = `
                <div class="p-6 flex flex-col items-center justify-center h-full">
                    <h2 class="text-3xl font-bold text-center capitalize">Your Order is ${order.status}</h2>
                    <p class="text-secondary text-center mb-10">Order ID: #${order.id.slice(0,6)}</p>
                    <div class="tracker-container my-12 w-full max-w-sm">
                        <div class="tracker-line-container">
                            <div class="tracker-progress" style="width: ${progressPercentage}%"></div>
                        </div>
                        ${statuses.map((status, index) => `
                            <div class="tracker-step ${index <= currentIndex ? 'active' : ''}">
                                <div class="tracker-icon-container">${icons[status]}</div>
                                <span class="tracker-label capitalize">${status}</span>
                            </div>`).join('')}
                    </div>
                    <div class="mt-auto pt-10 text-center">
                        <p class="text-secondary mb-4">While you wait, why not play a game?</p>
                        <button onclick="app.navigateTo('more')" class="brand-bg font-semibold py-3 px-8 rounded-lg">View Games</button>
                    </div>
                </div>`;
        },

        renderSocialPage(){
            const currentBrand = document.body.dataset.theme === 'gulabi' ? '@gulabithali' : '@bulbcafe';
            const promoTitle = 'Post a story tagging us to win a prize!';
            const promoSubtitle = `Tag ${currentBrand} in your story and show it at the counter for a special prize!`;
            
            const vibes = Object.entries(STATIC_DATA.captionIdeas).map(([key, _]) => ({
                name: key, icon: { cafe_vibes: '‚òï', thali_time: 'üçõ', friends: 'üéâ' }[key]
            }));
            $('#page-content').innerHTML = `
                <div class="p-4 space-y-6 text-center">
                     <div class="bg-secondary p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-primary">Join Our Community!</h2>
                        <p class="text-secondary mt-1">Follow us on Instagram for updates and offers.</p>
                        <a href="https://instagram.com/bulbcafe" target="_blank" class="text-2xl font-bold my-4 block brand-text">${currentBrand}</a>
                        <div class="flex justify-center">
                             <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://instagram.com/bulbcafe" alt="Instagram QR Code" class="rounded-lg bg-white p-2">
                        </div>
                        <p class="text-xs text-secondary mt-2">Scan to follow!</p>
                    </div>

                    <div onclick="ui.showInstagramPromo()" class="cursor-pointer group relative bg-secondary rounded-xl p-6 overflow-hidden shadow-sm text-left">
                         <h2 class="text-2xl font-bold text-primary">${promoTitle}</h2>
                        <p class="mt-1 text-secondary">${promoSubtitle}</p>
                        <!-- Removed caption ideas button -->
                        <a href="https://instagram.com/stories/create" target="_blank" class="font-semibold mt-3 text-sm brand-bg px-4 py-2 rounded-lg group-hover:opacity-90 transition inline-block">Post Story &rarr;</a>
                    </div>
                </div>
            `;
        },

        renderCoworkPage() {
            // Updated page content to reflect Gulabi Thali Kitchen
            $('#page-content').innerHTML = `
                <div class="p-6 space-y-6 text-center">
                     <div class="bg-secondary p-8 rounded-xl shadow-lg border border-custom">
                        <span class="text-5xl mb-4 block">ü•ò</span>
                        <h2 class="text-3xl font-bold text-primary mb-2">GULABI THALI KITCHEN</h2>
                        <p class="text-lg text-secondary mb-6">Our dedicated kitchen for preparing authentic Indian cuisine. Available for dine-in at Bulb Cafe.</p>
                        <button onclick="app.toggleTheme('bulb')" class="w-full mb-4 gulabi-switch-btn font-semibold py-3 px-6 rounded-lg transition hover:opacity-90">
                            CLICK TO SWITCH BACK TO CAF√â MENU
                        </button>
                        <ul class="text-left space-y-2 mb-8 list-disc list-inside text-secondary">
                            <li>View our full Thali menu on the 'Menu' tab when switched to Gulabi Thali.</li>
                            <li>All thali and mini-meal items are prepared here.</li>
                            <li>Authentic taste guaranteed.</li>
                        </ul>
                    </div>
                </div>
            `;
        },

        renderMorePage(){
            const loyaltyPoints = app.state.customerProfile?.loyalty_points ?? 0;
            const loyaltyExplanation = `<p class="text-xs text-secondary mt-1">Earn 50 pts (‚Çπ50) per ‚Çπ500 spent. 1 pt = ‚Çπ1 discount (redeem in Cart).</p>`;
            
            // Removed staff call button and generic theme switch
            const options = [
                { icon: "ü™ô", text: `Loyalty Points: ${loyaltyPoints}`, action: "", explanation: loyaltyExplanation },
                { icon: "üé®", text: "Change Brand/Theme", action: "ui.showBrandSwitcherModal()" },
                { icon: "üéÆ", text: "Play Games", action: "ui.showGamesModal()" },
                { icon: "üì∂", text: "View Wi-Fi Details", action: "ui.showWifiModal()" },
                { icon: "üìú", text: "Order History", action: "ui.showOrderHistoryModal()" },
            ];
            $('#page-content').innerHTML = `
                <div class="p-4 space-y-3">
                    ${options.map(opt =>
                        opt.action
                        ? `<button onclick="${opt.action}" class="w-full flex items-center justify-between bg-secondary p-4 rounded-xl text-left">
                               <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                               <span class="text-secondary">&rarr;</span>
                           </button>`
                        : `<div class="w-full bg-secondary p-4 rounded-xl text-left">
                               <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                               ${opt.explanation || ''}
                           </div>`
                    ).join("")}
                </div>`;
        },

        showPaymentModal(){
             ui.showModal('payment-modal', `
                <h2 class="text-xl font-bold text-primary mb-4">Select Payment</h2>
                <div class="space-y-3">
                    <button onclick="app.placeOrder('Pay at Counter', this)" class="payment-btn w-full flex items-center justify-center bg-secondary p-4 rounded-xl"><span class="text-2xl mr-4">üíµ</span><span class="font-semibold">Pay at Counter</span></button>
                </div>
                <button onclick="ui.closeModal('payment-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `);
        },

        showItemDetailModal(itemId){
            const item = app.state.allMenuItems.find(i => i.id === itemId); if (!item) return;
            const cartItem = app.state.cart.find(ci => ci.id === itemId);
            const currentQuantity = cartItem ? cartItem.quantity : 1;
            
            // Check for Gulabi View Mode
            const isGulabiView = document.body.dataset.theme === 'gulabi';
            
            let actionButtonHTML = '';
            let selectHTML = '';
            let optionsHTML = Array.from({ length: 10 }, (_, i) => `<option value="${i + 1}" ${i + 1 === currentQuantity ? 'selected' : ''}>${i + 1}</option>`).join('');
            optionsHTML = `<option value="0" ${!cartItem && !isGulabiView ? 'selected' : ''}>0 (Remove)</option>` + optionsHTML;

            if (isGulabiView) {
                 actionButtonHTML = `<div class="w-full text-center py-3 view-only-btn" style="border: 2px solid var(--brand-primary-pink); color: var(--text-primary-pink);">View Only: Cannot Add to Cart</div>`;
                 selectHTML = `<p class="text-sm text-secondary">Ordering unavailable in this view.</p>`;
            } else {
                 actionButtonHTML = `<button onclick="app.setCartItemQuantity(${item.id}, parseInt($('#modal-quantity-select').value))" class="w-full brand-bg font-semibold py-3 rounded-lg">${cartItem ? 'Update Quantity' : 'Add to Cart'}</button>`;
                 selectHTML = `
                    <label for="modal-quantity-select" class="font-semibold text-primary">Quantity:</label>
                    <select id="modal-quantity-select" class="bg-primary border border-custom text-primary font-semibold rounded-lg p-2">${optionsHTML}</select>
                 `;
            }

            ui.showModal('item-detail-modal', `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-primary">${item.name}</h2>
                        <p class="text-xl font-semibold text-secondary">‚Çπ${item.price}</p>
                    </div>
                    <div class="text-5xl">${item.image_url || 'ü•ò'}</div>
                </div>
                <p class="text-secondary mt-2">${item.description || 'A delicious choice.'}</p>
                
                <div class="flex items-center justify-between my-6 bg-secondary p-3 rounded-lg">
                    ${selectHTML}
                </div>

                <div class="mt-6 grid grid-cols-2 gap-4">
                    <button onclick="ui.closeModal('item-detail-modal')" class="w-full bg-secondary font-semibold py-3 rounded-lg">Back</button>
                    ${actionButtonHTML}
                </div>`);
        },

        showInstagramPromo(){
            const currentBrand = document.body.dataset.theme === 'gulabi' ? '@gulabithali' : '@bulbcafe';
            const promoTitle = 'Post a story tagging us to win a prize!';
            const promoSubtitle = `Tag ${currentBrand} in your story and show it at the counter for a special prize!`;
            
            const vibes = Object.entries(STATIC_DATA.captionIdeas).map(([key, _]) => ({
                name: key, icon: { cafe_vibes: '‚òï', thali_time: 'üçõ', friends: 'üéâ' }[key]
            }));
            ui.showModal('insta-modal', `
                <h2 class="text-2xl font-bold">Post and Win!</h2>
                <p class="text-secondary mt-1 mb-6">${promoSubtitle}</p>
                <div class="grid grid-cols-2 gap-4">${vibes.map(v => `
                    <button onclick="ui.showCaptionIdeas('${v.name}')" class="bg-secondary p-4 rounded-xl text-center">
                        <span class="text-3xl">${v.icon}</span><p class="font-semibold mt-2 capitalize">${v.name.replace('_', ' ')}</p>
                    </button>`).join("")}
                </div>
                <button onclick="ui.closeModal('insta-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `);
        },

        showCaptionIdeas(category){
            ui.closeModal('insta-modal');
            const currentBrand = document.body.dataset.theme === 'gulabi' ? '@gulabithali' : '@bulbcafe';
            const captions = STATIC_DATA.captionIdeas[category]; 

            ui.showModal('caption-modal', `
                <h2 class="text-2xl font-bold">Caption Ideas</h2>
                <p class="text-secondary mt-1 mb-4">Tap to copy. Tag us <span class="font-bold brand-text">${currentBrand}</span>!</p>
                <div class="space-y-2 max-h-48 overflow-y-auto">${captions.map(c => `
                    <div onclick="app.copyCaption('${c.replace(/'/g, "\\'")}')" class="bg-secondary p-3 rounded-lg text-sm font-medium cursor-pointer flex justify-between items-center">
                        <span>${c}</span><span class="text-xs font-bold brand-text">COPY</span>
                    </div>`).join('')}
                </div>
                <a href="https://instagram.com/stories/create" target="_blank" class="block w-full text-center mt-6 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 text-white font-semibold py-3 rounded-lg">Open Instagram Story</a>
                <button onclick="ui.closeModal('caption-modal')" class="w-full mt-2 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },

        showGamesModal() {
            // Simplified games modal for the quick access in 'More'
            ui.showModal('games-modal', `
                <h2 class="text-xl font-bold text-center mb-4">Entertainment</h2>
                <div class="space-y-3">
                    ${Object.values(GAMES).map(game => `
                        <div class="bg-secondary p-4 rounded-xl">
                            <h3 class="text-lg font-bold text-primary mb-1">${game.title}</h3>
                            <p class="text-secondary text-sm mb-3">${game.description}</p>
                            <button onclick="GAMES['${game.id}'].start()" class="brand-bg font-semibold py-2 px-4 rounded-lg text-sm">Play</button>
                        </div>`).join("")}
                </div>
                <button onclick="ui.closeModal('games-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },

        showWifiModal() {
            ui.showModal('wifi-modal', `
                <div class="text-center">
                    <h2 class="text-xl font-bold mb-2">Wi-Fi Network</h2>
                    <p class="text-secondary mb-4">Connect and enjoy!</p>
                    <div class="bg-secondary p-4 rounded-lg">
                        <p class="text-xs">Network Name</p><p class="font-bold text-lg">BULB-GUEST</p>
                        <hr class="border-custom my-3">
                        <p class="text-xs">Password</p><p class="font-bold text-lg">12345678</p>
                    </div>
                    <button onclick="ui.closeModal('wifi-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
                </div>
            `);
        },

        async showOrderHistoryModal() {
            if (!supabase) return ui.showToast("History failed: Supabase not initialized.");
            if (!app.state.customerProfile || !this.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
            // Fetch order history
            const { data } = await supabase.from('orders').select(`*, order_items (products(name), quantity), discount_amount, discount_points_redeemed`).eq('customer_id', app.state.customerProfile.id).order('created_at', { ascending: false });
            
            const historyHTML = data?.length > 0 ? data.map(o => `
                <div class="bg-secondary p-3 rounded-lg">
                    <div class="flex justify-between">
                        <div>
                            <p class="font-bold">Order #${o.id.slice(0, 6)}</p>
                            <p class="text-xs text-secondary">${new Date(o.created_at).toLocaleString()}</p>
                        </div>
                        <p class="font-semibold">‚Çπ${(o.final_amount ?? o.total_amount).toFixed(2)}</p>
                    </div>
                    <div class="text-sm text-secondary mt-2">${o.order_items.length > 0 ? o.order_items.map(i => `${i.products.name} (x${i.quantity})`).join(', ') : 'No items found'}</div>
                    ${o.discount_amount > 0 ? `<p class="text-xs text-green-600 mt-1">Discount: -‚Çπ${o.discount_amount.toFixed(2)} (${o.discount_points_redeemed} points)</p>` : ''}
                </div>`).join('') : '<p class="text-secondary text-center">No past orders found.</p>';

            ui.showModal('history-modal', `
                <h2 class="text-xl font-bold text-center mb-4">Order History</h2>
                <div class="space-y-3 max-h-60 overflow-y-auto">${historyHTML}</div>
                <button onclick="ui.closeModal('history-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        }
    };

    // --- GAMES LOGIC ---
    const GAMES = {
        ticTacToe: {
            id: 'ticTacToe', title: 'Tic-Tac-Toe', description: 'Classic 2-player game for your table.',
            board: Array(9).fill(null),
            currentPlayer: "X",
            winner: null,
            start() {
                this.reset();
                ui.showModal('ttt-modal', `
                    <h2 class="text-2xl font-bold mb-2 text-center">Tic-Tac-Toe</h2>
                    <p id="ttt-status" class="font-semibold text-secondary mb-4 text-center">Player X's turn</p>
                    <div class="w-full max-w-[250px] mx-auto">
                        <div id="ttt-board" class="grid grid-cols-3 gap-2 my-4">
                            ${this.board.map((_, i) => `<div class="aspect-square bg-secondary flex items-center justify-center text-5xl sm:text-6xl font-bold rounded-lg cursor-pointer" onclick="GAMES.ticTacToe.play(${i})"></div>`).join("")}
                        </div>
                    </div>
                    <button onclick="GAMES.ticTacToe.start()" class="w-full mt-2 brand-bg font-semibold py-3 rounded-lg">New Game</button>
                    <button onclick="ui.closeModal('ttt-modal')" class="w-full mt-2 bg-secondary py-3 rounded-lg">Close</button>
                `);
            },
            play(i) {
                if (this.board[i] || this.winner) return;
                this.board[i] = this.currentPlayer;
                this.checkWinner();
                this.currentPlayer = this.currentPlayer === "X" ? "O" : "X";
                this.updateUI();
            },
            checkWinner() {
                const lines = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8],
                    [0, 3, 6], [1, 4, 7], [2, 5, 8],
                    [0, 4, 8], [2, 4, 6]
                ];
                for (let line of lines) {
                    const [a, b, c] = line;
                    if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                        this.winner = this.board[a];
                        sound.play("win");
                        return;
                    }
                }
                if (this.board.every(cell => cell)) {
                    this.winner = "Draw";
                    sound.play("draw");
                }
            },
            updateUI() {
                $$("#ttt-board > div").forEach((cell, i) => {
                    cell.textContent = this.board[i];
                    cell.style.color = this.board[i] === "X" ? "#3b82f6" : "#ef4444";
                });
                $("#ttt-status").textContent = this.winner ? (this.winner === "Draw" ? "It's a Draw!" : `Player ${this.winner} wins!`) : `Player ${this.currentPlayer}'s turn`;
            },
            reset() {
                this.board.fill(null);
                this.currentPlayer = "X";
                this.winner = null;
            }
        },
        coffeeTrivia: {
            id: 'coffeeTrivia', title: 'Food Trivia', description: 'Test your general food knowledge!',
            currentQuestion: null,
            trivia: [
                { q: "What is the primary spice used in Indian Masala Chai?", o: ["Ginger", "Cinnamon", "Cardamom", "Clove"], a: 2 },
                { q: "Which pink city is Gulabi Thali's namesake?", o: ["Udaipur", "Jaipur", "Jodhpur", "Mumbai"], a: 1 },
                { q: "What is the main ingredient in hummus?", o: ["Lentils", "Chickpeas", "Beans", "Peanuts"], a: 1 },
                { q: "What fruit is used to make guacamole?", o: ["Lime", "Tomato", "Avocado", "Chili"], a: 2 }
            ],
            start() {
                this.currentQuestion = this.trivia[Math.floor(Math.random() * this.trivia.length)];
                const item = this.currentQuestion;
                ui.showModal('trivia-modal', `
                    <div class="text-center">
                        <h2 class="text-xl font-bold mb-2">Food Trivia</h2>
                        <p class="text-secondary mb-6 h-12">${item.q}</p>
                        <div id="trivia-options" class="space-y-3">
                            ${item.o.map((opt, index) => `<button class="trivia-option w-full bg-secondary font-semibold p-3 rounded-lg text-left" onclick="GAMES.coffeeTrivia.checkAnswer(${index}, ${item.a})">${opt}</button>`).join('')}
                        </div>
                        <button onclick="ui.closeModal('trivia-modal')" class="w-full mt-6 bg-secondary py-3 rounded-lg">Close</button>
                `);
            },
            checkAnswer(selectedIndex, correctIndex) {
                const options = $$('.trivia-option');
                options.forEach((btn, index) => {
                    btn.disabled = true;
                    if (index === correctIndex) {
                        btn.classList.remove('bg-secondary');
                        btn.classList.add('bg-green-500', 'text-white');
                    } else if (index === selectedIndex) {
                        btn.classList.remove('bg-secondary');
                        btn.classList.add('bg-red-500', 'text-white');
                    }
                });

                if (selectedIndex === correctIndex) {
                    sound.play('success');
                } else {
                    sound.play('draw');
                }

                setTimeout(() => this.start(), 2000);
            }
        },
        coffeeArt: {
            id: 'coffeeArt', title: 'Latte Art Studio', description: 'Unleash your inner barista and create some latte art.',
            canvas: null, ctx: null, painting: false,
            start() {
                ui.showModal('art-modal', `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-2">Latte Art Studio</h2>
                        <div class="relative w-full aspect-square mx-auto my-4 rounded-full bg-[#c4a484] overflow-hidden cursor-crosshair" id="canvas-container">
                            <canvas id="coffee-art-canvas"></canvas>
                        </div>
                        <div class="flex justify-center items-center space-x-2">
                            <button onclick="GAMES.coffeeArt.changeColor('#ffffff')" class="w-8 h-8 rounded-full bg-white border-2 border-custom"></button>
                            <button onclick="GAMES.coffeeArt.changeColor('#5a3825')" class="w-8 h-8 rounded-full bg-[#5a3825] border-2 border-custom"></button>
                            <button onclick="GAMES.coffeeArt.clearCanvas()" class="bg-secondary font-semibold py-1 px-3 rounded-lg text-sm">Clear</button>
                        </div>
                        <button onclick="ui.closeModal('art-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Done</button>
                    </div>`);
                this.initCanvas();
            },
            initCanvas() {
                this.canvas = $("#coffee-art-canvas");
                const container = $('#canvas-container');
                if (!this.canvas || !container) return;
                this.ctx = this.canvas.getContext("2d");
                const size = container.clientWidth;
                this.canvas.width = size;
                this.canvas.height = size;
                this.ctx.strokeStyle = "#ffffff"; this.ctx.lineWidth = 5; this.ctx.lineCap = "round";
                this.canvas.addEventListener("pointerdown", this.startPosition.bind(this));
                this.canvas.addEventListener("pointerup", this.finishedPosition.bind(this));
                this.canvas.addEventListener("pointermove", this.draw.bind(this));
                this.canvas.addEventListener("touchstart", this.startPosition.bind(this), { passive: false });
                this.canvas.addEventListener("touchend", this.finishedPosition.bind(this));
                this.canvas.addEventListener("touchmove", this.draw.bind(this), { passive: false });
            },
            getEventPosition(e) {
                const rect = this.canvas.getBoundingClientRect();
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
                }
                return { x: e.clientX - rect.left, y: e.clientY - rect.top };
            },
            startPosition(e) { this.painting = true; this.draw(e); },
            finishedPosition() { this.painting = false; this.ctx.beginPath(); },
            draw(e) {
                if (!this.painting) return;
                e.preventDefault();
                const { x, y } = this.getEventPosition(e);
                this.ctx.lineTo(x, y); this.ctx.stroke();
                this.ctx.beginPath(); this.ctx.moveTo(x, y);
            },
            changeColor(c) { if(this.ctx) this.ctx.strokeStyle = c; },
            clearCanvas() { if(this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); }
        },
    };
    
    // EXPOSE GLOBAL OBJECTS FOR INLINE HTML HANDLERS (THE FIX)
    window.app = app;
    window.ui = ui;
    window.GAMES = GAMES;

    document.addEventListener('DOMContentLoaded', () => {
        if (supabase) {
            app.init();
        } else {
            console.error("Supabase failed to initialize. App cannot start.");
            // Display an error to the user on the splash screen
            const splash = $('#splash-screen');
            if (splash) {
                splash.innerHTML = `<div class_
="text-red-500 text-center p-4">Could not connect to services. Please check your internet connection and refresh.</div>`;
            }
        }
    });

</script>
</body>
</html>
