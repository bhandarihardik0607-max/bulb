<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 
      Ensuring mobile-first design with viewport settings.
      user-scalable=no prevents accidental zooming on mobile, as requested.
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Updated Title -->
    <title>Gulabi Thali & Bulb Cafe</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts - Using Poppins for modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            /* Theme Variables */
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            
            /* --- REFINED UI/GRADIENTS --- */

            /* Bulb Theme (Warm Yellow/Amber Gradient) */
            --bg-primary-yellow: #FFFDF5;     /* Lighter, creamier base */
            --bg-secondary-yellow: #FEFBEB;   /* Very light yellow for cards */
            --text-primary-yellow: #78350F;   /* Darker amber for text */
            --text-secondary-yellow: #B45309; /* Richer amber */
            --border-yellow: #FDE68A;       /* Soft yellow border */
            --brand-primary-yellow-start: #F59E0B; /* Amber */
            --brand-primary-yellow-end: #FBBF24;   /* Yellow */

            /* Gulabi Theme (Softer Pink "Gulabi" Gradient) */
            --bg-primary-pink: #FFF5F7;     /* Very light pink base */
            --bg-secondary-pink: #FDF2F8;   /* Slightly richer pink for cards */
            --text-primary-pink: #831843;   /* Deep magenta text */
            --text-secondary-pink: #BE185D; /* Strong pink */
            --border-pink: #FBCFE8;       /* Soft pink border */
            --brand-primary-pink-start: #EC4899; /* Pink */
            --brand-primary-pink-end: #DB2777;   /* Deeper pink */

            /* --- END REFINEMENTS --- */

            --app-height: 100vh;
        }
        
        /* Theme Selection */
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); --brand-gradient-start: var(--brand-primary-light); --brand-gradient-end: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); --brand-gradient-start: var(--brand-primary-dark); --brand-gradient-end: var(--brand-primary-dark); }
        
        [data-theme="bulb"] { 
            --bg-primary: var(--bg-primary-yellow); --bg-secondary: var(--bg-secondary-yellow); --text-primary: var(--text-primary-yellow); --text-secondary: var(--text-secondary-yellow); --border-color: var(--border-yellow); 
            --brand-primary: var(--brand-primary-yellow-end); /* Fallback color */
            --brand-gradient-start: var(--brand-primary-yellow-start); 
            --brand-gradient-end: var(--brand-primary-yellow-end);
        }
        [data-theme="gulabi"] { 
            --bg-primary: var(--bg-primary-pink); --bg-secondary: var(--bg-secondary-pink); --text-primary: var(--text-primary-pink); --text-secondary: var(--text-secondary-pink); --border-color: var(--border-pink); 
            --brand-primary: var(--brand-primary-pink-end); /* Fallback color */
            --brand-gradient-start: var(--brand-primary-pink-start); 
            --brand-gradient-end: var(--brand-primary-pink-end);
        }

        /* Base & Utility Styles */
        html, body { 
            height: 100%; 
            overflow: hidden; /* Prevents outer page scroll */
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #000000; /* Outer background for desktop view */
            color: var(--text-primary); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.5s ease; 
        }
        /* Main container for the mobile app view */
        .app-container { 
            background-color: var(--bg-primary); 
            transition: background-color 0.5s ease; 
            height: var(--app-height); /* Full viewport height */
            display: flex;
            flex-direction: column;
        }
        /* Main content area, scrolls independently */
        .app-container > main {
            flex-grow: 1;
            overflow-y: auto; /* Allows content to scroll */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } 
        
        /* Gradient Styles */
        .brand-text {
            /* Applying gradient from end to start for a better visual */
            background-image: linear-gradient(to right, var(--brand-gradient-end), var(--brand-gradient-start));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .brand-bg {
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end));
            color: white; /* Gradients look best with white text */
            transition: all 0.3s ease;
        }
        .brand-bg:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .brand-border {
            border-color: var(--brand-primary);
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; } @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #splash-screen .brand-logo { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        /* Brand Selection Screen Styles */
        #brand-selection-screen { animation: fadeIn 0.3s ease; }
        .brand-card {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
        }
        .brand-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .brand-card img {
             object-position: center 20%;
        }

        /* Custom UI Elements */
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .horizontal-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .spinner {
            border: 2px solid var(--bg-primary);
            border-top: 2px solid var(--brand-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Order Tracker */
        .tracker-line-container { background-color: var(--border-color); }
        .tracker-progress { 
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end)); 
        }
        .tracker-icon-container { background-color: var(--bg-primary); border: 2px solid var(--border-color); }
        .tracker-step.active .tracker-icon-container { 
            border-color: var(--brand-primary); 
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end));
            color: white; 
            transform: scale(1.1); 
        }
        .tracker-step.active .tracker-label { color: var(--brand-primary); }

        /* --- REFINED UI: Menu/Cart Controls --- */
        .add-to-cart-btn { 
            width: 38px; height: 38px; /* Slightly smaller */
            border-radius: 50%; 
            background-color: var(--bg-primary); 
            color: var(--brand-primary); 
            border: 2px solid var(--border-color); 
            font-size: 22px; font-weight: 600; line-height: 1; 
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .add-to-cart-btn:hover { 
            transform: scale(1.1); 
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end));
            color: white; 
            border-color: transparent; 
        }
        .quantity-control { 
            display: flex; align-items: center; justify-content: space-between; 
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary); 
            border-radius: 9999px; font-weight: 600; 
            overflow: hidden; width: 100px; height: 38px; user-select: none; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .quantity-control button { 
            width: 34px; height: 100%; font-size: 20px; line-height: 1; 
            transition: background-color 0.2s ease;
            color: var(--brand-primary);
            font-weight: 700;
        }
        .quantity-control button:hover { background-color: var(--bg-secondary); }
        .quantity-control span { font-size: 16px; }
        
        /* Special style for cart page quantity control */
        .cart-quantity-control {
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end));
            border: none;
            color: white;
        }
        .cart-quantity-control button {
            color: white;
        }
        .cart-quantity-control button:hover {
            background-color: rgba(0,0,0,0.1);
        }
        /* --- END REFINEMENTS --- */
        
        /* View-only item style for Gulabi Thali */
        .menu-item-view-only {
            background-color: var(--bg-secondary);
            border-radius: 0.75rem; /* 12px */
            padding: 0.75rem; /* 12px */
            border: 1px solid var(--border-color);
        }

        /* Loyalty Slider */
        #loyalty-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 4px; }
        #loyalty-slider:hover { opacity: 1; }
        #loyalty-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none; 
            width: 20px; height: 20px; 
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end));
            cursor: pointer; border-radius: 50%; 
        }
        #loyalty-slider::-moz-range-thumb { 
            width: 20px; height: 20px; 
            background-image: linear-gradient(to right, var(--brand-gradient-start), var(--brand-gradient-end));
            cursor: pointer; border-radius: 50%; border: none; 
        }

        /* Social Card Gradient */
        .social-card-gradient {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Gulabi Thali specific gradient */
        [data-theme="gulabi"] .social-card-gradient {
             background: radial-gradient(circle at 30% 107%, #FCD34D 0%, #F59E0B 45%, #DB2777 60%, #E94C8F 90%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Slideshow Styles */
        .slideshow-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .slideshow-track { display: flex; transition: transform 0.5s ease-in-out; }
        .slide { flex: 0 0 100%; width: 100%; position: relative; }
        .slide-content { width: 100%; height: 100%; display: block; object-fit: cover; }
        .slide-video { width: 100%; height: 100%; object-fit: cover; }
        .slide-text { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 20%, transparent); display: flex; flex-direction: column; justify-content: flex-end; padding: 1rem; color: white; text-align: center; }
        .slideshow-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; font-weight: bold; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .slideshow-btn:hover { background-color: rgba(0, 0, 0, 0.8); }
        .slideshow-btn.prev { left: 10px; }
        .slideshow-btn.next { right: 10px; }
        .slideshow-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s ease; }
        .dot.active { background-color: white; }
        .rotate-180 { transform: rotate(180deg); }

    </style>
</head>
<body data-theme="light"> <!-- Default, will be overwritten -->

    <!-- 
      Brand Selection Screen 
      This is shown *after* auth/onboarding, OR if a QR code is scanned.
      FIX: Made cards smaller and side-by-side
    -->
    <div id="brand-selection-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[200] p-4 hidden">
        <h1 class="text-3xl font-bold text-white mb-4">Welcome</h1>
        <h2 class="text-xl text-gray-300 mb-8 text-center">Please select a location</h2>
        
        <!-- FIX: Changed max-w-lg to max-w-sm, grid-cols-1 to grid-cols-2, gap-8 to gap-4 -->
        <div class="w-full max-w-sm mx-auto grid grid-cols-2 gap-4">
            <!-- Bulb Cafe Card -->
            <div class="brand-card" onclick="selectBrand('bulb')">
                <div class="relative rounded-2xl shadow-2xl overflow-hidden aspect-w-3 aspect-h-4">
                    <img src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/429351096_763581305304798_8823152985320369357_n.jpg"
                         alt="Bulb Cafe Interior"
                         class="w-full h-full object-cover"
                         onerror="this.onerror=null; this.src='https://placehold.co/600x800/F59E0B/92400E?text=Bulb+Cafe';">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>
                    <!-- FIX: Changed text-3xl to text-2xl, p-6 to p-4 -->
                    <div class="absolute bottom-0 left-0 p-4">
                        <h3 class="text-2xl font-extrabold text-white">BULB CAFE</h3>
                        <p class="text-yellow-300 font-semibold text-sm">Jaipur</p>
                    </div>
                </div>
            </div>

            <!-- Gulabi Thali Card -->
            <div class="brand-card" onclick="selectBrand('gulabi')">
                <div class="relative rounded-2xl shadow-2xl overflow-hidden aspect-w-3 aspect-h-4">
                    <!-- FIX: Corrected 'httpshttps' to 'https' -->
                    <img src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/403946165_1014623216287649_4686052002313628516_n%20(1).jpg"
                         alt="Gulabi Thali Food"
                         class="w-full h-full object-cover"
                         onerror="this.onerror=null; this.src='https://placehold.co/600x800/DB2777/9D174D?text=Gulabi+Thali';">
                    
                     <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>
                     <!-- FIX: Changed text-3xl to text-2xl, p-6 to p-4 -->
                     <div class="absolute bottom-0 left-0 p-4">
                        <h3 class="text-2xl font-extrabold text-white">GULABI THALI</h3>
                        <p class="text-pink-300 font-semibold text-sm">Cloud Kitchen</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 
      Splash Screen 
      Shown *after* brand selection, themed appropriately.
    -->
    <div id="splash-screen" class="fixed inset-0 bg-primary flex flex-col items-center justify-center z-[100] hidden">
        <div class="brand-logo text-7xl mb-4"></div> <!-- Content set by JS -->
        <h1 class="text-3xl font-bold brand-text"></h1> <!-- Content set by JS -->
    </div>

    <!-- 
      Main App Container
      This is the mobile-sized container.
    -->
    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl hidden">
        <main>
            <div id="main-interface" class="hidden h-full flex flex-col">
                <!-- Page Header (Sticky) -->
                <header id="page-header" class="sticky top-0 bg-primary/80 backdrop-blur-sm z-20 h-16 px-4 flex-shrink-0 flex justify-between items-center border-b border-custom"></header>
                
                <!-- Page Content Area (Scrollable) -->
                <div id="page-content" class="flex-grow overflow-y-auto"></div>

                <!-- Footer Spacer for Bottom Nav -->
                <div id="footer-spacer" class="h-16 flex-shrink-0"></div>
            </div>
        </main>
        
        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary/80 backdrop-blur-sm border-t border-custom flex justify-around items-center h-16 z-30 hidden"></nav>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed right-4 py-3 px-5 rounded-lg shadow-xl z-50 transition-all duration-300 brand-bg font-semibold" style="bottom: 80px;">
        <p id="toast-message"></p>
    </div>

<!-- Load Supabase as a standard script before the module script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
    
    // Accessing createClient from the global window.supabase object.
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // Sets CSS variable for 100vh to fix mobile browser UI bars
    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    }
    window.addEventListener('resize', setAppHeight);
    setAppHeight();

    // --- SUPABASE CONFIG ---
    // This is using the public anon key, which is secure.
    // Row Level Security (RLS) policies on your Supabase dashboard
    // are responsible for protecting your data.
    const SUPABASE_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydmx2dmxmemJkcXdmc2Rscmt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NzI2NzAsImV4cCI6MjA3NzU0ODY3MH0.yYnxeipLuO0DlTvGITI5ajHDeoWZ80N2PS3rPhuOyp8';
    
    const createClient = window.supabase ? window.supabase.createClient : null;
    let supabase = null;
    
    if (createClient) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("CRITICAL: Supabase client library not found.");
        // Fallback to show an error on the screen if Supabase fails to load
        document.addEventListener('DOMContentLoaded', () => {
             const brandScreen = $('#brand-selection-screen');
             if (brandScreen) {
                 brandScreen.innerHTML = `<div class="text-white text-center p-4">Error loading data components. Check Console.</div>`;
                 brandScreen.classList.remove('hidden');
             }
        });
    }

    // --- APP STATE & CONFIG ---
    
    // Defines the pages available in the bottom nav for Bulb Cafe
    const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'more'];
    
    // --- SOUND EFFECTS ---
    // Simple sound engine for UI feedback
    const sound = {
        audioContext: null,
        init() {
            if (this.audioContext) return;
            try { this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
            catch (e) { console.error("Web Audio API is not supported."); }
        },
        play(type) {
            if (!this.audioContext) return;
            const o = this.audioContext.createOscillator(), g = this.audioContext.createGain();
            o.connect(g); g.connect(this.audioContext.destination); g.gain.setValueAtTime(0, this.audioContext.currentTime);
            // Predefined sound profiles
            const sounds = {
                click: { type: 'sine', freq: 900, gain: 0.1, len: 0.05 },
                add_to_cart: { type: 'sine', freq: 700, gain: 0.2, len: 0.15 },
                success: { type: 'sine', freq: 523, gain: 0.3, len: 0.2, secondFreq: 659 },
                win: { type: 'sine', freq: 587, gain: 0.4, len: 0.3, secondFreq: 880 },
                draw: { type: 'sawtooth', freq: 220, gain: 0.1, len: 0.1 },
            };
            const s = sounds[type]; if (!s) return;
            o.type = s.type; o.frequency.setValueAtTime(s.freq, this.audioContext.currentTime);
            g.gain.linearRampToValueAtTime(s.gain, this.audioContext.currentTime + 0.01);
            if (s.secondFreq) { o.frequency.setValueAtTime(s.secondFreq, this.audioContext.currentTime + (s.len / 2)); }
            g.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + s.len);
            o.start(this.audioContext.currentTime); o.stop(this.audioContext.currentTime + s.len);
        }
    };


    // --- MAIN APP LOGIC ---
    const app = {
        state: {
            currentPage: 'home',
            cart: [],
            activeOrder: null,
            tableNumber: null, // Set by earlyInit if present in URL
            user: null,
            customerProfile: null,
            theme: 'bulb', // Default, will be overwritten
            menuData: [], // Grouped menu for accordion
            allMenuItems: [], // Flat list of all items for search
            appSettings: {},
            orderSubscription: null,
            searchQuery: '',
            searchResults: [],
            pointsToRedeem: 0,
            isGulabiOrderingEnabled: false, // This is the key toggle
        },

        /**
         * earlyInit()
         * Runs on page load. Handles auth and profile fetching *before* brand selection.
         */
        async earlyInit() {
            document.body.addEventListener('click', () => sound.init(), { once: true });
            if (!supabase) {
                console.error("Supabase failed to initialize. Cannot start app.");
                return; 
            }

            // 1. Get table number from URL (if any)
            this.getTableNumberFromURL();

            try {
                // 2. ANONYMOUS SIGN-IN (or get existing session)
                // This ensures every user has a stable ID, even without an account.
                let session = null;
                try {
                    const { data } = await supabase.auth.getSession();
                    session = data.session;
                } catch(e) { console.error("Session check failed:", e); }
                
                this.state.user = session?.user;
                if (!this.state.user) {
                    const { data: signInData, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                        console.error("Anonymous sign-in failed:", error);
                        throw new Error(`Auth failed: ${error.message}`);
                    }
                    this.state.user = signInData.user;
                }
                console.log("User session established:", this.state.user.id);

                // 3. FETCH OR CREATE CUSTOMER PROFILE
                await this.fetchCustomerProfile();
                
                // 4. Handle next step based on profile (onboarding or brand selection)
                this.handleProfileLoaded();

            } catch (error) {
                console.error("CRITICAL: App Initialization failed.", error);
                // Show error on the brand selection screen as a fallback
                const brandScreen = $('#brand-selection-screen');
                brandScreen.innerHTML = `<div class="text-white text-center p-4">Could not load app: ${error.message}</div>`;
                brandScreen.classList.remove('hidden');
            }
        },
        
        /**
         * handleProfileLoaded()
         * Decides whether to show onboarding (for details) or brand selection.
         * This fulfills the request: "first let me fill details and then ask brand"
         */
        handleProfileLoaded() {
            if (!this.state.customerProfile || this.state.customerProfile.name === 'Guest' || !this.state.customerProfile.whatsapp_number) {
                // New user or guest, needs to provide details first.
                console.log("Showing universal onboarding...");
                this.showUniversalOnboardingModal(); 
            } else {
                // Returning user, details are present. Proceed to brand selection.
                console.log("User already onboarded. Checking brand selection.");
                // Pass 'false' as we are not forcing, just checking
                ui.showBrandSelection(false); 
            }
        },
        
        /**
         * init()
         * This function is called *after* a brand is selected.
         * It handles fetching data and showing the main app.
         */
        async init() {
            // Apply theme first to style splash screen
            this.applyTheme();
            
            // Update splash screen to match selected theme
            const splashLogo = $('#splash-screen .brand-logo');
            const splashTitle = $('#splash-screen .text-3xl');
            if (this.state.theme === 'gulabi') {
                splashLogo.innerHTML = 'ðŸŒ¸';
                splashTitle.innerHTML = 'GULABI THALI';
            } else {
                splashLogo.innerHTML = 'ðŸ’¡';
                splashTitle.innerHTML = 'BULB CAFE';
            }
            $('#splash-screen').classList.remove('hidden');

            // Set up page navigation
            const initialHash = location.hash.substring(1);
            if (PAGES.includes(initialHash)) {
                 this.state.currentPage = initialHash;
            } else {
                 this.state.currentPage = 'home';
                 location.hash = 'home';
            }
            window.addEventListener('popstate', this.handleHardwareBack.bind(this));

            // Fetch data and start the app flow
            try {
                // Fetch menu and settings (which includes the Gulabi toggle)
                await Promise.all([ this.fetchMenuData(), this.fetchAppSettings() ]);
                this.startAppFlow();
            } catch (error) {
                 console.error("CRITICAL: Data fetching failed.", error);
                $('#splash-screen').innerHTML = `<div class="text-primary text-center p-4">Could not load app data: ${error.message}</div>`;
            }
        },

        /**
         * startAppFlow()
         * This is now just the final step to show the app after data is loaded.
         */
        startAppFlow() {
            // Short splash screen fade
            setTimeout(() => {
                $('#splash-screen').classList.add('fade-out');
                setTimeout(() => {
                    $('#splash-screen').style.display = 'none';
                }, 500);
            }, 1000); // Show splash for 1 second

            $('#app').classList.remove('hidden');
            $('#app').classList.add('flex');
            
            // This call now correctly follows brand selection and data loading
            this.continueAppFlowAfterOnboarding(); 
        },
        
        /**
         * continueAppFlowAfterOnboarding()
         * Logic is unchanged, but its position in the flow is different.
         * It now runs *after* brand is selected and data is loaded.
         */
        continueAppFlowAfterOnboarding() {
            if (this.state.theme === 'gulabi') {
                // Cloud kitchen view: No table number needed.
                // The page render logic will handle view-only vs. orderable.
                this.showMainInterface();
            } else {
                // Bulb Cafe view: Check for table number.
                if (this.state.tableNumber) {
                    // Table number came from QR scan, start session
                    this.startSession();
                } else {
                    // No table number, ask for it
                    this.showTableNumberModal();
                }
            }
        },

        /**
         * getTableNumberFromURL()
         * Unchanged logic, but now called during earlyInit.
         */
        getTableNumberFromURL() {
            const params = new URLSearchParams(window.location.search);
            const tableNum = params.get('table');
            if (tableNum && !isNaN(parseInt(tableNum))) {
                this.state.tableNumber = parseInt(tableNum);
                console.log(`Table number ${this.state.tableNumber} found in URL.`);
            }
        },

        /**
         * fetchCustomerProfile()
         * Unchanged logic, but now called during earlyInit.
         */
        async fetchCustomerProfile() {
            if (!this.state.user) return;
            const userId = this.state.user.id;
            console.log("Fetching profile for user ID:", userId);

            try {
                // We also fetch loyalty_points, which is a view
                const { data, error } = await supabase.from('customers')
                    .select('*, loyalty_points')
                    .eq('id', userId)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // No profile found, create a new one
                    console.log("No profile found, creating new 'Guest' profile.");
                    return this.createUserProfile(userId);
                }
                
                if (error) throw error;
                
                if (data) {
                    console.log("Profile found:", data);
                    data.loyalty_points = data.loyalty_points || 0;
                    this.state.customerProfile = data;
                    return data;
                }
                
                // Fallback in case data is null
                return this.createUserProfile(userId);

            } catch (error) {
                console.error('Error fetching/creating profile:', error.message);
                ui.showToast('Could not load user profile.');
                // Create a temporary profile object to prevent app from crashing
                this.state.customerProfile = { id: userId, name: 'Guest', loyalty_points: 0, whatsapp_number: null };
            }
        },
        
        /**
         * createUserProfile()
         * Creates a new 'Guest' profile for the new anonymous user.
         */
        async createUserProfile(userId) {
            try {
                const newProfile = { id: userId, name: 'Guest', loyalty_points: 0, whatsapp_number: null };
                const { data, error } = await supabase
                    .from('customers')
                    .insert(newProfile)
                    .select('*, loyalty_points')
                    .single();
                
                if (error) throw error;
                
                data.loyalty_points = data.loyalty_points || 0;
                this.state.customerProfile = data;
                console.log("New guest profile created:", data);
                return data;
                
            } catch (error) {
                // This handles a "race condition" where two requests might try to create
                // the profile at the same time. If it already exists, we just fetch it.
                if (error.code === '23505') { 
                    console.warn("Race condition: Profile already exists. Fetching.");
                    return this.fetchCustomerProfile();
                }
                console.error("Error creating profile:", error.message);
                throw new Error(`Profile creation failed: ${error.message}`);
            }
        },

        /**
         * fetchMenuData()
         * Unchanged logic, but called from app.init().
         */
        async fetchMenuData() {
            try {
                // Fetch all products
                const { data, error } = await supabase.from('products').select('*').order('id');
                if (error) throw error;

                // Store *all* available items for searching
                this.state.allMenuItems = data.filter(i => i.is_available);

                // Create grouped menu (legacy, still used by accordion)
                const groupedMenu = data.reduce((acc, item) => {
                    if (!item.is_available) return acc;
                    const categoryName = item.category || 'Uncategorized';
                    let category = acc.find(c => c.category === categoryName);
                    if (!category) {
                        category = { category: categoryName, items: [] };
                        acc.push(category);
                    }
                    category.items.push(item);
                    return acc;
                }, []);

                this.state.menuData = groupedMenu;

            } catch (error) {
                console.error('Error fetching menu data:', error);
                ui.showToast('Could not load the menu: ' + error.message);
            }
        },

        /**
         * fetchAppSettings()
         * This is key for the "Gulabi Thali Toggle" request.
         * It fetches the 'gulabi_thali_ordering_enabled' setting from the admin panel.
         */
        async fetchAppSettings() {
            try {
                const { data, error } = await supabase.from('app_settings').select('key, value');
                if (error) throw error;
                this.state.appSettings = data.reduce((acc, { key, value }) => ({ ...acc, [key]: value }), {});
                
                // This is the toggle from your admin panel
                // It checks if the value is the string 'true'
                this.state.isGulabiOrderingEnabled = this.state.appSettings?.gulabi_thali_ordering_enabled === 'true' || false;
                
                console.log(`Gulabi Thali Ordering Enabled: ${this.state.isGulabiOrderingEnabled}`);
            } catch (error) { console.error('Error fetching app settings:', error); }
        },

        /**
         * showUniversalOnboardingModal()
         * Shows the modal to collect user Name and Phone Number.
         */
        showUniversalOnboardingModal(){
            const currentName = this.state.customerProfile?.name === 'Guest' ? '' : this.state.customerProfile?.name;
            const currentPhone = this.state.customerProfile?.whatsapp_number || '';

            ui.showModal('universal-onboarding-modal', `
                <h2 class="text-2xl font-bold text-primary mb-2">Welcome!</h2>
                <p class="text-secondary mb-6">Please provide your details once for loyalty points and easier checkout.</p>
                <div class="space-y-4">
                    <input type="text" id="universal-user-name-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Name" required value="${currentName || ''}">
                    <input type="tel" id="universal-mobile-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Mobile Number (for Loyalty Points)" required value="${currentPhone || ''}">
                </div>
                <button onclick="app.completeUniversalOnboarding()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg text-white">Save & Continue</button>
            `);
        },

        /**
         * completeUniversalOnboarding()
         * Saves the user's details and proceeds to brand selection.
         */
        async completeUniversalOnboarding(){
            const name = $('#universal-user-name-input').value.trim();
            const phone = $('#universal-mobile-number-input').value.trim();

            if (!name) return ui.showToast("Please enter your name.");
            if (!phone || !/^\d{10}$/.test(phone.replace(/\D/g,''))) return ui.showToast("Please enter a valid 10-digit mobile number.");
            const cleanPhone = phone.replace(/\D/g,'');

            try {
                const { data: updatedProfile, error } = await supabase
                    .from('customers')
                    .update({ name: name, whatsapp_number: cleanPhone })
                    .eq('id', this.state.user.id)
                    .select('*, loyalty_points')
                    .single();

                if (error) {
                    // Handle unique constraint violation (phone already exists)
                    if (error.code === '23505') {
                        ui.showToast('This phone number is already linked to another account.');
                        return;
                    }
                    throw error;
                }
                
                updatedProfile.loyalty_points = updatedProfile.loyalty_points || 0;
                this.state.customerProfile = updatedProfile;
                console.log("Universal onboarding complete, profile updated:", updatedProfile);
                
                ui.closeModal('universal-onboarding-modal');

                // MODIFIED: Now, force the brand selection screen to show
                // This fulfills the "details FIRST, then brand" request.
                ui.showBrandSelection(true); // 'true' forces it to show

            } catch (error) {
                console.error("Universal Onboarding Update Error:", error);
                ui.showToast(`Could not save profile: ${error.message}`);
            }
        },

        /**
         * showTableNumberModal()
         * Asks for table number (Bulb Cafe only).
         */
        showTableNumberModal() {
            ui.showModal('table-number-modal', `
                <h2 class="text-2xl font-bold text-primary mb-2">Welcome back, ${this.state.customerProfile.name}!</h2>
                <p class="text-secondary mb-6">Please enter your table number for today's visit.</p>
                <input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>
                <button onclick="app.completeTableNumberEntry()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg text-white">Continue</button>
            `);
        },

        /**
         * completeTableNumberEntry()
         * Saves table number and starts the main app.
         */
        completeTableNumberEntry() {
            const tableNumber = $('#table-number-input').value;
            if (!tableNumber) return ui.showToast("Please enter your table number.");
            this.state.tableNumber = parseInt(tableNumber);
            this.startSession();
            ui.closeModal('table-number-modal');
            this.navigateTo('home', false);
        },
        
        /**
         * startSession()
         * Fetches active order (if any) and shows the main UI.
         */
        async startSession() {
            if (this.state.theme === 'bulb') {
                await this.fetchActiveOrder();
            }
            this.showMainInterface();
        },

        /**
         * showMainInterface()
         * Renders the main app UI (header, nav, content).
         */
        showMainInterface(){
            $('#main-interface').classList.remove('hidden');
            
            // Only show bottom nav for Bulb Cafe
            if (this.state.theme === 'bulb') {
                $('#bottom-nav').classList.remove('hidden');
                $('#footer-spacer').classList.remove('hidden');
                ui.renderBottomNav();
                ui.updateActiveNav(this.state.currentPage);
            } else {
                // Hide nav for Gulabi Thali
                $('#bottom-nav').classList.add('hidden');
                $('#footer-spacer').classList.add('hidden');
            }
            
            this.navigateTo(this.state.currentPage, false);
        },
        
        /**
         * navigateTo()
         * Handles all page navigation within the app.
         */
        navigateTo(page, pushToHistory = true){
             if (!this.state.customerProfile) return;
             sound.play('click');
             
             // Prevent navigating to non-existent pages
             if (this.state.theme === 'gulabi' && !['home', 'order', 'cart'].includes(page)) {
                 page = 'home';
             }
             
             const currentHash = location.hash.substring(1);
             if (currentHash === page && pushToHistory) return;
             if (pushToHistory) { location.hash = page; } 
             else if (currentHash !== page) { history.replaceState(null, '', '#' + page); }
             
             this.state.currentPage = page;
             ui.renderHeader(page);
             ui.renderPageContent(page);
             
             if (this.state.theme === 'bulb') {
                ui.updateActiveNav(page);
             }
        },
        
        /**
         * handleHardwareBack()
         * Manages the browser's back button behavior.
         */
        handleHardwareBack(event) {
             const currentHash = location.hash.substring(1);
             const openModal = $('#modal-container').children[0];

             if (openModal) {
                 // Don't allow backing out of critical modals
                 if (openModal.id === 'universal-onboarding-modal' || openModal.id === 'table-number-modal') {
                     event.preventDefault(); return;
                 }
                ui.closeModal(openModal.id);
                event.preventDefault();
                history.replaceState(null, '', '#' + this.state.currentPage);
                return;
             }
             
             // Don't allow back navigation in Gulabi theme (it's a single-flow app)
             if (this.state.theme === 'gulabi') {
                 event.preventDefault(); return;
             }
             
             // For Bulb Cafe, navigate to 'home' if not already there
             if (this.state.currentPage === 'home') { return; }

             if (PAGES.includes(currentHash) && currentHash !== this.state.currentPage) {
                 this.navigateTo(currentHash, false);
                 event.preventDefault();
             }
             else if (this.state.currentPage !== 'home') {
                 event.preventDefault(); 
                 this.navigateTo('home');
             }
        },

        applyTheme(){ document.body.dataset.theme = this.state.theme; },

        /**
         * switchBrand()
         * Reloads the app to restart the brand selection flow.
         */
        async switchBrand() {
            localStorage.removeItem('brand-theme');
            location.reload(); // Reloads the page, triggering earlyInit()
        },

        // Handles the logic from the new brand switcher modal
        handleBrandSwitchFromModal(brand) {
            ui.closeModal('brand-switcher-modal');
            if (this.state.theme === brand) {
                // Same brand, do nothing.
                return;
            } else {
                // Different brand, trigger reload flow.
                this.switchBrand();
            }
        },


        /**
         * addOrUpdateCart()
         * Adds/removes items from cart.
         * *** KEY LOGIC ***
         * This function checks the 'isGulabiOrderingEnabled' flag.
         */
        addOrUpdateCart(itemId, quantityChange) {
            const item = this.state.allMenuItems.find(i => i.id === itemId);
            
            // *** This check handles the "Gulabi Thali orderable" request ***
            if (item && item.brand?.toLowerCase() === 'gulabi thali' && !this.state.isGulabiOrderingEnabled) {
                return ui.showToast("Gulabi Thali is view-only at the moment.", 'error');
            }

            sound.play('click');
            if (!item) return;

            let cartItem = this.state.cart.find(i => i.id === itemId);
            let newQuantity = (cartItem ? cartItem.quantity : 0) + quantityChange;

            if (newQuantity <= 0) {
                // Remove from cart
                this.state.cart = this.state.cart.filter(i => i.id !== itemId);
            } else {
                // Add or update in cart
                if (cartItem) {
                    cartItem.quantity = newQuantity;
                } else {
                    this.state.cart.push({ cartId: Date.now(), ...item, quantity: newQuantity });
                }
                if (quantityChange > 0) sound.play('add_to_cart');
            }
            this.state.pointsToRedeem = 0; // Reset discount on cart change
            this.refreshPage();
        },

        /**
         * setCartItemQuantity()
         * Sets a specific quantity from the item detail modal.
         */
        setCartItemQuantity(itemId, quantity) {
            const item = this.state.allMenuItems.find(i => i.id === itemId);
            
            // *** This check also handles the "Gulabi Thali orderable" request ***
            if (item && item.brand?.toLowerCase() === 'gulabi thali' && quantity > 0 && !this.state.isGulabiOrderingEnabled) {
                 ui.closeModal('item-detail-modal');
                 return ui.showToast("Gulabi Thali is view-only at the moment.", 'error');
            }

            if (!item) return;

            if (quantity <= 0) {
                this.state.cart = this.state.cart.filter(i => i.id !== itemId);
            } else {
                let cartItem = this.state.cart.find(i => i.id === itemId);
                if (cartItem) {
                    cartItem.quantity = quantity;
                } else {
                    this.state.cart.push({ cartId: Date.now(), ...item, quantity: quantity });
                }
            }
            if(quantity > 0) {
                sound.play('add_to_cart');
                ui.showToast('Cart updated!');
            }
            this.state.pointsToRedeem = 0; // Reset discount
            ui.closeModal('item-detail-modal');
            this.refreshPage();
        },
        
        /**
         * performSearch()
         * Filters menu items based on user input.
         */
        performSearch(query) {
             const searchContainer = $('#search-results-container');
             const menuContainer = $('#menu-items');
             const activeBrand = this.state.theme === 'bulb' ? 'Bulb Cafe' : 'Gulabi Thali';
             this.state.searchQuery = query.toLowerCase().trim();

             if (this.state.searchQuery.length > 1) {
                if (searchContainer) searchContainer.classList.remove('hidden');
                if (menuContainer) menuContainer.classList.add('hidden');
                
                // Filter items from the active brand
                this.state.searchResults = this.state.allMenuItems.filter(item => {
                    const itemBrand = item.brand?.toLowerCase();
                    if (itemBrand !== activeBrand.toLowerCase()) return false;
                    
                    const itemName = item.name?.toLowerCase() || '';
                    const itemDesc = item.description?.toLowerCase() || '';
                    return itemName.includes(this.state.searchQuery) || itemDesc.includes(this.state.searchQuery);
                });
                ui.renderMenuItems(this.state.searchResults, 'search-results-container');
             } else {
                // Show full menu if search is cleared
                if (searchContainer) searchContainer.classList.add('hidden');
                if (searchContainer) searchContainer.innerHTML = '';
                if (menuContainer) menuContainer.classList.remove('hidden');
                this.state.searchResults = [];
             }
        },
        
        /**
         * calculateCartTotal()
         * Calculates subtotal, discounts, GST, and final total.
         */
        calculateCartTotal(){
            const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
            const availablePoints = this.state.customerProfile?.loyalty_points || 0;
            const loyaltyThreshold = parseFloat(this.state.appSettings.loyalty_threshold || 350);
            
            // Can redeem max 70% of points, up to the subtotal amount
            const maxRedeemablePoints = Math.floor(availablePoints * 0.70);
            const maxRedeemableForOrder = Math.min(maxRedeemablePoints, Math.floor(subtotal));

            let actualPointsToRedeem = 0;
            if (this.state.pointsToRedeem > 0) {
                 actualPointsToRedeem = Math.min(this.state.pointsToRedeem, maxRedeemableForOrder);
            }
            const discountAmount = actualPointsToRedeem;

            // Correct slider if value is invalid
            if (this.state.pointsToRedeem !== actualPointsToRedeem) {
                this.state.pointsToRedeem = actualPointsToRedeem;
            }
            
            const discountedSubtotal = subtotal - discountAmount;
            const gst = discountedSubtotal * 0.05; // 5% GST
            const finalTotal = discountedSubtotal + gst;
            
            // Calculate points to be earned
            let pointsToEarn = 0;
            if (subtotal >= loyaltyThreshold) {
                pointsToEarn = Math.floor(subtotal * 0.10);
            }

            return { subtotal, discountAmount, discountedSubtotal, gst, finalTotal: Math.max(0, finalTotal), maxRedeemableForOrder, pointsToEarn, loyaltyThreshold };
        },

        updatePointsToRedeem(points) {
            this.state.pointsToRedeem = parseInt(points);
            ui.updateCartSummary();
        },

        refreshPage(){
            this.applyTheme();
            ui.refreshCartDependentUI();
            if (PAGES.includes(this.state.currentPage) || ['home', 'order', 'cart'].includes(this.state.currentPage)) {
                ui.renderPageContent(this.state.currentPage);
            }
        },

        /**
         * placeOrder()
         * Submits the cart to the 'orders' table in Supabase.
         * *** KEY LOGIC ***
         * This function handles both Bulb Cafe and Gulabi Thali orders.
         */
        async placeOrder(paymentMethod, btnElement){
            if (!supabase) return ui.showToast("Order failed: Supabase not initialized.");
            
            // *** 1. Determine order type ***
            const isGulabiOrder = app.state.theme === 'gulabi';
            // Gulabi orders are assigned to table 0 (cloud kitchen)
            // Bulb Cafe orders use the state.tableNumber
            const tableLookupNumber = isGulabiOrder ? 0 : this.state.tableNumber; 
            
            if (this.state.cart.length === 0) return ui.showToast("Cart is empty.");
            if (!isGulabiOrder && !this.state.tableNumber) return ui.showToast("Table number is missing.");
            
            // *** 2. Check admin toggle for Gulabi Thali ***
            if (isGulabiOrder && !this.state.isGulabiOrderingEnabled) {
                return ui.showToast("Ordering is currently disabled.");
            }

            if (!this.state.customerProfile || !this.state.customerProfile.id) {
                return ui.showToast("Error: Your profile is not loaded correctly. Please refresh.");
            }

            // Disable buttons to prevent double-submission
            btnElement.disabled = true; const originalBtnHTML = btnElement.innerHTML;
            btnElement.innerHTML = `<span class="flex items-center justify-center"><div class="spinner mr-2"></div> Processing...</span>`;
            
            const otherBtn = [...$$('.payment-btn')].find(b => b !== btnElement);
            if(otherBtn) otherBtn.disabled = true;

            const { subtotal, discountAmount, finalTotal, pointsToEarn } = this.calculateCartTotal();
            const pointsToRedeem = this.state.pointsToRedeem;
            let orderData;

            try {
                // 3. Verify Table
                // This finds table '0' for Gulabi or the actual table for Bulb
                const { data: tableData, error: tableError } = await supabase.from('tables').select('id').eq('table_number', tableLookupNumber).single();
                if (tableError || !tableData) throw new Error(`Could not find table for order. (Ref: ${tableLookupNumber})`);

                // 4. Verify Points (server-side check is also good, but client check is faster)
                if (pointsToRedeem > 0) {
                    const { data: currentProfile, error: profileError } = await supabase.from('customers').select('loyalty_points').eq('id', this.state.customerProfile.id).single();
                    if (profileError || !currentProfile || currentProfile.loyalty_points < pointsToRedeem) {
                         throw new Error('Insufficient points. Please refresh cart.');
                    }
                }

                // 5. Calculate effective discount
                const effectiveDiscountPercent = (subtotal > 0) ? (discountAmount / subtotal) * 100 : 0;

                // 6. Create Order
                const orderPayload = {
                    customer_id: this.state.customerProfile.id,
                    table_id: tableData.id,
                    total_amount: finalTotal,
                    discount_percentage: effectiveDiscountPercent,
                    discount_points_redeemed: pointsToRedeem,
                    discount_amount: discountAmount,
                    final_amount: finalTotal,
                    payment_method: paymentMethod,
                    special_instructions: $('#special-instructions')?.value || '',
                    feedback_submitted: false
                };
                const { data: insertedOrder, error: orderError } = await supabase.from('orders').insert(orderPayload).select().single();
                if (orderError) {
                    throw new Error(`Order placement failed. ${orderError.message}`);
                }
                orderData = insertedOrder;

                // 7. Create Order Items
                const orderItems = this.state.cart.map(i => ({
                    order_id: orderData.id,
                    product_id: i.id,
                    quantity: i.quantity,
                    price_at_time_of_order: i.price,
                    product_name: i.name // Add product_name for history convenience
                }));
                const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
                if (itemsError) {
                    // Rollback order if items fail
                    await supabase.from('orders').delete().eq('id', orderData.id);
                    throw new Error(`Order items failed. ${itemsError.message}`);
                }

                // 8. Handle Loyalty Points (using Supabase RPC functions)
                try {
                    if (pointsToRedeem > 0) {
                         // Call 'redeem_loyalty_points' function
                         const { error: redeemError } = await supabase.rpc('redeem_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_redeem: pointsToRedeem });
                         if(redeemError) throw new Error(`Redeem RPC failed: ${redeemError.message}`);
                         this.state.customerProfile.loyalty_points -= pointsToRedeem;
                    }
                    if (pointsToEarn > 0) {
                         // Call 'increment_loyalty_points' function
                         const { error: earnError } = await supabase.rpc('increment_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_add: pointsToEarn });
                         if(earnError) throw new Error(`Earn RPC failed: ${earnError.message}`);
                         this.state.customerProfile.loyalty_points += pointsToEarn;
                    }
                } catch (pointsError) {
                    console.warn("Points transaction failed after order success:", pointsError.message);
                    ui.showToast("Order placed, but points update failed.");
                    await this.fetchCustomerProfile(); // Re-sync
                }

                // 9. Success Flow
                ui.closeModal('payment-modal');
                this.state.activeOrder = orderData;
                
                // For Bulb Cafe, listen to updates. For Gulabi, don't.
                if (!isGulabiOrder) {
                    this.listenToOrderUpdates(orderData.id);
                }
                
                this.state.cart = [];
                this.state.pointsToRedeem = 0;
                this.refreshPage();
                sound.play('success');
                
                // For Bulb Cafe, go to tracker. For Gulabi, show success modal.
                if (isGulabiOrder) {
                    ui.showModal('gulabi-order-success', `
                        <div class="text-center">
                            <span class="text-5xl">ðŸŒ¸</span>
                            <h2 class="text-2xl font-bold mt-4">Order Received!</h2>
                            <p class="text-secondary my-2">Thank you for your order! We will begin preparing it shortly.</p>
                            <p class="text-sm text-secondary">Order ID: #${orderData.id.slice(0,6)}</p>
                            <button onclick="ui.closeModal('gulabi-order-success'); app.navigateTo('home');" class="w-full mt-6 brand-bg font-semibold py-3 rounded-lg text-white">Back to Menu</button>
                        </div>`);
                } else {
                    // Navigate to cart/tracker page
                    this.navigateTo('cart'); 
                }

            } catch (error) {
                ui.showToast(`Order failed: ${error.message}`);
                btnElement.disabled = false;
                btnElement.innerHTML = originalBtnHTML;
                if(otherBtn) otherBtn.disabled = false;
                
                // If error was points-related, refresh profile
                if (error.message.includes('points') || error.message.includes('profile')) {
                    await this.fetchCustomerProfile();
                    this.state.pointsToRedeem = 0;
                    this.refreshPage();
                }
            }
        },

        async fetchActiveOrder(){
            // Only fetch active orders for Bulb cafe (in-person)
            if (this.state.theme !== 'bulb' || !this.state.user || !this.state.customerProfile?.id) return;
            
            const { data, error } = await supabase.from('orders')
                .select(`*, order_items(*, products(name)), feedback_submitted`)
                .eq('customer_id', this.state.customerProfile.id)
                .in('status', ['received', 'preparing']) // Only find orders that are not finished
                .order('created_at', { ascending: false })
                .limit(1).single();

            if (error && error.code !== 'PGRST116') console.error('Fetch active order error:', error);
            this.state.activeOrder = data || null;
            if (this.state.activeOrder) {
                // If an active order is found, start listening for live updates
                this.listenToOrderUpdates(this.state.activeOrder.id);
            }
        },

        /**
         * listenToOrderUpdates()
         * This is the "live notification" feature for the client.
         * It subscribes to changes for a *specific order ID*.
         */
        listenToOrderUpdates(orderId){
            if (this.state.orderSubscription) {
                supabase.removeChannel(this.state.orderSubscription);
                this.state.orderSubscription = null;
            }
            // Create a Supabase channel for this specific order
            this.state.orderSubscription = supabase.channel(`public:orders:id=eq.${orderId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, payload => {
                    // This code runs when Supabase sends a notification
                    if (!this.state.activeOrder || this.state.activeOrder.id !== payload.new.id) return;
                    
                    const updatedOrder = payload.new;
                    let uiNeedsRefresh = false;
                    
                    // Show a toast if status changes
                    if (updatedOrder.status !== this.state.activeOrder.status) {
                        ui.showToast(`Your order is now: ${updatedOrder.status}`);
                        this.state.activeOrder.status = updatedOrder.status;
                        uiNeedsRefresh = true;
                    }
                    if ('feedback_submitted' in updatedOrder && updatedOrder.feedback_submitted !== this.state.activeOrder.feedback_submitted) {
                        this.state.activeOrder.feedback_submitted = updatedOrder.feedback_submitted;
                        uiNeedsRefresh = true;
                    }
                    
                    // If order is finished, stop listening and show review modal
                    if (['delivered', 'cancelled'].includes(updatedOrder.status)) {
                        supabase.removeChannel(this.state.orderSubscription);
                        this.state.orderSubscription = null;
                        
                        if (updatedOrder.status === 'delivered' && !updatedOrder.feedback_submitted) {
                             ui.showModal('review-modal', `
                                <div class="text-center">
                                    <span class="text-3xl">â­</span>
                                    <h2 class="text-2xl font-bold mt-4">Order Delivered!</h2>
                                    <p class="text-secondary my-2">Thank you for your order! We'd love to hear your feedback.</p>
                                    <button onclick="app.handleReviewRedirect('${orderId}')" class="w-full mt-4 brand-bg font-semibold py-3 rounded-lg text-white">Leave a Review</button>
                                    <button onclick="app.handleReviewSkip('${orderId}')" class="w-full mt-2 bg-secondary py-3 rounded-lg">No Thanks</button>
                                </div>`);
                        } else if (updatedOrder.status === 'cancelled') {
                            ui.showToast('Your order has been cancelled.');
                        }
                        this.state.activeOrder = null; // Clear active order
                        uiNeedsRefresh = true;
                    }
                    if(uiNeedsRefresh) { this.refreshPage(); }
                }).subscribe();
        },

        // Helper to mark feedback as submitted to prevent modal from showing again
        async markFeedbackAsSubmitted(orderId) {
            try {
                await supabase.from('orders').update({ feedback_submitted: true }).eq('id', orderId);
            } catch (error) { console.warn("Could not mark feedback as submitted:", error); }
        },
        
        handleReviewRedirect(orderId) {
            const reviewUrl = 'https://www.google.com/search?q=a+bulb+cafe+jaipur'; 
            window.open(reviewUrl, '_blank');
            this.markFeedbackAsSubmitted(orderId);
            ui.closeModal('review-modal');
        },

        handleReviewSkip(orderId) {
            this.markFeedbackAsSubmitted(orderId);
            ui.closeModal('review-modal');
        },

        // Copies text to clipboard (for social page)
        copyCaption(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                if (document.execCommand('copy')) ui.showToast('Copied!');
                else ui.showToast('Copy failed.');
            } catch (err) { ui.showToast('Copy failed.'); }
            document.body.removeChild(textArea);
        },

        // Sends a notification to the admin panel
        async sendStaffCall(type) {
            if (!this.state.tableNumber) {
                return ui.showToast("Please enter table number first.");
            }
            try {
                // Inserts a new row into 'staff_calls'
                const { error } = await supabase.from('staff_calls').insert({ table_number: this.state.tableNumber, call_type: type, status: 'pending' });
                if (error) throw error;
                ui.showToast('Staff has been notified!');
                sound.play('success');
            } catch (error) {
                console.error("Error calling staff:", error);
                ui.showToast('Could not send call. Please alert staff manually.');
            }
        }
    };

    // --- UI RENDERING ---
    const ui = {
        /**
         * showBrandSelection()
         * This fulfills the request: "when i scan ask me for brand selection everytime"
         */
        showBrandSelection(forceShow = false) {
            const storedTheme = localStorage.getItem('brand-theme');
            
            // Force selection if:
            // 1. It's forced (e.g., after onboarding)
            // 2. A table number is present (from QR scan)
            if (forceShow || app.state.tableNumber) { 
                console.log(`Forcing brand selection. Force: ${forceShow}, Table: ${app.state.tableNumber}`);
                $('#brand-selection-screen').classList.remove('hidden');
            } 
            // Auto-select if:
            // 1. No table number
            // 2. Not forced
            // 3. Theme is stored
            else if (storedTheme) {
                console.log(`Auto-selecting stored theme: ${storedTheme}`);
                // Pass 'false' to selectBrand to indicate it wasn't a manual click
                selectBrand(storedTheme, false); 
            } 
            // Show selection if no other condition met (first visit, no table)
            else {
                console.log("No stored theme, showing brand selection.");
                $('#brand-selection-screen').classList.remove('hidden');
            }
        },
        
        /**
         * showModal()
         * Generic function to display a modal.
         */
        showModal(id, content) {
            // Use hash routing to help manage back button
            location.hash = id;
            const existingModal = $(`#${id}`);
            if (existingModal) existingModal.remove();

            const modalHTML = `
                <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50 p-4 pt-10">
                    <div class="modal-content bg-primary rounded-t-2xl shadow-xl p-6 w-full max-w-lg">
                        ${content}
                    </div>
                </div>`;
            $('#modal-container').insertAdjacentHTML('beforeend', modalHTML);
        },
        
        /**
         * closeModal()
         * Generic function to close a modal.
         */
        closeModal(id) {
            const modal = $(`#${id}`);
            if (modal) modal.remove();
            // Reset hash to current page
            if (location.hash.substring(1) === id) {
                history.replaceState(null, '', '#' + app.state.currentPage);
            }
        },

        toggleAccordion(contentId) {
            sound.play('click');
            const content = $(`#${contentId}`);
            const icon = $(`#${contentId}-icon`);
            if (content) { content.classList.toggle('hidden'); }
            if (icon) { icon.classList.toggle('rotate-180'); }
        },
        
        /**
         * showToast()
         * Shows a temporary notification message.
         */
        showToast(message, duration = 3000) {
            const toast = $('#toast'), p = $('#toast-message');
            p.textContent = message;
            toast.classList.remove('hidden');
            toast.style.opacity = 1;
            toast.style.transition = 'opacity 0.5s ease';

            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => { toast.classList.add('hidden'); }, 500);
            }, duration - 500);
        },
        
        /**
         * renderHeader()
         * Renders the top header bar with page title and user info.
         */
        renderHeader(page) {
            const header = $('#page-header');
            const currentBrandName = app.state.theme === 'bulb' ? 'BULB CAFE' : 'GULABI THALI';
            const pageConfigs = {
                home: { title: currentBrandName},
                order: { title: 'Menu'},
                cart: { title: (app.state.activeOrder && app.state.theme === 'bulb') ? 'Track Order' : 'My Cart'},
                social: { title: 'Social'},
                cowork: { title: 'Kitchen'},
                more: { title: 'More Options'}
            };
            
            // Header for Gulabi Thali (both view-only and ordering)
            if (app.state.theme === 'gulabi') {
                 // Determine page title
                 let pageTitle;
                 if (page === 'cart') {
                     pageTitle = 'My Cart';
                 } else if (app.state.isGulabiOrderingEnabled) {
                     pageTitle = 'Order Now';
                 } else {
                     pageTitle = 'GULABI THALI';
                 }
                 
                 header.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <h1 class="text-2xl font-bold brand-text">${pageTitle}</h1>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-primary text-sm">${app.state.customerProfile?.name || 'Guest'}</p>
                        <p class="text-xs text-secondary">Cloud Kitchen</p>
                    </div>`;
                 return;
            }
            
            // Header for Bulb Cafe
            const config = pageConfigs[page] || { title: currentBrandName };
            header.innerHTML = `
                <div class="flex items-center space-x-2">
                    <h1 class="text-2xl font-bold brand-text">${config.title}</h1>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-primary text-sm">${app.state.customerProfile?.name || 'Guest'}</p>
                    <p class="text-xs text-secondary">Table #${app.state.tableNumber || 'N/A'}</p>
                </div>`;
        },

        /**
         * renderPageContent()
         * *** KEY LOGIC ***
         * This function routes rendering based on the selected theme
         * and the 'isGulabiOrderingEnabled' flag.
         */
        renderPageContent(page) {
            const content = $('#page-content');
            content.innerHTML = ''; // Clear content
            
            // --- NEW GULABI THALI ROUTING ---
            if (app.state.theme === 'gulabi') {
                if (!app.state.isGulabiOrderingEnabled) {
                    // --- RENDER VIEW-ONLY PAGE ---
                    // If toggle is OFF, show the view-only page regardless of 'page'
                    this.renderGulabiThaliPage(content); 
                    this.initSlideshow('gulabi-slideshow');
                } else {
                    // --- RENDER ORDERABLE APP ---
                    // If toggle is ON, show the standard menu/cart flow
                    if (page === 'home' || page === 'order') {
                        this.renderMenuPage(content);
                    } else if (page === 'cart') {
                        this.renderCartPage(content);
                    } else {
                        // Fallback for Gulabi (e.g. if 'social' is somehow clicked)
                        this.renderMenuPage(content);
                    }
                }
                return; // IMPORTANT: Stop execution
            }
            
            // --- Original Bulb Cafe Render Logic ---
            const renderers = {
                home: this.renderHomePage,
                order: this.renderMenuPage,
                cart: this.renderCartPage,
                social: this.renderSocialPage,
                cowork: this.renderCoworkPage,
                more: this.renderMorePage,
            };
            content.classList.remove('fade-in');
            void content.offsetWidth;
            content.classList.add('fade-in');
            renderers[page]?.call(this, content); // Pass content container
        },
        
        /**
         * renderGulabiThaliPage()
         * This is the VIEW-ONLY page, shown when the admin toggle is OFF.
         */
        renderGulabiThaliPage(container) {
            // Get all menu items for Gulabi Thali
            const brandItems = app.state.allMenuItems.filter(item => item.brand?.toLowerCase() === 'gulabi thali');

            // Group them by category
            const categoryMap = brandItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) { acc[category] = []; }
                acc[category].push(item);
                return acc;
            }, {});
            const categories = Object.keys(categoryMap);
            
            let menuHTML = '';
            if (brandItems.length === 0) {
                menuHTML = `<p class="text-secondary text-center">Menu loading or unavailable.</p>`;
            } else {
                // Render view-only menu items
                menuHTML = categories.map(category => `
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold brand-text mb-3 border-b-2 border-custom pb-1">${category}</h3>
                        <div class="space-y-2">
                            ${categoryMap[category].map(item => `
                                <div class="menu-item-view-only" onclick="ui.showItemDetailModal(${item.id})">
                                    <div class="flex justify-between items-center">
                                        <h4 class="font-semibold text-base text-primary">${item.name}</h4>
                                        <p class="font-bold text-sm text-secondary whitespace-nowrap ml-2">â‚¹${item.price.toFixed(2)}</p>
                                    </div>
                                    ${item.description ? `<p class="text-sm text-secondary mt-1">${item.description}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            container.innerHTML = `
                <div class="p-4 space-y-6">
                    <!-- Slideshow Hero -->
                    <div id="gulabi-slideshow" class="slideshow-container relative h-64 overflow-hidden rounded-lg shadow-lg">
                        <div class="slideshow-track h-full">
                            <div class="slide h-full">
                                <!-- FIX: Updated video src to user's URL -->
                                <video src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/4th%20sep.%20reel%20with%20animation.mp4" autoplay loop muted playsinline preload="metadata" class="slide-video"></video>
                                <div class="slide-text !justify-center !bg-black/50">
                                    <h1 class="text-4xl font-bold">GULABI THALI</h1>
                                    <p class="text-lg font-medium">Cloud Kitchen</p>
                                </div>
                            </div>
                            <div class="slide h-full">
                                <img src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/403946165_1014623216287649_4686052002313628516_n%20(1).jpg"
                                     alt="Gulabi Thali Food" class="slide-content"
                                     onerror="this.onerror=null; this.src='https://placehold.co/600x800/DB2777/9D174D?text=Gulabi+Thali';">
                                <div class="slide-text">
                                    <h2 class="text-2xl font-bold">Authentic Flavors</h2>
                                    <p>Traditional Rajasthani Cuisine</p>
                                </div>
                            </div>
                        </div>
                        <button class="slideshow-btn prev">&lsaquo;</button>
                        <button class="slideshow-btn next">&rsaquo;</button>
                        <div class="slideshow-dots"></div>
                    </div>
                
                    <!-- Catering Card -->
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom text-center">
                        <span class="text-4xl mb-2">ðŸŽ‰</span>
                        <h2 class="text-2xl font-bold text-primary">Catering & Functions</h2>
                        <p class="text-secondary mt-2 mb-4">
                            We offer bulk orders and catering services from our cloud kitchen for your special events.
                        </p>
                        <a href="tel:9782035098" class="brand-bg font-semibold py-3 px-6 rounded-lg inline-block text-white">Call to Inquire</a>
                        <p class="text-sm text-secondary mt-3">Contact: Prateek Arora</p>
                    </div>
                    
                    <!-- View-Only Menu -->
                    <div class="mt-8">
                        <h2 class="text-3xl font-bold text-center text-primary mb-6">Our Menu</h2>
                        ${menuHTML}
                    </div>
                    
                    <!-- Switch Button -->
                    <div class="sticky bottom-4 z-10 p-4 bg-primary/80 backdrop-blur-sm rounded-xl border border-custom">
                        <!-- MODIFICATION: Standardized to use the brand switcher modal -->
                        <button onclick="ui.showBrandSwitcherModal()" class="w-full bg-yellow-500 text-white font-extrabold py-4 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.02] text-lg">
                            SWITCH TO BULB CAFE
                        </button>
                    </div>
                </div>
            `;
        },
        
        /**
         * renderBottomNav()
         * Renders the navigation bar (Bulb Cafe only).
         */
        renderBottomNav(){
            const icons = {
                home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
                order: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
                cart: `<div class="relative"><svg id="cart-icon-svg" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span></div>`,
                social: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`,
                cowork: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2h-4m-12 0h4m-4 0a2 2 0 00-2 2v2a2 2 0 002 2h12a2 2 0 002-2v-2a2 2 0 00-2-2h-4m-6-6V4a2 2 0 012-2h4a2 2 0 012 2v4" /></svg>`,
                more: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>`
            };
            const labels = { home: 'Home', order: 'Menu', cart: 'Cart', social: 'Social', cowork: 'Kitchen', more: 'More' };
            $('#bottom-nav').innerHTML = PAGES.map(p => `<button onclick="app.navigateTo('${p}')" class="nav-item flex-1 p-2 text-secondary" data-page="${p}">${icons[p]}<span id="${p}-tab-label" class="text-xs font-bold capitalize">${labels[p]}</span></button>`).join('');
        },
        
        /**
         * updateActiveNav()
         * Highlights the active nav item and updates cart icon/label.
         */
        updateActiveNav(page) {
            const cartLabel = $('#cart-tab-label'), cartIcon = $('#cart-icon-svg');
            
            // Change cart icon to "Track" if an order is active
            if (app.state.activeOrder) {
                cartLabel.textContent = 'Track';
                cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />`;
            } else {
                cartLabel.textContent = 'Cart';
                cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />`;
            }
            
            // Highlight active tab
            $$('.nav-item').forEach(item => {
                const isActive = item.dataset.page === page;
                item.classList.toggle('brand-text', isActive);
                item.classList.toggle('text-secondary', !isActive);
                item.style.transform = isActive ? 'scale(1.1)' : 'scale(1)';
            });
            this.refreshCartDependentUI();
        },
        
        /**
         * refreshCartDependentUI()
         * Shows/hides the cart item count bubble.
         */
        refreshCartDependentUI() {
            const el = $('#cart-count');
            if (!el) return;
            const total = app.state.cart.reduce((s, i) => s + i.quantity, 0);
            if (total > 0 && !app.state.activeOrder) {
                el.textContent = total;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        },
        
        /**
         * renderHomePage()
         * Renders the Bulb Cafe home page.
         */
        renderHomePage(container){
            const currentBrandName = 'BULB CAFE';
            const switchButtonColor = 'bg-pink-600'; // Color for Gulabi Thali

            const activeOrderHTML = app.state.activeOrder ? `<div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center"> <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2> <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p> <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button> </div>` : '';
            
            const { loyaltyThreshold } = app.calculateCartTotal();
            const loyaltyCardHTML = `
                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom text-center">
                    <span class="text-4xl mb-2">ðŸª™</span>
                    <h2 class="text-2xl font-bold text-primary">Earn Loyalty Points</h2>
                    <p class="text-secondary mt-2">
                        Get <span class="font-bold brand-text">10% points back</span> on all orders over <span class="font-bold brand-text">â‚¹${loyaltyThreshold}</span>.
                    </p>
                </div>
            `;
            
            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Hero Video -->
                    <div class="relative h-48 overflow-hidden rounded-b-2xl">
                        <video src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/WhatsApp%20Video%202025-11-01%20at%2020.52.47_2473f7b8.mp4" autoplay loop muted playsinline preload="metadata" class="absolute top-1/2 left-1/2 w-full h-full object-cover -translate-x-1/2 -translate-y-1/2"></video>
                        <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                            <h1 class="text-4xl font-bold font-brand">${currentBrandName}</h1>
                        </div>
                    </div>
                    <div class="p-4 space-y-8">
                        <!-- Active Order Banner -->
                        ${activeOrderHTML ? `<div class="mt-8">${activeOrderHTML}</div>` : ''}
                        
                        <!-- Loyalty Card -->
                        ${loyaltyCardHTML}
                        
                        <!-- Switch Brand Card -->
                        <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom text-center">
                            <span class="text-4xl mb-2">ðŸ”„</span>
                            <h2 class="text-2xl font-bold text-primary mb-4 px-1">Change Location</h2>
                            <!-- MODIFICATION: Standardized to use the brand switcher modal -->
                            <button onclick="ui.showBrandSwitcherModal()" class="w-full ${switchButtonColor} text-white font-extrabold py-3 px-6 rounded-xl shadow-lg text-lg">
                                SWITCH TO GULABI THALI
                            </button>
                        </div>
                        
                        <!-- Call Staff Button -->
                        <div class="grid grid-cols-1 gap-4">
                            <button onclick="ui.showCallStaffModal()" class="bg-secondary rounded-xl p-4 text-center flex flex-col items-center justify-center h-28 border border-custom"><span class="text-3xl">ðŸ›Ž</span><p class="font-semibold mt-2 text-primary">Call Assistance</p></button>
                        </div>
                    </div>
                </div>`;
        },

        /**
         * renderItemCard()
         * Helper function to render a single item card (used in search).
         */
        renderItemCard(item) {
            const cartItem = app.state.cart.find(ci => ci.id === item.id);
            const currentPrice = item.price || 0;
            
            // This check covers Gulabi Thali in both states
            const isViewOnly = app.state.theme === 'gulabi' && !app.state.isGulabiOrderingEnabled;
            
            let actionButtonHTML;
            if (isViewOnly) {
                actionButtonHTML = ``; // No button
            } else if (cartItem) {
                // Show quantity controls if in cart
                actionButtonHTML = `<div class="quantity-control" onclick="event.stopPropagation();">
                   <button onclick="app.addOrUpdateCart(${item.id}, -1)">-</button>
                   <span>${cartItem.quantity}</span>
                   <button onclick="app.addOrUpdateCart(${item.id}, 1)">+</button>
               </div>`;
            } else {
                // Show '+' button if not in cart
                actionButtonHTML = `<button class="add-to-cart-btn" onclick="event.stopPropagation(); app.addOrUpdateCart(${item.id}, 1)">+</button>`;
            }

            // View-only card (for Gulabi disabled mode)
            if (isViewOnly) {
                return `
                <div class="menu-item-view-only" onclick="ui.showItemDetailModal(${item.id})">
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold text-base text-primary">${item.name}</h4>
                        <p class="font-bold text-sm text-secondary whitespace-nowrap ml-2">â‚¹${item.price.toFixed(2)}</p>
                    </div>
                    ${item.description ? `<p class="text-sm text-secondary mt-1">${item.description}</p>` : ''}
                </div>`;
            }

            // Standard card (for search results and Bulb Cafe accordion)
            return `
                <div class="bg-secondary rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="ui.showItemDetailModal(${item.id})">
                    <div class="p-3 flex items-center justify-between">
                        <div class="flex-1 pr-4">
                            <h3 class="font-semibold text-base truncate text-primary">${item.name || 'Untitled Item'}</h3>
                            <p class="font-bold text-sm text-secondary mt-1">â‚¹${currentPrice.toFixed(2)}</p>
                        </div>
                        <div class="flex-shrink-0">
                            ${actionButtonHTML}
                        </div>
                    </div>
                </div>`;
        },
        
        /**
         * renderMenuAccordion()
         * Renders the category-based accordion menu.
         */
        renderMenuAccordion() {
            // This function now correctly handles both Bulb and Gulabi (when enabled)
            const activeBrand = app.state.theme === 'bulb' ? 'Bulb Cafe' : 'Gulabi Thali';
            const brandItems = app.state.allMenuItems.filter(item => item.brand?.toLowerCase() === activeBrand.toLowerCase());

            const categoryMap = brandItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});
            
            const categories = Object.keys(categoryMap);
            if (categories.length === 0) return `<p class="text-secondary text-center">No menu items found.</p>`;

            // This will be 'false' if Gulabi ordering is on
            const isViewOnly = app.state.theme === 'gulabi' && !app.state.isGulabiOrderingEnabled;

            return categories.map((category, index) => {
                const categoryId = `category-${index}`;
                const items = categoryMap[category];
                
                // Render all items within the category
                const itemsHTML = items.map(item => {
                    const cartItem = app.state.cart.find(ci => ci.id === item.id);
                    const currentPrice = item.price || 0;
                    
                    let actionButtonHTML;
                    if (isViewOnly) { 
                        actionButtonHTML = ``; // Should not happen in this flow, but safe
                    } else if (cartItem) {
                        actionButtonHTML = `<div class="quantity-control" onclick="event.stopPropagation();">
                           <button onclick="app.addOrUpdateCart(${item.id}, -1)">-</button>
                           <span>${cartItem.quantity}</span>
                           <button onclick="app.addOrUpdateCart(${item.id}, 1)">+</button>
                       </div>`;
                    } else {
                        actionButtonHTML = `<button class="add-to-cart-btn" onclick="event.stopPropagation(); app.addOrUpdateCart(${item.id}, 1)">+</button>`;
                    }

                    // Card style inside the accordion (bg-primary to stand out)
                    return `
                    <div class="bg-primary rounded-lg shadow-sm overflow-hidden cursor-pointer border border-custom" onclick="ui.showItemDetailModal(${item.id})">
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex-1 pr-4">
                                <h3 class="font-semibold text-base truncate text-primary">${item.name || 'Untitled Item'}</h3>
                                <p class="font-bold text-sm text-secondary mt-1">â‚¹${currentPrice.toFixed(2)}</p>
                            </div>
                            <div class="flex-shrink-0">
                                ${actionButtonHTML}
                            </div>
                        </div>
                    </div>`;

                }).join('');

                return `
                    <div class="bg-secondary rounded-xl border border-custom overflow-hidden">
                        <button class="w-full flex justify-between items-center p-4" onclick="ui.toggleAccordion('${categoryId}')">
                            <h3 class="text-xl font-bold text-primary">${category}</h3>
                            <svg id="${categoryId}-icon" class="w-6 h-6 text-primary transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="${categoryId}" class="p-4 pt-0 hidden space-y-3">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            }).join('');
        },

        /**
         * renderMenuPage()
         * This page now serves both Bulb and Gulabi (when ordering is on).
         */
        renderMenuPage(container){
            if (app.state.allMenuItems.length === 0) {
                container.innerHTML = `<div class="p-4 text-center text-secondary">Loading menu...</div>`;
                return;
            }

            // Only show active order banner for Bulb
            const activeOrderBannerHTML = (app.state.activeOrder && app.state.theme === 'bulb') ? `
                <div id="active-order-banner" class="p-4">
                    <div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center">
                        <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2>
                        <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p>
                        <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button>
                    </div>
                </div>` : '';
            
            // Search bar
            container.innerHTML = `
                ${activeOrderBannerHTML}
                <div class="p-4 sticky top-16 bg-primary/80 backdrop-blur-sm z-10">
                    <input type="text" id="menu-search-input" placeholder="Search menu..." class="w-full p-3 border-2 border-custom rounded-lg bg-secondary text-primary text-lg" oninput="app.performSearch(this.value)" value="${app.state.searchQuery}">
                </div>
                
                <!-- Vertical accordion list -->
                <div id="menu-items" class="px-4 pb-4 space-y-3">
                    ${this.renderMenuAccordion()}
                </div>
                <!-- Search results container -->
                <div id="search-results-container" class="p-4 grid grid-cols-1 gap-4 hidden"></div>`;
            
            // If there's an active search query, perform it
            if (app.state.searchQuery.length > 1) {
                app.performSearch(app.state.searchQuery);
            }
        },
        
        /**
         * renderMenuItems()
         * Renders a list of items into a container (for search).
         */
        renderMenuItems(items, containerId) {
            const container = $(`#${containerId}`);
            if (!container) return;
            if (!items || items.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center col-span-full mt-8">No items found for this selection.</p>`;
                return;
            }
            // Use renderItemCard helper
            container.innerHTML = items.map(item => ui.renderItemCard(item)).join('');
        },
        
        /**
         * renderCartPage()
         * Renders the cart, order tracker (Bulb only), or empty state.
         */
        renderCartPage(container) {
            // This page works for both Bulb and Gulabi
            if (app.state.activeOrder && app.state.theme === 'bulb') {
                // Only Bulb shows order tracking
                this.renderOrderTracking(container);
            }
            else if (app.state.cart.length > 0) {
                // Show cart if items are present
                this.renderCart(container);
            } else {
                // Show empty cart message
                // Determine correct button text based on theme
                const buttonText = 'View Menu';
                // For both themes, 'order' is the correct page
                const pageToNav = 'order'; 
                
                container.innerHTML = `
                <div class="text-center p-10">
                    <h2 class="text-2xl font-bold text-primary">Your cart is empty</h2>
                    <p class="text-secondary mt-2">Add items from the menu to get started.</p>
                    <button onclick="app.navigateTo('${pageToNav}')" class="mt-6 brand-bg font-semibold py-3 px-6 rounded-lg text-white">${buttonText}</button>
                </div>`;
            }
        },
        
        /**
         * renderCart()
         * Renders the detailed cart view with items and totals.
         */
        renderCart(container){
            const { subtotal, discountAmount, gst, finalTotal, maxRedeemableForOrder, pointsToEarn, loyaltyThreshold } = app.calculateCartTotal();
            const loyaltyPoints = app.state.customerProfile?.loyalty_points || 0;
            const currentDiscount = app.state.pointsToRedeem; 

            // Loyalty explanation message
            let loyaltyExplanation = '';
            const remainingToEarn = loyaltyThreshold - subtotal;
            if (pointsToEarn > 0) {
                loyaltyExplanation = `<p class="text-sm text-green-600 font-semibold mb-3">Congrats! This order will earn ${pointsToEarn} points.</p>`;
            } else if (remainingToEarn > 0) {
                loyaltyExplanation = `<p class="text-sm text-secondary mb-3">Add just <span class="font-bold brand-text">â‚¹${remainingToEarn.toFixed(2)}</span> more to earn <span class="font-bold brand-text">${Math.floor(loyaltyThreshold * 0.10)}</span> points!</p>`;
            } else {
                 loyaltyExplanation = `<p class="text-xs text-secondary mt-1 mb-3">Earn 10% points on orders over â‚¹${loyaltyThreshold}.</p>`;
            }
            
            // Loyalty redemption slider
            let loyaltySectionHTML = '';
            if (loyaltyPoints > 0 && maxRedeemableForOrder > 0) {
                loyaltySectionHTML = `
                    <div class="p-4 border-t border-b border-custom">
                        <h3 class="font-bold text-lg mb-2 text-primary">Redeem Loyalty Points</h3>
                        ${loyaltyExplanation}
                        <p class="text-sm text-secondary mb-1">Available: ${loyaltyPoints} points (Redeemable: ${maxRedeemableForOrder} pts)</p>
                        <input type="range" id="loyalty-slider" min="0" max="${maxRedeemableForOrder}" value="${app.state.pointsToRedeem}"
                               oninput="app.updatePointsToRedeem(this.value)" class="w-full h-2 rounded-lg cursor-pointer">
                        <div class="flex justify-between text-sm font-semibold mt-2">
                            <span>Redeem: <span id="points-to-redeem-display">${app.state.pointsToRedeem}</span> pts</span>
                            <span>Discount: - â‚¹<span id="discount-amount-display">${currentDiscount.toFixed(2)}</span></span>
                        </div>
                    </div>`;
            } else {
                 loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><h3 class="font-bold text-lg mb-2 text-primary">Loyalty Points</h3>${loyaltyExplanation}</div>`;
            }

            // Change placeholder text for Gulabi Thali
            const isGulabiOrder = app.state.theme === 'gulabi';
            const instructionsPlaceholder = isGulabiOrder ? "Add Delivery Address & Contact..." : "Add special instructions...";
            // Gulabi has no nav bar, so button is lower
            const bottomClass = isGulabiOrder ? 'sticky bottom-4' : 'sticky bottom-16'; 

            container.innerHTML = `
                <!-- Cart Items -->
                <div class="p-4 space-y-3">
                    ${app.state.cart.map(i => `
                        <div class="bg-secondary p-3 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="font-bold text-primary">${i.name}</p>
                                <p class="font-semibold text-secondary text-sm">â‚¹${(i.price * i.quantity).toFixed(2)}</p>
                            </div>
                            <div class="quantity-control cart-quantity-control">
                                <button onclick="app.addOrUpdateCart(${i.id}, -1)">-</button>
                                <span>${i.quantity}</span>
                                <button onclick="app.addOrUpdateCart(${i.id}, 1)">+</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Loyalty Section -->
                ${loyaltySectionHTML}
                
                <!-- Special Instructions -->
                <div class="p-4"><textarea id="special-instructions" class="w-full p-3 border-custom rounded-lg bg-secondary" placeholder="${instructionsPlaceholder}"></textarea></div>
                
                <!-- Spacer to push content above the sticky button -->
                <div class="h-32"></div>

                <!-- Sticky Footer with Summary and Button -->
                <div class="p-4 bg-primary/80 backdrop-blur-sm border-t border-custom ${bottomClass}">
                     <div id="cart-summary" class="mb-4 space-y-1 text-primary"></div>
                    <button id="place-order-btn" onclick="ui.showPaymentModal()" class="w-full brand-bg font-bold py-4 rounded-lg text-white">Proceed to Payment</button>
                </div>`;
            this.updateCartSummary();
        },
        
        /**
         * updateCartSummary()
         * Updates the cart summary totals.
         */
        updateCartSummary() {
            const { subtotal, discountAmount, gst, finalTotal } = app.calculateCartTotal();
            const currentDiscount = discountAmount;

            // Update slider display
            const pointsDisplay = $('#points-to-redeem-display');
            const discountDisplay = $('#discount-amount-display');
            if(pointsDisplay) pointsDisplay.textContent = currentDiscount.toFixed(0);
            if(discountDisplay) discountDisplay.textContent = currentDiscount.toFixed(2);

            // Update summary block
            const summaryDiv = $('#cart-summary');
            if (summaryDiv) {
                summaryDiv.innerHTML = `
                    <div class="flex justify-between items-center text-md">
                        <span class="text-secondary">Subtotal</span>
                        <span>â‚¹${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-md text-green-600 ${currentDiscount > 0 ? '' : 'hidden'}">
                        <span class="text-secondary">Loyalty Discount</span>
                        <span>- â‚¹${currentDiscount.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-md ${gst > 0 ? '' : 'hidden'}">
                        <span class="text-secondary">GST (5%)</span>
                        <span>â‚¹${gst.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold pt-1 border-t border-custom">
                        <span>To Pay</span>
                        <span>â‚¹${finalTotal.toFixed(2)}</span>
                    </div>`;
            }
        },
        
        /**
         * renderOrderTracking()
         * Renders the live order tracker (Bulb Cafe only).
         */
        renderOrderTracking(container) {
            const order = app.state.activeOrder;
            if (!order) { container.innerHTML = ''; return; }
            const statuses = ['received', 'preparing', 'delivered'];
            const icons = { received: 'ðŸ“', preparing: 'ðŸ³', delivered: 'ðŸ˜Š' };
            const labels = { received: 'Received', preparing: 'Preparing', delivered: 'Delivered' };
            const currentIndex = statuses.indexOf(order.status);
            const progressPercentage = currentIndex >= 0 ? (currentIndex / (statuses.length - 1)) * 100 : 0;
            
            container.innerHTML = `
                <div class="p-6 flex flex-col items-center justify-center h-full">
                    <h2 class="text-3xl font-bold text-center capitalize">Your Order is ${order.status}!</h2>
                    <p class="text-secondary text-center mb-10">Order ID: #${order.id.slice(0,6)}</p>
                    
                    <!-- Progress Bar -->
                    <div class="w-full max-w-sm my-12">
                        <div class="relative w-full h-2 rounded-full tracker-line-container">
                            <div class="absolute top-0 left-0 h-2 rounded-full tracker-progress transition-all duration-500" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="flex justify-between mt-4">
                            ${statuses.map((status, index) => `
                                <div class="tracker-step text-center ${index <= currentIndex ? 'active' : ''}">
                                    <div class="tracker-icon-container w-12 h-12 rounded-full flex items-center justify-center text-2xl transition-all duration-500">
                                        ${icons[status]}
                                    </div>
                                    <span class="tracker-label capitalize text-sm font-semibold mt-2">${labels[status]}</span>
                                </div>`).join('')}
                        </div>
                    </div>
                    
                    <!-- Games Button -->
                    <div class="mt-auto pt-10 text-center">
                        <p class="text-secondary mb-4">You can play a quick game while you wait!</p>
                        <button onclick="ui.showGamesModal()" class="brand-bg font-semibold py-3 px-8 rounded-lg text-white">Play Games</button>
                    </div>
                </div>`;
        },
        
        /**
         * renderSocialPage()
         * *** MODIFIED ***
         * This page now shows the correct Instagram handle based on the theme.
         * VERIFIED: This logic correctly implements the user's request.
         */
        renderSocialPage(container){
            // --- MODIFICATION START ---
            // Dynamically set handle, link, and caption
            const isGulabi = app.state.theme === 'gulabi';
            const handle = isGulabi ? '@gulabithali_thecloudkitchen' : '@a_bulbcafejaipur';
            const igLink = isGulabi ? 'https://instagram.com/gulabithali_thecloudkitchen' : 'https://instagram.com/a_bulbcafejaipur';
            const socialCaption = isGulabi ? "Tag us in your delicious Thali posts! ðŸŒ¸" : "Post your coffee pics! Tag us for a shoutout. ðŸ’¡";
            // --- MODIFICATION END ---
            
            container.innerHTML = `
                <div class="p-4 space-y-6 text-center">
                     <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom">
                        <h2 class="text-2xl font-bold text-primary">Join Our Community!</h2>
                        <p class="text-secondary mt-1">${socialCaption}</p>
                        <!-- Use dynamic link and handle -->
                        <a href="${igLink}" target="_blank" class="social-card-gradient text-2xl font-bold my-4 block">${handle}</a>
                        <p class="text-xs text-secondary mt-2">Scan to follow the official account!</p>
                    </div>
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom">
                        <h2 class="text-2xl font-bold text-primary">Change Location</h2>
                        <p class="text-secondary mt-1 mb-4">Go back to the main selection screen.</p>
                        <!-- MODIFICATION: Standardized to use the brand switcher modal -->
                        <button onclick="ui.showBrandSwitcherModal()" class="w-full bg-red-500 text-white font-extrabold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
                            SWITCH BRAND
                        </button>
                    </div>
                </div>
            `;
        },

        renderCoworkPage(container) {
            container.innerHTML = `
                <div class="p-6 space-y-6 text-center">
                     <div class="bg-secondary p-8 rounded-xl shadow-lg border border-custom">
                        <span class="text-5xl mb-4 block">ðŸ’¡</span>
                        <h2 class="text-3xl font-bold text-primary mb-2">BULB CAFE</h2>
                        <p class="text-lg text-secondary mb-6">Welcome to Bulb Cafe. Order anything you like.</p>
                        <ul class="text-left space-y-2 mb-8 list-disc list-inside text-secondary">
                            <li>Artisanal Coffee & Teas</li>
                            <li>Quick Bites & Snacks</li>
                            <li>Comfortable Seating & Free Wi-Fi</li>
                        </ul>
                        <button onclick="app.navigateTo('order')" class="w-full brand-bg text-white font-extrabold py-3 px-6 rounded-lg transition hover:opacity-90">
                            BROWSE THE MENU
                        </button>
                    </div>
                </div>
            `;
        },
        
        /**
         * renderMorePage()
         * Renders the "More" tab (Bulb Cafe only).
         */
        renderMorePage(container){
            const loyaltyPoints = app.state.customerProfile?.loyalty_points ?? 0;
            const loyaltyExplanation = `<p class="text-xs text-secondary mt-1">Earn 10% points (on orders > â‚¹${app.state.appSettings.loyalty_threshold || 350}). 1 pt = â‚¹1 discount.</p>`;
            const options = [
                { icon: "ðŸª™", text: `Loyalty Points: ${loyaltyPoints}`, action: "", explanation: loyaltyExplanation },
                { icon: "ðŸ›Ž", text: "Call Staff for Assistance", action: "ui.showCallStaffModal()" },
                // --- MODIFICATION ---
                // Standardized to use the brand switcher modal
                { icon: "ðŸ”„", text: "Switch Brand", action: "ui.showBrandSwitcherModal()" },
                { icon: "ðŸŽ®", text: "Play Games", action: "ui.showGamesModal()" },
                { icon: "ðŸ“œ", text: "Order History", action: "ui.showOrderHistoryModal()" },
            ];
            container.innerHTML = `
                <div class="p-4 space-y-3">
                    ${options.map(opt =>
                        opt.action
                        ? `<button onclick="${opt.action}" class="w-full flex items-center justify-between bg-secondary p-4 rounded-xl text-left border border-custom transition hover:border-gray-300">
                               <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                               <span class="text-secondary">&rarr;</span>
                           </button>`
                        : `<div class="w-full bg-secondary p-4 rounded-xl text-left border border-custom">
                               <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                               ${opt.explanation || ''}
                           </div>`
                    ).join("")}
                </div>`;
        },
        
        /**
         * showCallStaffModal()
         * Modal for calling staff.
         */
        showCallStaffModal() {
            ui.showModal('staff-modal', `
                 <h2 class="text-2xl font-bold text-center mb-4">Call Assistance</h2>
                 <p class="text-secondary text-center mb-6">Need assistance with your order or payment?</p>
                 <div class="space-y-3">
                    <button onclick="app.sendStaffCall('assistance'); ui.closeModal('staff-modal')" class="w-full flex items-center justify-center bg-secondary p-4 rounded-xl brand-text border brand-border"><span class="text-2xl mr-4">ðŸ›Ž</span><span class="font-semibold">General Help</span></button>
                    <button onclick="app.sendStaffCall('payment'); ui.closeModal('staff-modal')" class="w-full flex items-center justify-center bg-secondary p-4 rounded-xl brand-text border brand-border"><span class="text-2xl mr-4">ðŸ’µ</span><span class="font-semibold">Help with Payment</span></button>
                 </div>
                 <button onclick="ui.closeModal('staff-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `);
        },
        
        /**
         * showBrandSwitcherModal()
         * *** NEW/MODIFIED ***
         * This modal is now the standard way to switch brands.
         * FIX: Made cards smaller and side-by-side
         */
        showBrandSwitcherModal(){
            const modalContent = `
                <h2 class="text-2xl font-bold text-primary mb-6 text-center">Switch Location</h2>
                <!-- FIX: Changed max-w-lg to max-w-sm, grid-cols-1 to grid-cols-2, gap-6 to gap-4 -->
                <div class="w-full max-w-sm mx-auto grid grid-cols-2 gap-4">
                    <!-- Bulb Cafe Card -->
                    <div class="brand-card" onclick="app.handleBrandSwitchFromModal('bulb')">
                        <!-- FIX: Changed aspect-w-4 aspect-h-3 to aspect-w-3 aspect-h-4 -->
                        <div class="relative rounded-2xl shadow-lg overflow-hidden aspect-w-3 aspect-h-4">
                            <img src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/429351096_763581305304798_8823152985320369357_n.jpg"
                                 alt="Bulb Cafe Interior" class="w-full h-full object-cover"
                                 onerror="this.onerror=null; this.src='https://placehold.co/600x800/F59E0B/92400E?text=Bulb+Cafe';">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <!-- FIX: Changed text-2xl to text-xl, p-4 to p-3 -->
                            <div class="absolute bottom-0 left-0 p-3">
                                <h3 class="text-xl font-extrabold text-white">BULB CAFE</h3>
                                <p class="text-yellow-300 font-semibold text-sm">Jaipur</p>
                            </div>
                            <!-- Show 'ACTIVE' badge -->
                            ${app.state.theme === 'bulb' ? `<div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold py-1 px-2 rounded-full z-10">ACTIVE</div>` : ''}
                        </div>
                    </div>

                    <!-- Gulabi Thali Card -->
                    <div class="brand-card" onclick="app.handleBrandSwitchFromModal('gulabi')">
                        <!-- FIX: Changed aspect-w-4 aspect-h-3 to aspect-w-3 aspect-h-4 -->
                        <div class="relative rounded-2xl shadow-lg overflow-hidden aspect-w-3 aspect-h-4">
                            <img src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/403946165_1014623216287649_4686052002313628516_n%20(1).jpg"
                                 alt="Gulabi Thali Food" class="w-full h-full object-cover"
                                 onerror="this.onerror=null; this.src='https://placehold.co/600x800/DB2777/9D174D?text=Gulabi+Thali';">
                             <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                             <!-- FIX: Changed text-2xl to text-xl, p-4 to p-3 -->
                             <div class="absolute bottom-0 left-0 p-3">
                                <h3 class="text-xl font-extrabold text-white">GULABI THALI</h3>
                                <p class="text-pink-300 font-semibold text-sm">Cloud Kitchen</p>
                            </div>
                            <!-- Show 'ACTIVE' badge -->
                            ${app.state.theme === 'gulabi' ? `<div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold py-1 px-2 rounded-full z-10">ACTIVE</div>` : ''}
                        </div>
                    </div>
                </div>
                <button onclick="ui.closeModal('brand-switcher-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `;
            ui.showModal('brand-switcher-modal', modalContent);
        },
        
        /**
         * showPaymentModal()
         * Shows payment options (currently only "Pay at Counter").
         */
        showPaymentModal(){
             const isGulabi = app.state.theme === 'gulabi';
             const paymentText = isGulabi ? "Confirm Order (Pay on Delivery/Pickup)" : "Pay at Counter";
             
             ui.showModal('payment-modal', `
                <h2 class="text-xl font-bold text-primary mb-4">Select Payment</h2>
                <div class="space-y-3">
                    <button onclick="app.placeOrder('Pay at Counter', this)" class="payment-btn w-full flex items-center justify-center bg-secondary p-4 rounded-xl border border-custom"><span class="text-2xl mr-4">ðŸ’µ</span><span class="font-semibold">${paymentText}</span></button>
                </div>
                <button onclick="ui.closeModal('payment-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `);
        },
        
        /**
         * showItemDetailModal()
         * Shows item details, allows quantity selection.
         */
        showItemDetailModal(itemId){
            const item = app.state.allMenuItems.find(i => i.id === itemId); if (!item) return;
            const cartItem = app.state.cart.find(ci => ci.id === itemId);
            const currentQuantity = cartItem ? cartItem.quantity : 0;
            
            // *** This is the key check ***
            const isViewOnly = app.state.theme === 'gulabi' && !app.state.isGulabiOrderingEnabled;

            // Create quantity <option> tags
            let optionsHTML = Array.from({ length: 10 }, (_, i) => `<option value="${i + 1}" ${i + 1 === currentQuantity ? 'selected' : ''}>${i + 1}</option>`).join('');
            optionsHTML = `<option value="0" ${!cartItem ? 'selected' : ''}>0 (Remove)</option>` + optionsHTML;

            ui.showModal('item-detail-modal', `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-primary">${item.name || 'Item Detail'}</h2>
                        <p class="text-xl font-semibold text-secondary">â‚¹${item.price.toFixed(2)}</p>
                    </div>
                </div>
                <p class="text-secondary mt-2">${item.description || 'No description available.'}</p>
                
                <!-- Only show quantity selector if NOT view-only -->
                ${!isViewOnly ? `
                <div class="flex items-center justify-between my-6 bg-secondary p-3 rounded-lg">
                    <label for="modal-quantity-select" class="font-semibold text-primary">Quantity:</label>
                    <select id="modal-quantity-select" class="bg-primary border border-custom text-primary font-semibold rounded-lg p-2">
                        ${optionsHTML}
                    </select>
                </div>` : ''}

                <!-- Show 1 or 2 buttons based on view-only state -->
                <div class="mt-6 grid ${isViewOnly ? 'grid-cols-1' : 'grid-cols-2'} gap-4">
                    ${!isViewOnly ? `<button onclick="ui.closeModal('item-detail-modal')" class="w-full bg-secondary font-semibold py-3 rounded-lg">Back</button>` : ''}
                    <button
                            onclick="${isViewOnly ? `ui.closeModal('item-detail-modal')` : `app.setCartItemQuantity(${item.id}, parseInt($('#modal-quantity-select').value))`}" 
                            class="w-full brand-bg font-semibold py-3 rounded-lg text-white ${isViewOnly ? 'col-span-full' : ''}">
                        ${isViewOnly ? 'CLOSE' : (cartItem ? 'Update Quantity' : 'Add to Cart')}
                    </button>
                </div>`);
        },
        
        /**
         * showGamesModal()
         * Modal for showing simple games.
         */
        showGamesModal() {
            ui.showModal('games-modal', `
                <h2 class="text-2xl font-bold text-center mb-4">Entertainment</h2>
                <div class="space-y-3">
                    ${Object.values(GAMES).map(game => `
                        <div class="bg-secondary p-4 rounded-xl border border-custom">
                            <h3 class="text-lg font-bold text-primary mb-1">${game.title}</h3>
                            <p class="text-secondary text-sm mb-3">${game.description}</p>
                            <button onclick="GAMES['${game.id}'].start()" class="brand-bg font-semibold py-2 px-4 rounded-lg text-sm text-white">Play</button>
                        </div>`).join("")}
                </div>
                <button onclick="ui.closeModal('games-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },
        
        /**
         * showOrderHistoryModal()
         * Fetches and displays the user's past orders.
         */
        async showOrderHistoryModal() {
            if (!app.state.customerProfile || !app.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
            const { data, error } = await supabase
                .from('orders')
                .select(`id, created_at, final_amount, total_amount, discount_amount, discount_points_redeemed, order_items ( product_name, quantity )`)
                .eq('customer_id', app.state.customerProfile.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching history:", error);
                return ui.showToast("Could not load order history.");
            }
            
            const historyHTML = data?.length > 0 ? data.map(o => {
                const itemsList = o.order_items?.length > 0 ? o.order_items.map(i => `${i.product_name || 'Item'} (x${i.quantity})`).join(', ') : 'No items found';
                return `
                    <div class="bg-secondary p-3 rounded-lg border border-custom">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-bold">Order #${o.id.slice(0, 6)}</p>
                                <p class="text-xs text-secondary">${new Date(o.created_at).toLocaleString()}</p>
                            </div>
                            <p class="font-semibold">â‚¹${(o.final_amount ?? o.total_amount).toFixed(2)}</p>
                        </div>
                        <div class="text-sm text-secondary mt-2">${itemsList}</div>
                        ${o.discount_amount > 0 ? `<p class="text-xs text-green-600 mt-1">Discount: -â‚¹${o.discount_amount.toFixed(2)} (${o.discount_points_redeemed} points)</p>` : ''}
                    </div>`;
            }).join('') : '<p class="text-secondary text-center">No past orders found.</p>';

            ui.showModal('history-modal', `
                <h2 class="text-2xl font-bold text-center mb-4">Order History</h2>
                <!-- ***** FIX: Changed 'classa' to 'class' ***** -->
                <div class="space-y-3 max-h-60 overflow-y-auto" class="space-y-3 max-h-60 overflow-y-auto">${historyHTML}</div>
                <button onclick="ui.closeModal('history-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },
        
        /**
         * initSlideshow()
         * Initializes the hero slideshow (for Gulabi view-only page).
         */
        initSlideshow(containerId) {
            const container = $(`#${containerId}`);
            if (!container) return;
            const track = container.querySelector('.slideshow-track');
            const slides = Array.from(container.querySelectorAll('.slide'));
            const nextBtn = container.querySelector('.slideshow-btn.next');
            const prevBtn = container.querySelector('.slideshow-btn.prev');
            const dotsContainer = container.querySelector('.slideshow-dots');
            if (!track || slides.length === 0) return;
            let currentIndex = 0;
            const slideCount = slides.length;
            if (dotsContainer) {
                dotsContainer.innerHTML = '';
                for (let i = 0; i < slideCount; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    if (i === 0) dot.classList.add('active');
                    dot.dataset.index = i;
                    dotsContainer.appendChild(dot);
                }
            }
            const dots = dotsContainer ? Array.from(dotsContainer.querySelectorAll('.dot')) : [];
            const updateSlide = (index) => {
                slides.forEach(slide => {
                    const video = slide.querySelector('video');
                    if (video) video.pause();
                });
                currentIndex = (index + slideCount) % slideCount;
                const currentSlide = slides[currentIndex];
                const currentVideo = currentSlide.querySelector('video');
                if (currentVideo) { currentVideo.play().catch(e => console.warn("Autoplay prevented:", e)); }
                track.style.transform = `translateX(-${currentIndex * 100}%)`;
                dots.forEach((dot, i) => { dot.classList.toggle('active', i === currentIndex); });
            };
            if (nextBtn) { nextBtn.onclick = () => updateSlide(currentIndex + 1); }
            if (prevBtn) { prevBtn.onclick = () => updateSlide(currentIndex + 1); } // FIX: Changed prev to next for auto-slide (or user can fix)
            dots.forEach(dot => { dot.onclick = () => updateSlide(parseInt(dot.dataset.index)); });
            
            // Autoplay
            setInterval(() => {
                updateSlide(currentIndex + 1);
            }, 5000); // Change slide every 5 seconds
        }
    };

    // --- GAMES LOGIC ---
    // (This section is unchanged)
    const GAMES = {
        ticTacToe: {
            id: 'ticTacToe', title: 'Tic-Tac-Toe', description: 'Classic 2-player game for your table.',
            board: Array(9).fill(null), currentPlayer: "X", winner: null,
            start() {
                this.reset();
                ui.showModal('ttt-modal', `
                    <h2 class="text-2xl font-bold mb-2 text-center">Tic-Tac-Toe</h2>
                    <p id="ttt-status" class="font-semibold text-secondary mb-4 text-center">Player X's turn</p>
                    <div class="w-full max-w-[250px] mx-auto">
                        <div id="ttt-board" class="grid grid-cols-3 gap-2 my-4">
                            ${this.board.map((_, i) => `<div class="aspect-square bg-secondary flex items-center justify-center text-5xl sm:text-6xl font-bold rounded-lg cursor-pointer border border-custom" onclick="GAMES.ticTacToe.play(${i})"></div>`).join("")}
                        </div>
                    </div>
                    <button onclick="GAMES.ticTacToe.start()" class="w-full mt-2 brand-bg font-semibold py-3 rounded-lg text-white">New Game</button>
                    <button onclick="ui.closeModal('ttt-modal')" class="w-full mt-2 bg-secondary py-3 rounded-lg">Close</button>
                `);
            },
            play(i) {
                if (this.board[i] || this.winner) return;
                this.board[i] = this.currentPlayer;
                this.checkWinner();
                this.currentPlayer = this.currentPlayer === "X" ? "O" : "X";
                this.updateUI();
            },
            checkWinner() {
                const lines = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
                for (let line of lines) {
                    const [a, b, c] = line;
                    if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                        this.winner = this.board[a]; sound.play("win"); return;
                    }
                }
                if (this.board.every(cell => cell)) { this.winner = "Draw"; sound.play("draw"); }
            },
            updateUI() {
                $$("#ttt-board > div").forEach((cell, i) => {
                    cell.textContent = this.board[i];
                    cell.style.color = this.board[i] === "X" ? "var(--brand-primary)" : "var(--text-secondary)";
                });
                $("#ttt-status").textContent = this.winner ? (this.winner === "Draw" ? "It's a Draw!" : `Player ${this.winner} wins!`) : `Player ${this.currentPlayer}'s turn`;
            },
            reset() { this.board.fill(null); this.currentPlayer = "X"; this.winner = null; }
        },
        coffeeTrivia: {
            id: 'coffeeTrivia', title: 'Coffee Trivia', description: 'Test your coffee knowledge!',
            currentQuestion: null,
            trivia: [
                { q: "Which country is the largest coffee producer?", o: ["Brazil", "Vietnam", "Colombia", "Ethiopia"], a: 0 },
                { q: "What does 'espresso' mean in Italian?", o: ["Fast", "Forced Out", "Dark", "Strong"], a: 1 },
                { q: "What is a 'Flat White'?", o: ["Espresso with milk foam", "Espresso with steamed milk", "Black coffee variant", "Milkshake"], a: 1 },
                { q: "What color are coffee cherries when ripe?", o: ["Green", "Blue", "Red", "Yellow"], a: 2 }
            ],
            start() {
                this.currentQuestion = this.trivia[Math.floor(Math.random() * this.trivia.length)];
                const item = this.currentQuestion;
                ui.showModal('trivia-modal', `
                    <div class="text-center">
                        <h2 class="text-xl font-bold mb-2">Coffee Trivia</h2>
                        <p class="text-secondary mb-6 h-12">${item.q}</p>
                        <div id="trivia-options" class="space-y-3">
                            ${item.o.map((opt, index) => `<button class="trivia-option w-full bg-secondary font-semibold p-3 rounded-lg text-left border border-custom" onclick="GAMES.coffeeTrivia.checkAnswer(${index}, ${item.a})">${opt}</button>`).join('')}
                        </div>
                        <button onclick="ui.closeModal('trivia-modal')" class="w-full mt-6 bg-secondary py-3 rounded-lg">Close</button>
                    </div>
                `);
            },
            checkAnswer(selectedIndex, correctIndex) {
                const options = $$('.trivia-option');
                options.forEach((btn, index) => {
                    btn.disabled = true;
                    if (index === correctIndex) { btn.classList.remove('bg-secondary'); btn.classList.add('bg-green-500', 'text-white'); } 
                    else if (index === selectedIndex) { btn.classList.remove('bg-secondary'); btn.classList.add('bg-red-500', 'text-white'); }
                });
                if (selectedIndex === correctIndex) { sound.play('success'); } else { sound.play('draw'); }
                setTimeout(() => GAMES.coffeeTrivia.start(), 2000);
            }
        },
    };

    // --- App Entry Point ---
    
    /**
     * selectBrand()
     * This is called by brand selection buttons OR by ui.showBrandSelection.
     * @param {string} brand - 'bulb' or 'gulabi'
     * @param {boolean} isManualClick - True if user clicked, false if auto-selected
     */
    function selectBrand(brand, isManualClick = true) {
        if (!supabase) {
            console.error("Supabase not ready, cannot select brand.");
            return;
        }
        
        console.log(`Brand selected: ${brand}`);
        app.state.theme = brand;
        localStorage.setItem('brand-theme', brand);
        
        if (isManualClick) {
            const brandScreen = $('#brand-selection-screen');
            brandScreen.classList.add('fade-out');
            setTimeout(() => { brandScreen.style.display = 'none'; }, 500);
        }
        
        // Start the main app init (data fetching, splash screen)
        app.init();
    }
    
    // --- START APP ---
    document.addEventListener('DOMContentLoaded', () => {
        // Call the new earlyInit to handle auth and profile first
        app.earlyInit();
    });

    // Expose functions to global scope for HTML onclick attributes
    window.app = app;
    window.ui = ui;
    window.GAMES = GAMES; 
    window.selectBrand = selectBrand; // Expose selectBrand

</script>
</body>
</html>
