<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Food App</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load Fonts (Playfair Display for Brand, Poppins for Body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /*
        ========================================
        APP STYLING & DUAL-BRAND THEMING
        NEW THEME inspired by index (7).html
        ========================================
        */
        :root {
            /* Brand A (Bulb Cafe) */
            --brand-primary: 245 158 11; /* text-amber-500 */
            --brand-secondary: 75 85 99; /* text-gray-600 */
            --brand-font: 'Playfair Display', serif;

            /* Light Theme (default) - From index (7).html */
            --bg-primary: 255 255 255; /* #FFFFFF */
            --bg-secondary: 243 244 246; /* #F3F4F6 */
            --text-primary: 17 24 39; /* #111827 */
            --text-secondary: 107 114 128; /* #6B7280 */
            --border-color: 229 231 235; /* #E5E7EB */
        }

        [data-brand="gulabi"] {
            /* Brand B (Gulabi Thali) */
            --brand-primary: 236 72 153; /* text-pink-500 */
            --brand-secondary: 190 24 93; /* text-pink-700 */
            --brand-font: 'Playfair Display', serif;
        }

        [data-theme="dark"] {
            /* Dark Mode (Universal) - From index (7).html */
            --bg-primary: 17 17 17; /* #111111 */
            --bg-secondary: 31 32 35; /* #1F2023 */
            --text-primary: 249 250 251; /* #F9FAFB */
            --text-secondary: 156 163 175; /* #9CA3AF */
            --border-color: 55 65 81; /* #374151 */
        }

        /* Utility function to use CSS vars with Tailwind opacity */
        .bg-primary { background-color: rgb(var(--bg-primary)); }
        .bg-secondary { background-color: rgb(var(--bg-secondary)); }
        .text-primary { color: rgb(var(--text-primary)); }
        .text-secondary { color: rgb(var(--text-secondary)); }
        .text-brand { color: rgb(var(--brand-primary)); }
        .border-default { border-color: rgb(var(--border-color)); }
        .font-brand { font-family: var(--brand-font); }
        .fill-brand { fill: rgb(var(--brand-primary)); }
        
        .bg-brand-primary { background-color: rgb(var(--brand-primary)); }
        .bg-brand-secondary { background-color: rgb(var(--brand-secondary)); }

        /* Ensure app fills viewport */
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Poppins', sans-serif; /* Default font */
        }

        /* Main app container */
        #app {
            max-width: 480px; /* Mobile-first max-width */
            margin: 0 auto;
            height: 100vh; /* Full viewport height */
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /*
        ========================================
        SPLASH SCREEN
        ========================================
        */
        #splash-screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #splash-screen svg {
            width: 80px;
            height: 80px;
            animation: pulse-light 2s infinite ease-in-out;
        }
        @keyframes pulse-light {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        .splash-hide {
            opacity: 0;
            transform: scale(1.2);
            pointer-events: none;
        }

        /*
        ========================================
        PAGE CONTAINER & TRANSITIONS
        ========================================
        */
        #main-content {
            flex-grow: 1;
            position: relative;
            overflow-y: auto;
            /* Enable momentum scrolling on iOS */
            -webkit-overflow-scrolling: touch; 
        }

        .page {
            position: absolute;
            top: 0; left: 0; right: 0;
            min-height: 100%;
            padding: 1.5rem 1.5rem 6rem 1.5rem; /* 6rem bottom padding for tab bar */
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: none; /* Will be toggled by JS */
            z-index: 1;
        }

        .page-active {
            opacity: 1;
            transform: translateX(0);
            display: block;
            z-index: 10;
        }
        
        .page-exit {
            opacity: 0;
            transform: translateX(-100%);
            z-index: 5;
            display: block; /* Keep it in flow during transition */
        }

        /*
        ========================================
        TAB BAR
        ========================================
        */
        #tab-bar {
            flex-shrink: 0;
            height: 64px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgb(var(--border-color));
            position: relative;
            z-index: 50;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            flex: 1;
            padding-top: 8px;
            padding-bottom: 4px;
        }
        .tab-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
            transition: transform 0.2s ease;
        }
        .tab-item.active svg {
            transform: scale(1.1);
        }
        .tab-item .icon-default { display: block; }
        .tab-item .icon-active { display: none; }
        .tab-item.active .icon-default { display: none; }
        .tab-item.active .icon-active { display: block; }
        
        /* Cart badge */
        #cart-badge {
            position: absolute;
            top: -4px;
            right: -8px;
            min-width: 20px;
            height: 20px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #cart-badge.active {
            transform: scale(1);
        }

        /*
        ========================================
        MODALS
        ========================================
        */
        #modal-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #modal-backdrop {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #modal-box {
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 61;
            position: relative; /* For close button */
        }
        #modal-container.visible #modal-backdrop {
            opacity: 1;
        }
        #modal-container.visible #modal-box {
            transform: scale(1);
            opacity: 1;
        }

        /*
        ========================================
        TOASTS / NOTIFICATIONS
        ========================================
        */
        #toast-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .toast-item {
            padding: 12px 20px;
            border-radius: 99px;
            font-weight: 500;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: toast-in 0.5s forwards;
        }
        @keyframes toast-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .toast-item.exit {
            animation: toast-out 0.5s forwards;
        }
        @keyframes toast-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>

<body class="bg-primary text-primary">

    <!-- 
    ========================================
    SVG ICONS
    ========================================
    We embed all SVGs for a true single-file app.
    -->
    <svg width="0" height="0" class="absolute">
        <defs>
            <!-- Splash Screen Bulb -->
            <symbol id="icon-bulb" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M12 2.25c-3.13 0-6 2.636-6 6.035A6.08 6.08 0 007.5 13.978v5.158a.75.75 0 00.75.75h7.5a.75.75 0 00.75-.75v-5.158c.45-.1.884-.23 1.28-.396A6.035 6.035 0 0018 8.285c0-3.399-2.87-6.035-6-6.035zM12.75 21a.75.75 0 00-.75-.75h-1.5a.75.75 0 000 1.5h1.5a.75.75 0 00.75-.75z" clip-rule="evenodd" />
                <path d="M12 2.25a.75.75 0 01.75.75v.255a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM10.705 5.032a.75.75 0 01.028 1.06l-.17.19a.75.75 0 01-1.088-.027l-.17-.19a.75.75 0 111.088-1.032l.17.19a.75.75 0 01-.028 1.06zM14.497 6.282a.75.75 0 01-1.06.028l-.19-.17a.75.75 0 01.028-1.06l.19-.17a.75.75 0 111.032 1.088l-.19.17a.75.75 0 01-1.06-.028zM7.5 15.478v3.658h9v-3.658c1.36-.612 2.37-2.023 2.494-3.633.23-2.934-2.006-5.59-4.82-5.59S6.284 8.91 6.513 11.845c.123 1.61 1.133 3.02 2.493 3.633z" />
            </symbol>
            
            <!-- Home -->
            <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>
            </symbol>
            <symbol id="icon-home-filled" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.47 3.84a.75.75 0 011.06 0l8.25 8.25a.75.75 0 01-.12 1.06l-.12.07v6.03a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75v4.5A.75.75 0 019 20.25H4.75a.75.75 0 01-.75-.75V13.22l-.1.07a.75.75 0 01-1.06-1.06l8.25-8.25z" />
            </symbol>
            
            <!-- Order (Menu) -->
            <symbol id="icon-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle>
            </symbol>
            <symbol id="icon-menu-filled" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                <path fill-rule="evenodd" d="M1.323 11.447C2.83 7.96 7.028 5.25 12 5.25c4.972 0 9.17 2.71 10.677 6.197a.75.75 0 010 .606C21.17 16.04 16.972 18.75 12 18.75c-4.972 0-9.17-2.71-10.677-6.197a.75.75 0 010-.606zM12 17.25c4.21 0 7.903-2.105 9.284-5.048C20.137 9.355 16.421 7.5 12 7.5c-4.421 0-8.137 1.855-9.285 4.702C4.098 15.145 7.79 17.25 12 17.25z" clip-rule="evenodd" />
            </symbol>

            <!-- Cart -->
            <symbol id="icon-cart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </symbol>
            <symbol id="icon-cart-filled" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M6 6a.75.75 0 01.75-.75h11.19l-1.12 4.46a.75.75 0 01-.72.54H9.75a.75.75 0 01-.75-.75V6z" clip-rule="evenodd" />
                <path fill-rule="evenodd" d="M6.3 2.84A1.5 1.5 0 004.86 4.31L1.75 4.77a.75.75 0 00-.73 1.01l1.6 4.8a.75.75 0 00.73.51h14.7a.75.75 0 00.73-.51l2.4-7.2a.75.75 0 00-.73-1.01L8.25 2.27a.75.75 0 00-.72-.18L6.3 2.84zM3.4 12.016l.79 2.37a2.25 2.25 0 002.18 1.614h9.72a2.25 2.25 0 002.18-1.614l.79-2.37H3.4z" clip-rule="evenodd" />
                <path d="M9 22.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM18.5 19.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" />
            </symbol>

            <!-- History -->
            <symbol id="icon-history" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.75 2.75"></path><path d="M3 7v6h6"></path>
            </symbol>
            <symbol id="icon-history-filled" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M11.925 3.003a.75.75 0 01.75.75v8.665l5.22 3.013a.75.75 0 01-.75 1.299l-5.63-3.25a.75.75 0 01-.37-.65V3.753a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM3.5 12a8.25 8.25 0 1116.5 0 8.25 8.25 0 01-16.5 0z" clip-rule="evenodd" />
            </symbol>

            <!-- Profile -->
            <symbol id="icon-profile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>
            </symbol>
            <symbol id="icon-profile-filled" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 21.75c-2.67 0-5.197-.53-7.562-1.503a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
            </symbol>
        </defs>
    </svg>


    <!-- 
    ========================================
    MAIN APP WRAPPER
    ========================================
    -->
    <div id="app" class="bg-secondary">
    
        <!-- 
        ========================================
        SPLASH SCREEN
        ========================================
        -->
        <div id="splash-screen" class="bg-primary">
            <svg class="fill-brand">
                <use href="#icon-bulb"></use>
            </svg>
        </div>

        <!-- 
        ========================================
        MAIN CONTENT (Pages)
        ========================================
        This is where pages are dynamically loaded.
        -->
        <main id="main-content" class="bg-secondary">

            <!-- ==== PAGE: HOME ==== -->
            <section id="page-home" class="page space-y-6">
                <!-- Brand-specific Header -->
                <div id="home-header" class="text-center">
                    <div id="brand-logo-home" class="h-24 mx-auto mb-2"></div>
                    <h1 class="text-4xl font-bold font-brand text-primary" id="brand-welcome-text">Welcome</h1>
                </div>

                <!-- Featured Item -->
                <div class="bg-primary rounded-xl shadow-lg overflow-hidden border border-default">
                    <img src="https://placehold.co/600x400/f59e0b/white?text=Special+Offer" alt="Featured Offer" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-primary font-brand">Today's Special</h2>
                        <p class="text-secondary mt-2">Get our best-selling "Bulb Signature Roast" for 20% off. Today only!</p>
                        <button class="mt-4 w-full bg-brand-primary text-white font-bold py-3 px-6 rounded-lg shadow transition-transform hover:scale-105"
                                onclick="app.navigateTo('order')">
                            Order Now
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4">
                    <button class="bg-primary p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105 border border-default" onclick="app.navigateTo('history')">
                        <svg class="w-12 h-12 text-brand mx-auto" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                        <span class="mt-2 block font-semibold text-primary">Re-Order Last</span>
                    </button>
                    <button class="bg-primary p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105 border border-default" onclick="app.navigateTo('profile')">
                        <svg class="w-12 h-12 text-brand mx-auto" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM16.5 18h-9a2.25 2.25 0 00-2.25 2.25v.005c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-.005A2.25 2.25 0 0016.5 18z" /></svg>
                        <span class="mt-2 block font-semibold text-primary">My Profile</span>
                    </button>
                </div>
            </section>

            <!-- ==== PAGE: ORDER (MENU) ==== -->
            <section id="page-order" class="page !p-0">
                <div class="p-6 pb-2 sticky top-0 bg-secondary z-10">
                    <h1 class="text-3xl font-bold font-brand text-primary mb-4">Menu</h1>
                    <!-- Search Bar -->
                    <div class="relative">
                        <input id="search-bar" type="text" placeholder="Search menu..." class="w-full px-4 py-3 pl-10 rounded-full border border-default bg-primary text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-[rgb(var(--brand-primary))]">
                        <svg class="w-5 h-5 text-secondary absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <!-- Recent Searches -->
                    <div id="recent-searches-container" class="mt-2 flex flex-wrap gap-2">
                        <!-- e.g., <button class="recent-search-btn">Coffee</button> -->
                    </div>
                </div>
                
                <!-- Menu List -->
                <div id="menu-list-container" class="p-6 pt-2 space-y-6">
                    <!-- Categories will be dynamically injected here -->
                    <!-- 
                    <div class="menu-category">
                        <h2 class="text-2xl font-bold font-brand text-primary mb-2">Category Name</h2>
                        <div class="space-y-4">
                            <div class="menu-item-card"> ... </div>
                        </div>
                    </div>
                    -->
                    <div id="menu-loading" class="text-center py-10">
                        <span class="text-secondary">Loading menu...</span>
                    </div>
                    <div id="menu-no-results" class="text-center py-10 hidden">
                        <span class="text-secondary">No items match your search.</span>
                    </div>
                </div>
            </section>

            <!-- ==== PAGE: CART ==== -->
            <section id="page-cart" class="page">
                <h1 class="text-3xl font-bold font-brand text-primary mb-6">My Cart</h1>
                
                <!-- Cart Items -->
                <div id="cart-items-container" class="space-y-4">
                    <!-- Dynamically populated -->
                    <!-- 
                    <div class="cart-item-card flex items-center gap-4 bg-primary p-4 rounded-lg shadow border border-default">
                        <img src="https://placehold.co/100x100" class="w-20 h-20 rounded-md object-cover">
                        <div class="flex-grow">
                            <h3 class="font-bold text-primary">Product Name</h3>
                            <p class="text-sm text-secondary">Variant: Large</p>
                            <span class="font-bold text-brand">$9.99</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="quantity-btn">-</button>
                            <span>1</span>
                            <button class="quantity-btn">+</button>
                        </div>
                        <button class="remove-btn">&times;</button>
                    </div> 
                    -->
                </div>

                <!-- Empty Cart Message -->
                <div id="cart-empty-message" class="text-center py-20 hidden">
                    <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><path d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM15.75 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /></svg>
                    <p class="mt-4 text-lg font-semibold text-secondary">Your cart is empty</p>
                    <p class="text-secondary">Looks like you haven't added anything yet.</p>
                    <button class="mt-6 bg-brand-primary text-white font-bold py-3 px-6 rounded-lg shadow transition-transform hover:scale-105"
                            onclick="app.navigateTo('order')">
                        Start Ordering
                    </button>
                </div>

                <!-- Cart Summary (Show only if cart is not empty) -->
                <div id="cart-summary-container" class="mt-8 pt-6 border-t border-default hidden">
                    <div class="space-y-2 text-primary">
                        <div class="flex justify-between">
                            <span class="text-secondary">Subtotal</span>
                            <span class="font-semibold" id="cart-subtotal">₹0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-secondary">GST (5%)</span>
                            <span class="font-semibold" id="cart-gst">₹0.00</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold">
                            <span class="text-primary">Total</span>
                            <span class="text-brand" id="cart-total">₹0.00</span>
                        </div>
                    </div>
                    <button id="checkout-button" class="mt-6 w-full bg-brand-primary text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-transform hover:scale-105">
                        Proceed to Payment
                    </button>
                </div>
            </section>

            <!-- ==== PAGE: HISTORY ==== -->
            <section id="page-history" class="page">
                <h1 class="text-3xl font-bold font-brand text-primary mb-6">Order History</h1>
                
                <div id="order-history-container" class="space-y-6">
                    <!-- Dynamically populated -->
                    <!--
                    <div class="order-history-card bg-primary p-4 rounded-lg shadow border border-default">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-primary">Order #12345</span>
                            <span class="text-sm text-secondary">01 Nov 2025</span>
                        </div>
                        <p class="text-secondary">Total: <span class="font-semibold text-brand">₹25.50</span></p>
                        <p class="text-secondary">Status: <span class="font-semibold text-green-500">Delivered</span></p>
                        <div class="mt-2 text-sm text-secondary">
                            Items: Coffee (Large) x 1, Muffin x 2
                        </div>
                        <button class="re-order-btn mt-4 w-full bg-brand-secondary text-white font-semibold py-2 px-4 rounded-lg">
                            Re-Order
                        </button>
                    </div>
                    -->
                </div>

                <!-- Empty History Message -->
                <div id="history-empty-message" class="text-center py-20 hidden">
                    <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.351-.026.69.055 1.002.232.312.176.58.42.787.708.207.288.32.62.32.958V7.5M8.25 7.5h7.5M8.25 7.5V15M15.75 7.5V15m-7.5 4.5h7.5m-7.5 0a1.125 1.125 0 01-1.125-1.125V18.75c0-.621.504-1.125 1.125-1.125h7.5c.621 0 1.125.504 1.125 1.125v.375c0 .621-.504 1.125-1.125 1.125h-7.5z" /></svg>
                    <p class="mt-4 text-lg font-semibold text-secondary">No orders yet</p>
                    <p class="text-secondary">Place your first order to see it here.</p>
                </div>
            </section>

            <!-- ==== PAGE: PROFILE ==== -->
            <section id="page-profile" class="page space-y-6">
                <h1 class="text-3xl font-bold font-brand text-primary mb-4">Profile</h1>

                <!-- User Info -->
                <div class="bg-primary p-6 rounded-xl shadow-lg flex items-center gap-4 border border-default">
                    <div class="w-16 h-16 rounded-full bg-secondary flex items-center justify-center border border-default">
                        <svg class="w-10 h-10 text-brand"><use href="#icon-profile-filled"></use></svg>
                    </div>
                    <div>
                        <h2 id="profile-name" class="text-2xl font-bold text-primary">Guest</h2>
                        <p id="profile-user-id" class="text-xs text-secondary break-all">user_id: ...</p>
                    </div>
                </div>

                <!-- Loyalty Points -->
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-default">
                    <h3 class="text-xl font-bold text-primary mb-3">Loyalty Points</h3>
                    <div class="text-center mb-4">
                        <span id="profile-loyalty-points" class="text-6xl font-bold text-brand">0</span>
                        <span class="block text-secondary">Points</span>
                    </div>
                    <button id="redeem-points-btn" class="w-full bg-brand-primary text-white font-bold py-3 px-6 rounded-lg shadow transition-transform hover:scale-105 disabled:opacity-50">
                        Redeem Free Reward (100 Pts)
                    </button>
                </div>
                
                <!-- Review Bonus -->
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-default">
                    <h3 class="text-xl font-bold text-primary mb-3">Get a Review Bonus!</h3>
                    <p class="text-secondary mb-4">Get 50 bonus points for leaving us a review.</p>
                    <a href="https://www.google.com/search?q=reviews+page" target="_blank" class="block w-full text-center bg-blue-500 text-white font-bold py-3 px-6 rounded-lg mb-3">
                        1. Leave a Google Review
                    </a>
                    <button id="claim-review-btn" class="w-full bg-brand-secondary text-white font-bold py-3 px-6 rounded-lg">
                        2. Claim My 50 Points
                    </button>
                </div>

                <!-- Theme Switcher -->
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-default">
                    <h3 class="text-xl font-bold text-primary mb-3">App Settings</h3>
                    <div class="space-y-2">
                        <div>
                            <label for="brand-switcher" class="block text-secondary mb-1">Brand</label>
                            <select id="brand-switcher" class="w-full p-3 rounded-lg border border-default bg-primary text-primary focus:outline-none focus:ring-2 focus:ring-[rgb(var(--brand-primary))]">
                                <option value="bulb">Bulb Cafe</option>
                                <option value="gulabi">Gulabi Thali</option>
                            </select>
                        </div>
                        <div>
                            <label for="theme-switcher" class="block text-secondary mb-1">Theme</label>
                            <select id="theme-switcher" class="w-full p-3 rounded-lg border border-default bg-primary text-primary focus:outline-none focus:ring-2 focus:ring-[rgb(var(--brand-primary))]">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <!-- 
        ========================================
        BOTTOM TAB BAR
        ========================================
        -->
        <nav id="tab-bar" class="bg-primary">
            <button class="tab-item active" data-page="home">
                <svg class="icon-default text-secondary"><use href="#icon-home"></use></svg>
                <svg class="icon-active text-brand"><use href="#icon-home-filled"></use></svg>
                <span class="text-secondary">Home</span>
            </button>
            <button class="tab-item" data-page="order">
                <svg class="icon-default text-secondary"><use href="#icon-menu"></use></svg>
                <svg class="icon-active text-brand"><use href="#icon-menu-filled"></use></svg>
                <span class="text-secondary">Order</span>
            </button>
            <button class="tab-item" data-page="cart">
                <div class="relative">
                    <svg class="icon-default text-secondary"><use href="#icon-cart"></use></svg>
                    <svg class="icon-active text-brand"><use href="#icon-cart-filled"></use></svg>
                    <span id="cart-badge" class="bg-brand-primary text-white">0</span>
                </div>
                <span class="text-secondary">Cart</span>
            </button>
            <button class="tab-item" data-page="history">
                <svg class="icon-default text-secondary"><use href="#icon-history"></use></svg>
                <svg class="icon-active text-brand"><use href="#icon-history-filled"></use></svg>
                <span class="text-secondary">History</span>
            </button>
            <button class="tab-item" data-page="profile">
                <svg class="icon-default text-secondary"><use href="#icon-profile"></use></svg>
                <svg class="icon-active text-brand"><use href="#icon-profile-filled"></use></svg>
                <span class="text-secondary">Profile</span>
            </button>
        </nav>
    </div>

    <!-- 
    ========================================
    MODAL CONTAINER
    ========================================
    -->
    <div id="modal-container" class="hidden">
        <div id="modal-backdrop"></div>
        <div id="modal-box" class="bg-primary">
            <!-- Close button -->
            <button id="modal-close-btn" class="absolute top-2 right-3 text-secondary text-3xl">&times;</button>
            <!-- Modal Content Injected Here -->
            <div id="modal-content" class="p-6 pt-10"></div>
        </div>
    </div>

    <!-- 
    ========================================
    TOAST CONTAINER
    ========================================
    -->
    <div id="toast-container"></div>


    <!-- 
    ================================================================
    ================================================================
    
    JAVASCRIPT
    
    This is the core application logic.
    
    ================================================================
    ================================================================
    -->
    <script type="module">
        /*
        ========================================
        SUPABASE SETUP
        ========================================
        */
        const SUPABASE_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydmx2dmxmemJkcXdmc2Rscmt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NzI2NzAsImV4cCI6MjA3NzU0ODY3MH0.yYnxeipLuO0DlTvGITI5ajHDeoWZ80N2PS3rPhuOyp8';

        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            document.getElementById('page-home').innerHTML = `
                <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                    <h1 class="font-bold text-lg">Configuration Needed</h1>
                    <p>Please open this HTML file and replace 
                    <code>YOUR_SUPABASE_URL</code> and <code>YOUR_SUPABASE_ANON_KEY</code> 
                    with your project credentials from supabase.com.</p>
                </div>`;
            document.getElementById('splash-screen').classList.add('splash-hide');
            document.getElementById('page-home').classList.add('page-active');
        }

        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /*
        ========================================
        APPLICATION STATE
        ========================================
        */
        const app = {
            state: {
                currentUser: null,
                profile: { loyalty_points: 0, name: 'Guest' },
                currentBrand: 'bulb',
                currentTheme: 'light',
                currentPage: 'home',
                products: [],       // All products from DB
                categories: [],     // Unique categories from products
                cart: [],           // { id, name, price, image_url, quantity, variant: { name, price_modifier }, brand }
                orders: [],         // User's past orders
                recentSearches: [], // Last 5 search terms
                lastPage: 'home',
            },

            // ===== APP INITIALIZATION =====
            async init() {
                console.log('App init...');
                this.initTheme();
                this.initCart();
                this.initEventListeners();
                
                try {
                    await this.authenticateUser();
                    if (!this.state.currentUser) throw new Error("Authentication failed");
                    
                    console.log('User authenticated:', this.state.currentUser.id);

                    // Fetch data in parallel
                    await Promise.all([
                        this.fetchUserProfile(this.state.currentUser.id),
                        this.fetchProducts(),
                        this.fetchOrders(this.state.currentUser.id)
                    ]);
                    
                    this.setupRealtimeSubscriptions();
                    this.renderAll();

                } catch (error) {
                    console.error("Error during app initialization:", error);
                    this.showToast("Error connecting to server", "error");
                } finally {
                    // Hide splash screen
                    setTimeout(() => {
                        document.getElementById('splash-screen').classList.add('splash-hide');
                        this.navigateTo('home', true); // Force navigate to home
                    }, 1000); // Show splash for at least 1 sec
                }
            },

            // ===== AUTHENTICATION & PROFILE =====
            async authenticateUser() {
                const { data, error } = await sb.auth.signInAnonymously();
                if (error) {
                    console.error("Error signing in anonymously:", error);
                    return;
                }
                this.state.currentUser = data.user;
            },

            async fetchUserProfile(userId) {
                try {
                    let { data, error } = await sb.from('customers').select('*').eq('user_id', userId).single();
                    
                    if (error || !data) {
                        console.log('No profile found, creating one...');
                        const { data: newData, error: insertError } = await sb.from('customers')
                            .insert({ user_id: userId, name: 'Guest', loyalty_points: 0 })
                            .select()
                            .single();
                        
                        if (insertError) throw insertError;
                        this.state.profile = newData;
                    } else {
                        this.state.profile = data;
                    }
                    console.log('Profile loaded:', this.state.profile);
                } catch (error) {
                    console.error("Error fetching/creating profile:", error);
                    this.showToast("Could not load user profile", "error");
                }
            },

            // ===== DATA FETCHING =====
            async fetchProducts() {
                try {
                    let { data, error } = await sb.from('products').select('*');
                    if (error) throw error;
                    
                    this.state.products = data;
                    // Get unique categories from all products
                    const categorySet = new Set(data.map(p => p.category));
                    this.state.categories = [...categorySet].sort();
                    
                    console.log('Products loaded:', this.state.products.length);
                    this.renderMenu();
                } catch (error) {
                    console.error("Error fetching products:", error);
                    this.showToast("Could not load menu", "error");
                }
            },

            async fetchOrders(userId) {
                try {
                    // Fetch orders
                    let { data: orders, error } = await sb.from('orders')
                        .select('*')
                        .eq('user_id', userId)
                        .order('created_at', { ascending: false });
                    if (error) throw error;

                    // For each order, fetch its items
                    for (let order of orders) {
                        let { data: items, error: itemsError } = await sb.from('order_items')
                            .select('*')
                            .eq('order_id', order.id);
                        
                        if (itemsError) throw itemsError;
                        order.items = items;
                    }

                    this.state.orders = orders;
                    console.log('Orders loaded:', this.state.orders.length);
                    this.renderHistory();
                } catch (error) {
                    console.error("Error fetching orders:", error);
                }
            },

            // ===== REALTIME SUBSCRIPTIONS =====
            setupRealtimeSubscriptions() {
                console.log('Setting up realtime...');
                // Channel for product changes
                sb.channel('products-channel')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, 
                    (payload) => {
                        console.log('Product change received!', payload);
                        this.fetchProducts(); // Re-fetch all products
                        this.showToast("Menu has been updated!");
                    }
                  )
                  .subscribe();

                // Channel for user's order changes
                sb.channel('user-orders-channel')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `user_id=eq.${this.state.currentUser.id}` }, 
                    (payload) => {
                        console.log('Order change received!', payload);
                        this.fetchOrders(this.state.currentUser.id); // Re-fetch orders
                        if (payload.new && payload.new.status) {
                            this.showToast(`Your order #${payload.new.id.toString().slice(0, 4)} is now ${payload.new.status}`);
                        }
                    }
                  )
                  .subscribe();
            },

            // ===== NAVIGATION =====
            navigateTo(pageId, force = false) {
                const newPage = document.getElementById(`page-${pageId}`);
                if (!newPage) return;

                const oldPageId = this.state.currentPage;
                if (oldPageId === pageId && !force) return;

                const oldPage = document.getElementById(`page-${oldPageId}`);

                // Update tab bar
                document.querySelectorAll('#tab-bar .tab-item').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.page === pageId);
                    // Update text color of tab label
                    const label = tab.querySelector('span');
                    if (label) {
                        label.classList.toggle('text-brand', tab.dataset.page === pageId);
                        label.classList.toggle('text-secondary', tab.dataset.page !== pageId);
                    }
                });

                // Page Transition
                if (oldPage && oldPage !== newPage) {
                    oldPage.classList.remove('page-active');
                    oldPage.classList.add('page-exit');
                    
                    newPage.classList.add('page-active');

                    // Clean up after transition
                    setTimeout(() => {
                        oldPage.classList.remove('page-exit');
                    }, 300);
                } else {
                    newPage.classList.add('page-active');
                }

                this.state.lastPage = oldPageId;
                this.state.currentPage = pageId;

                // Scroll to top of new page
                document.getElementById('main-content').scrollTop = 0;
            },

            // ===== THEME & BRAND SWITCHING =====
            initTheme() {
                const brand = localStorage.getItem('appBrand') || 'bulb';
                const theme = localStorage.getItem('appTheme') || 'light';
                this.state.recentSearches = JSON.parse(localStorage.getItem('appRecentSearches')) || [];
                
                this.switchTheme(brand, theme);

                // Update dropdowns
                document.getElementById('brand-switcher').value = brand;
                document.getElementById('theme-switcher').value = theme;
            },

            switchTheme(brand, theme) {
                this.state.currentBrand = brand;
                this.state.currentTheme = theme;

                document.body.dataset.brand = brand;
                document.body.dataset.theme = theme;

                localStorage.setItem('appBrand', brand);
                localStorage.setItem('appTheme', theme);
                
                // Re-render menu and cart for the new brand
                this.renderMenu();
                this.renderCart();
                this.updateCartCount();

                // Update brand-specific elements
                const logoHome = document.getElementById('brand-logo-home');
                const welcomeText = document.getElementById('brand-welcome-text');
                
                // Text-based logos using the new brand font
                const bulbLogo = `<div class="flex items-center justify-center h-24 mx-auto mb-2"><span class="font-brand text-5xl font-bold" style="color: rgb(var(--brand-primary))">Bulb</span></div>`;
                const gulabiLogo = `<div class="flex items-center justify-center h-24 mx-auto mb-2"><span class="font-brand text-5xl font-bold" style="color: rgb(var(--brand-primary))">Gulabi</span></div>`;

                if (brand === 'bulb') {
                    logoHome.innerHTML = bulbLogo;
                    welcomeText.textContent = "Welcome to Bulb Cafe";
                } else {
                    logoHome.innerHTML = gulabiLogo;
                    welcomeText.textContent = "Welcome to Gulabi Thali";
                }
            },

            // ===== CART MANAGEMENT =====
            initCart() {
                const savedCart = localStorage.getItem('appCart');
                if (savedCart) {
                    this.state.cart = JSON.parse(savedCart);
                }
                this.updateCartCount();
            },

            saveCart() {
                localStorage.setItem('appCart', JSON.stringify(this.state.cart));
            },

            addToCart(product, variant, quantity = 1) {
                const existingItemIndex = this.state.cart.findIndex(
                    item => item.id === product.id && item.variant.name === variant.name
                );

                if (existingItemIndex > -1) {
                    this.state.cart[existingItemIndex].quantity += quantity;
                } else {
                    this.state.cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image_url: product.image_url,
                        quantity: quantity,
                        variant: variant,
                        brand: product.brand // <-- Add brand to cart item
                    });
                }
                
                this.saveCart();
                this.updateCartCount();
                this.renderCart();
                this.showToast(`${product.name} (${variant.name}) added to cart`);
            },
            
            updateCartQuantity(productId, variantName, newQuantity) {
                const itemIndex = this.state.cart.findIndex(
                    item => item.id === productId && item.variant.name === variantName
                );
                
                if (itemIndex > -1) {
                    if (newQuantity <= 0) {
                        // Remove item
                        this.state.cart.splice(itemIndex, 1);
                    } else {
                        this.state.cart[itemIndex].quantity = newQuantity;
                    }
                    this.saveCart();
                    this.renderCart();
                    this.updateCartCount();
                }
            },

            updateCartCount() {
                // Filter cart for current brand
                const currentBrandCart = this.state.cart.filter(item => item.brand === this.state.currentBrand);
                const totalItems = currentBrandCart.reduce((sum, item) => sum + item.quantity, 0);
                const badge = document.getElementById('cart-badge');
                if (totalItems > 0) {
                    badge.textContent = totalItems;
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            },
            
            clearCart(brandToClear = null) {
                if (brandToClear) {
                    this.state.cart = this.state.cart.filter(item => item.brand !== brandToClear);
                } else {
                    this.state.cart = [];
                }
                this.saveCart();
                this.renderCart();
                this.updateCartCount();
            },

            // ===== CHECKOUT =====
            async placeOrder() {
                const checkoutButton = document.getElementById('checkout-button');
                checkoutButton.disabled = true;
                checkoutButton.textContent = 'Placing Order...';
                
                try {
                    const { subtotal, gst, total } = this.calculateCartTotals();
                    
                    // 1. Create 'orders' entry
                    const { data: orderData, error: orderError } = await sb.from('orders').insert({
                        user_id: this.state.currentUser.id,
                        total_amount: total,
                        status: 'Pending' // 'Pay at Counter'
                    }).select().single();
                    
                    if (orderError) throw orderError;
                    
                    // 2. Create 'order_items' entries
                    const currentBrandCart = this.state.cart.filter(item => item.brand === this.state.currentBrand);
                    const orderItems = currentBrandCart.map(item => ({
                        order_id: orderData.id,
                        product_id: item.id,
                        product_name: item.name,
                        variant_name: item.variant.name,
                        quantity: item.quantity,
                        price: (item.price || 0) + item.variant.price_modifier
                    }));
                    
                    const { error: itemsError } = await sb.from('order_items').insert(orderItems);
                    if (itemsError) throw itemsError;
                    
                    // 3. Add loyalty points (e.g., 5 points for orders over 20)
                    if (total > 20) {
                        await this.addLoyaltyPoints(5, `Order #${orderData.id.toString().slice(0, 4)}`);
                    }
                    
                    // 4. Clear cart FOR THE CURRENT BRAND
                    this.clearCart(this.state.currentBrand);
                    
                    // 5. Feedback
                    this.showToast('Order placed successfully!', 'success');
                    this.navigateTo('history');
                    
                } catch (error) {
                    console.error("Error placing order:", error);
                    this.showToast("Failed to place order. Please try again.", "error");
                } finally {
                    checkoutButton.disabled = false;
                    checkoutButton.textContent = 'Proceed to Payment';
                }
            },

            // ===== RENDER FUNCTIONS (UI) =====
            
            // Render all dynamic content
            renderAll() {
                this.renderProfile();
                this.renderMenu();
                this.renderCart();
                this.renderHistory();
                this.renderRecentSearches();
            },
            
            renderMenu(searchTerm = '') {
                const container = document.getElementById('menu-list-container');
                const loading = document.getElementById('menu-loading');
                const noResults = document.getElementById('menu-no-results');
                
                // Defensive null check
                if (!container || !loading || !noResults) {
                    console.warn("RenderMenu called, but DOM elements are not ready.");
                    return;
                }

                // Filter products
                const lowerSearchTerm = searchTerm.toLowerCase();
                // 1. Filter by current brand
                const brandProducts = this.state.products.filter(p => p.brand === this.state.currentBrand);
                
                // 2. Filter by search term
                const filteredProducts = brandProducts.filter(p => 
                    p.name.toLowerCase().includes(lowerSearchTerm) ||
                    (p.category && p.category.toLowerCase().includes(lowerSearchTerm))
                );
                
                if (brandProducts.length === 0 && this.state.products.length > 0) {
                    // Products are loaded, but none for this brand
                    loading.classList.add('hidden');
                    noResults.classList.add('hidden');
                    container.innerHTML = `<div class="text-center py-10"><span class="text-secondary">Menu for ${this.state.currentBrand} is coming soon!</span></div>`;
                    return;
                }
                
                if (this.state.products.length === 0) {
                    loading.classList.remove('hidden');
                    container.innerHTML = ''; // Clear old categories
                    noResults.classList.add('hidden');
                    return;
                }
                
                loading.classList.add('hidden');
                
                if (filteredProducts.length === 0) {
                    noResults.classList.remove('hidden');
                    container.innerHTML = ''; // Clear old categories
                    return;
                }
                
                noResults.classList.add('hidden');
                
                // Group by category
                const productsByCategory = {};
                // Get categories only from brand's products
                const brandCategories = [...new Set(brandProducts.map(p => p.category))].sort();

                for (const category of brandCategories) {
                    const productsInCategory = filteredProducts.filter(p => p.category === category);
                    if (productsInCategory.length > 0) {
                        productsByCategory[category] = productsInCategory;
                    }
                }
                
                let html = '';
                for (const category in productsByCategory) {
                    html += `<div class="menu-category">
                        <h2 class="text-2xl font-bold font-brand text-primary mb-3">${category}</h2>
                        <div class="space-y-4">`;
                    
                    productsByCategory[category].forEach(product => {
                        // Show variants price range if they exist
                        const basePrice = product.price || 0;
                        let priceDisplay = `₹${basePrice.toFixed(2)}`;
                        if (product.variants && product.variants.length > 0) {
                            const minPrice = basePrice + Math.min(...product.variants.map(v => v.price_modifier));
                            const maxPrice = basePrice + Math.max(...product.variants.map(v => v.price_modifier));
                            if (minPrice !== maxPrice) {
                                priceDisplay = `₹${minPrice.toFixed(2)} - ₹${maxPrice.toFixed(2)}`;
                            } else {
                                priceDisplay = `₹${minPrice.toFixed(2)}`;
                            }
                        }

                        html += `
                            <div class="menu-item-card flex items-center gap-4 bg-primary p-4 rounded-xl shadow-lg border border-default">
                                <img src="${product.image_url || 'https://placehold.co/100x100/e5e7eb/6b7280?text=Item'}" alt="${product.name}" class="w-20 h-20 rounded-md object-cover flex-shrink-0">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-lg text-primary">${product.name}</h3>
                                    <p class="text-sm text-secondary truncate">${product.description || ''}</p>
                                    <span class="font-bold text-brand text-lg">${priceDisplay}</span>
                                </div>
                                ${product.is_orderable ? `
                                <button class="add-to-cart-btn flex-shrink-0 bg-brand-primary text-white w-10 h-10 rounded-full text-2xl font-bold shadow-md" data-product-id="${product.id}">
                                    +
                                </button>
                                ` : `
                                <span class="text-sm text-secondary text-right px-2">View Only</span>
                                `}
                            </div>
                        `;
                    });
                        
                    html += `</div></div>`;
                }
                container.innerHTML = html;
            },
            
            renderCart() {
                const container = document.getElementById('cart-items-container');
                const emptyMsg = document.getElementById('cart-empty-message');
                const summary = document.getElementById('cart-summary-container');
                
                // Filter cart for current brand
                const currentBrandCart = this.state.cart.filter(item => item.brand === this.state.currentBrand);

                if (currentBrandCart.length === 0) {
                    container.innerHTML = '';
                    emptyMsg.classList.remove('hidden');
                    summary.classList.add('hidden');
                    
                    // Check if there are items for *other* brands
                    if (this.state.cart.length > 0) {
                        document.querySelector('#cart-empty-message p.text-secondary').textContent = `You have items for another brand in your cart. Switch brands to see them.`;
                    } else {
                        document.querySelector('#cart-empty-message p.text-secondary').textContent = "Looks like you haven't added anything yet.";
                    }
                    return;
                }
                
                emptyMsg.classList.add('hidden');
                summary.classList.remove('hidden');
                
                let html = '';
                currentBrandCart.forEach(item => {
                    const itemTotal = ((item.price || 0) + item.variant.price_modifier) * item.quantity;
                    html += `
                        <div class="cart-item-card flex items-center gap-4 bg-primary p-4 rounded-lg shadow border border-default">
                            <img src="${item.image_url || 'https://placehold.co/100x100/e5e7eb/6b7280?text=Item'}" class="w-20 h-20 rounded-md object-cover">
                            <div class="flex-grow">
                                <h3 class="font-bold text-primary">${item.name}</h3>
                                <p class="text-sm text-secondary">Variant: ${item.variant.name}</p>
                                <span class="font-bold text-brand">₹${itemTotal.toFixed(2)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="quantity-btn bg-secondary text-primary w-7 h-7 rounded-full font-bold" data-product-id="${item.id}" data-variant-name="${item.variant.name}" data-action="decrease">
                                    -
                                </button>
                                <span class="font-semibold text-primary w-5 text-center">${item.quantity}</span>
                                <button class="quantity-btn bg-secondary text-primary w-7 h-7 rounded-full font-bold" data-product-id="${item.id}" data-variant-name="${item.variant.name}" data-action="increase">
                                    +
                                </button>
                            </div>
                        </div> 
                    `;
                });
                container.innerHTML = html;
                
                // Update totals
                const { subtotal, gst, total } = this.calculateCartTotals();
                document.getElementById('cart-subtotal').textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById('cart-gst').textContent = `₹${gst.toFixed(2)}`;
                document.getElementById('cart-total').textContent = `₹${total.toFixed(2)}`;
            },
            
            calculateCartTotals() {
                // Filter cart for current brand
                const currentBrandCart = this.state.cart.filter(item => item.brand === this.state.currentBrand);
                
                const subtotal = currentBrandCart.reduce((sum, item) => {
                    return sum + ((item.price || 0) + item.variant.price_modifier) * item.quantity;
                }, 0);
                const gst = subtotal * 0.05; // 5% GST
                const total = subtotal + gst;
                return { subtotal, gst, total };
            },

            renderHistory() {
                const container = document.getElementById('order-history-container');
                const emptyMsg = document.getElementById('history-empty-message');

                if (this.state.orders.length === 0) {
                    container.innerHTML = '';
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                
                emptyMsg.classList.add('hidden');
                
                let html = '';
                this.state.orders.forEach(order => {
                    const orderDate = new Date(order.created_at).toLocaleDateString();
                    const itemsSummary = order.items.map(item => `${item.product_name} (${item.variant_name}) x ${item.quantity}`).join(', ');
                    
                    html += `
                        <div class="order-history-card bg-primary p-4 rounded-lg shadow border border-default">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-primary">Order #${order.id.toString().slice(0, 8)}</span>
                                <span class="text-sm text-secondary">${orderDate}</span>
                            </div>
                            <p class="text-secondary">Total: <span class="font-semibold text-brand">₹${order.total_amount.toFixed(2)}</span></p>
                            <p class="text-secondary">Status: <span class="font-semibold text-green-500">${order.status}</span></p>
                            <div class="mt-2 text-sm text-secondary truncate">
                                ${itemsSummary}
                            </div>
                            <button class="re-order-btn mt-4 w-full bg-brand-secondary text-white font-semibold py-2 px-4 rounded-lg" data-order-id="${order.id}">
                                Re-Order
                            </button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },

            renderProfile() {
                document.getElementById('profile-name').textContent = this.state.profile.name || 'Guest';
                document.getElementById('profile-user-id').textContent = `user_id: ${this.state.currentUser?.id}`;
                document.getElementById('profile-loyalty-points').textContent = this.state.profile.loyalty_points;
                
                // Enable/disable redeem button
                document.getElementById('redeem-points-btn').disabled = this.state.profile.loyalty_points < 100;
            },
            
            renderRecentSearches() {
                const container = document.getElementById('recent-searches-container');
                if (this.state.recentSearches.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                container.classList.remove('hidden');
                container.innerHTML = this.state.recentSearches.map(term => 
                    `<button class="recent-search-btn bg-primary text-secondary px-3 py-1 rounded-full text-sm border border-default">${term}</button>`
                ).join('');
            },
            
            addRecentSearch(term) {
                if (!term) return;
                // Remove existing
                this.state.recentSearches = this.state.recentSearches.filter(s => s !== term);
                // Add to front
                this.state.recentSearches.unshift(term);
                // Limit to 5
                this.state.recentSearches = this.state.recentSearches.slice(0, 5);
                localStorage.setItem('appRecentSearches', JSON.stringify(this.state.recentSearches));
                this.renderRecentSearches();
            },

            // ===== LOYALTY & REWARDS =====
            async addLoyaltyPoints(points, reason = "Bonus") {
                try {
                    const newPoints = (this.state.profile.loyalty_points || 0) + points;
                    
                    const { data, error } = await sb.from('customers')
                        .update({ loyalty_points: newPoints })
                        .eq('user_id', this.state.currentUser.id)
                        .select()
                        .single();
                        
                    if (error) throw error;
                    
                    this.state.profile = data;
                    this.renderProfile();
                    this.showToast(`+${points} points! (${reason})`, 'success');
                    
                } catch (error) {
                    console.error("Error adding loyalty points:", error);
                }
            },
            
            redeemReward() {
                if (this.state.profile.loyalty_points < 100) {
                    this.showToast("Not enough points to redeem", "error");
                    return;
                }
                
                // Add a "Free Reward" item to the cart
                // This is a "dummy" product
                const rewardItem = {
                    id: 'REWARD-001',
                    name: 'Free Reward',
                    price: 0,
                    image_url: 'https://placehold.co/100x100/f59e0b/white?text=Reward!',
                    variant: { name: 'Redeemed', price_modifier: 0 },
                    brand: this.state.currentBrand // <-- Assign current brand to reward
                };
                
                this.addToCart(rewardItem, rewardItem.variant);
                
                // Deduct points
                this.addLoyaltyPoints(-100, "Redeemed Reward");
                
                this.navigateTo('cart');
            },

            // ===== UI FEEDBACK (TOASTS & MODALS) =====
            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast-item';
                toast.textContent = message;

                if (type === 'success') {
                    toast.style.backgroundColor = 'rgb(var(--brand-primary))';
                } else if (type === 'error') {
                    toast.style.backgroundColor = '#ef4444'; // red-500
                } else {
                    toast.style.backgroundColor = '#374151'; // gray-700
                }

                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('exit');
                    setTimeout(() => {
                        container.removeChild(toast);
                    }, 500);
                }, 3000);
            },

            showModal(content) {
                const container = document.getElementById('modal-container');
                const contentBox = document.getElementById('modal-content');
                
                contentBox.innerHTML = content;
                container.classList.remove('hidden');
                setTimeout(() => container.classList.add('visible'), 10); // For transition
            },

            hideModal() {
                const container = document.getElementById('modal-container');
                container.classList.remove('visible');
                setTimeout(() => container.classList.add('hidden'), 300); // Wait for transition
            },
            
            showVariantModal(productId) {
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return;
                
                // variants are expected to be JSON: [{"name": "Small", "price_modifier": 0}, {"name": "Large", "price_modifier": 2.50}]
                // Handle base price for variants (e.g., Gulabi Thali takeaway)
                const basePrice = product.price || 0;
                const variants = product.variants || [{ name: 'Regular', price_modifier: 0 }];
                
                let content = `
                    <h2 class="text-2xl font-bold text-primary font-brand mb-4">${product.name}</h2>
                    <img src="${product.image_url || 'https://placehold.co/600x400'}" class="w-full h-48 object-cover rounded-lg mb-4">
                    <p class="text-secondary mb-4">${product.description || ''}</p>
                    <h3 class="text-lg font-semibold text-primary mb-2">Select an option:</h3>
                    <div class="space-y-2">
                `;
                
                variants.forEach(variant => {
                    const finalPrice = (basePrice + variant.price_modifier).toFixed(2);
                    
                    // If the product is not orderable, just display, don't make it a button
                    if (!product.is_orderable) {
                        content += `
                            <div class="w-full flex justify-between items-center p-4 border border-default rounded-lg bg-secondary">
                                <span class="font-semibold text-primary">${variant.name}</span>
                                <span class="font-bold text-brand">₹${finalPrice}</span>
                            </div>
                        `;
                    } else {
                        content += `
                            <button class="variant-select-btn w-full flex justify-between items-center p-4 border border-default rounded-lg hover:bg-secondary"
                                    data-product-id="${product.id}" 
                                    data-variant-name="${variant.name}"
                                    data-variant-price-mod="${variant.price_modifier}">
                                <span class="font-semibold text-primary">${variant.name}</span>
                                <span class="font-bold text-brand">₹${finalPrice}</span>
                            </button>
                        `;
                    }
                });
                
                content += `</div>`;
                this.showModal(content);
            },

            // ===== EVENT LISTENERS =====
            initEventListeners() {
                // Tab Bar Navigation
                document.getElementById('tab-bar').addEventListener('click', (e) => {
                    const tab = e.target.closest('.tab-item');
                    if (tab && tab.dataset.page) {
                        this.navigateTo(tab.dataset.page);
                    }
                });
                
                // Brand/Theme Switchers
                document.getElementById('brand-switcher').addEventListener('change', (e) => {
                    this.switchTheme(e.target.value, this.state.currentTheme);
                });
                document.getElementById('theme-switcher').addEventListener('change', (e) => {
                    this.switchTheme(this.state.currentBrand, e.target.value);
                });
                
                // Search Bar
                const searchBar = document.getElementById('search-bar');
                searchBar.addEventListener('input', (e) => {
                    this.renderMenu(e.target.value);
                });
                searchBar.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.addRecentSearch(e.target.value);
                        searchBar.blur(); // Hide keyboard
                    }
                });
                
                // Recent Searches
                document.getElementById('recent-searches-container').addEventListener('click', (e) => {
                    if (e.target.classList.contains('recent-search-btn')) {
                        const term = e.target.textContent;
                        searchBar.value = term;
                        this.renderMenu(term);
                    }
                });

                // Add to Cart (from Menu) or View Variants
                document.getElementById('menu-list-container').addEventListener('click', (e) => {
                    const btn = e.target.closest('.add-to-cart-btn');
                    if (btn) {
                        const productId = btn.dataset.productId;
                        const product = this.state.products.find(p => p.id == productId);
                        if (product) {
                            if (product.variants && product.variants.length > 0) {
                                this.showVariantModal(product.id);
                            } else {
                                // Default/no variant
                                const defaultVariant = { name: 'Regular', price_modifier: 0 };
                                this.addToCart(product, defaultVariant);
                            }
                        }
                    }
                });

                // Modal Clicks
                document.getElementById('modal-backdrop').addEventListener('click', () => this.hideModal());
                document.getElementById('modal-close-btn').addEventListener('click', () => this.hideModal());
                document.getElementById('modal-content').addEventListener('click', (e) => {
                    const btn = e.target.closest('.variant-select-btn');
                    if (btn) {
                        const productId = btn.dataset.productId;
                        const product = this.state.products.find(p => p.id == productId);
                        const variant = {
                            name: btn.dataset.variantName,
                            price_modifier: parseFloat(btn.dataset.variantPriceMod)
                        };
                        this.addToCart(product, variant);
                        this.hideModal();
                    }
                });
                
                // Cart Quantity Buttons
                document.getElementById('cart-items-container').addEventListener('click', (e) => {
                    const btn = e.target.closest('.quantity-btn');
                    if (btn) {
                        const productId = btn.dataset.productId;
                        const variantName = btn.dataset.variantName;
                        const action = btn.dataset.action;
                        
                        const item = this.state.cart.find(i => i.id == productId && i.variant.name === variantName);
                        if (!item) return;
                        
                        let newQuantity = item.quantity;
                        if (action === 'increase') {
                            newQuantity++;
                        } else if (action === 'decrease') {
                            newQuantity--;
                        }
                        
                        this.updateCartQuantity(productId, variantName, newQuantity);
                    }
                });
                
                // Checkout Button
                document.getElementById('checkout-button').addEventListener('click', () => {
                    // Simple "Pay at Counter" confirmation
                    const content = `
                        <h2 class="text-2xl font-bold text-primary font-brand mb-4">Confirm Order</h2>
                        <p class="text-secondary mb-6">You are placing a "Pay at Counter" order. Please confirm to proceed.</p>
                        <button id="confirm-payment-btn" class="w-full bg-brand-primary text-white font-bold py-3 px-6 rounded-lg text-lg">
                            Confirm & Place Order
                        </button>
                    `;
                    this.showModal(content);
                });
                
                // Confirm Payment in Modal
                document.getElementById('modal-content').addEventListener('click', (e) => {
                    if (e.target.id === 'confirm-payment-btn') {
                        this.hideModal();
                        this.placeOrder();
                    }
                });
                
                // Re-Order Button
                document.getElementById('order-history-container').addEventListener('click', async (e) => {
                    const btn = e.target.closest('.re-order-btn');
                    if (btn) {
                        btn.disabled = true;
                        btn.textContent = 'Adding...';
                        const orderId = btn.dataset.orderId;
                        const order = this.state.orders.find(o => o.id == orderId);
                        
                        if (order && order.items) {
                            let itemsAdded = 0;
                            for (const item of order.items) {
                                // Find the *current* product details
                                const product = this.state.products.find(p => p.id === item.product_id);
                                
                                // Check if product exists, is orderable, and matches current brand
                                if (product && product.is_orderable && product.brand === this.state.currentBrand) {
                                    // Find the *current* variant
                                    const variants = product.variants || [{ name: 'Regular', price_modifier: 0 }];
                                    const variant = variants.find(v => v.name === item.variant_name);
                                    
                                    if (variant) {
                                        // Use current product data but old quantity
                                        this.addToCart(product, variant, item.quantity);
                                        itemsAdded++;
                                    } else {
                                        console.warn(`Variant ${item.variant_name} no longer exists for ${product.name}`);
                                    }
                                } else {
                                    console.warn(`Product ${item.product_name} is no longer orderable or available for this brand.`);
                                }
                            }
                            
                            if(itemsAdded > 0) {
                                this.showToast('Orderable items added to cart!');
                                this.navigateTo('cart');
                            } else {
                                this.showToast('No items from this order are available for the current brand.', 'error');
                            }
                        } else {
                            this.showToast('Could not re-order', 'error');
                        }
                        btn.disabled = false;
                        btn.textContent = 'Re-Order';
                    }
                });
                
                // Profile Page Actions
                document.getElementById('redeem-points-btn').addEventListener('click', () => this.redeemReward());
                
                document.getElementById('claim-review-btn').addEventListener('click', (e) => {
                    // This is a simulation. In a real app, you'd check a server-side flag.
                    this.addLoyaltyPoints(50, "Review Bonus");
                    e.target.disabled = true;
                    e.target.textContent = 'Bonus Claimed!';
                });
            },
        };

        // ===== START THE APP =====
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Only init if Supabase credentials are set
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                app.init();
                window.app = app; // Expose to global scope for inline onclicks
            }
        });

    </script>
</body>
</html>

