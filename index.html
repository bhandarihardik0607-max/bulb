<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Title changed to match brand -->
    <title>Bulb Cafe & Gulabi Thali</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts - Using Poppins for modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            /* Theme Variables */
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-yellow: #FFFBEB; --bg-secondary-yellow: #FEF3C7; --text-primary-yellow: #92400E; --text-secondary-yellow: #B45309; --border-yellow: #FDE68A; --brand-primary-yellow: #F59E0B;
            --bg-primary-pink: #FFF5F7; --bg-secondary-pink: #FCE7F6; --text-primary-pink: #9D174D; --text-secondary-pink: #E94C8F; --border-pink: #FBCFE8; --brand-primary-pink: #DB2777;
            --app-height: 100vh;
        }
        /* Theme Selection - Reverted to Light/Dark + new Brand Themes */
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="bulb"] { --bg-primary: var(--bg-primary-yellow); --bg-secondary: var(--bg-secondary-yellow); --text-primary: var(--text-primary-yellow); --text-secondary: var(--text-secondary-yellow); --border-color: var(--border-yellow); --brand-primary: var(--brand-primary-yellow); }
        [data-theme="gulabi"] { --bg-primary: var(--bg-primary-pink); --bg-secondary: var(--bg-secondary-pink); --text-primary: var(--text-primary-pink); --text-secondary: var(--text-secondary-pink); --border-color: var(--border-pink); --brand-primary: var(--brand-primary-pink); }

        /* Base & Utility Styles */
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Poppins', sans-serif; background-color: #000000; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        .app-container { background-color: var(--bg-primary); transition: background-color 0.5s ease; height: var(--app-height); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }
        .brand-border { border-color: var(--brand-primary); }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; } @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #splash-screen .brand-logo { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Custom UI Elements */
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .horizontal-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .spinner {
            border: 2px solid var(--bg-primary);
            border-top: 2px solid var(--brand-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tracking Tracker */
        .tracker-container { display: flex; align-items: center; justify-content: space-between; position: relative; }
        .tracker-line-container { position: absolute; top: 18px; left: 40px; right: 40px; height: 4px; background-color: var(--border-color); border-radius: 2px; }
        .tracker-progress { height: 100%; background-color: var(--brand-primary); border-radius: 2px; transition: width 0.5s ease-in-out; }
        .tracker-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 80px; position: relative; z-index: 1; }
        .tracker-icon-container { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 20px; }
        .tracker-step.active .tracker-icon-container { border-color: var(--brand-primary); background-color: var(--brand-primary); color: var(--bg-primary); transform: scale(1.1); }
        .tracker-label { margin-top: 8px; font-size: 10px; font-weight: 600; transition: color 0.3s ease; }
        .tracker-step.active .tracker-label { color: var(--brand-primary); }

        /* Menu/Cart Controls */
        .add-to-cart-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); color: var(--brand-primary); border: 2px solid var(--border-color); font-size: 24px; font-weight: 600; line-height: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .add-to-cart-btn:hover { transform: scale(1.1); background-color: var(--brand-primary); color: var(--bg-primary); border-color: var(--brand-primary); }
        .quantity-control { display: flex; align-items: center; justify-content: space-between; background-color: var(--brand-primary); color: var(--bg-primary); border-radius: 9999px; font-weight: 600; overflow: hidden; width: 100px; height: 40px; user-select: none; }
        .quantity-control button { width: 34px; height: 100%; font-size: 20px; line-height: 1; transition: background-color 0.2s ease; }
        .quantity-control button:hover { background-color: rgba(0,0,0,0.1); }
        .quantity-control span { font-size: 16px; }

        /* Loyalty Slider */
        #loyalty-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 4px; }
        #loyalty-slider:hover { opacity: 1; }
        #loyalty-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--brand-primary); cursor: pointer; border-radius: 50%; }
        #loyalty-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--brand-primary); cursor: pointer; border-radius: 50%; border: none; }

        /* Social Card Gradient (used for visual appeal) */
        .social-card-gradient {
            background: radial-gradient(circle at 30% 107%, #FCD34D 0%, #F59E0B 45%, #DB2777 60%, #E94C8F 90%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

    </style>
</head>
<body data-theme="bulb">

    <!-- Splash Screen with Brand Logo -->
    <div id="splash-screen" class="fixed inset-0 bg-primary flex flex-col items-center justify-center z-[100]">
        <!-- Bulb Logo -->
        <div class="brand-logo text-7xl mb-4" style="color: var(--brand-primary);">üí°</div>
        <h1 class="text-3xl font-bold brand-text">BULB CAFE</h1>
    </div>

    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto">
            <div id="main-interface" class="hidden">
                <!-- Page Header (Sticky) -->
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-16 px-4 flex justify-between items-center border-b border-custom"></header>
                <!-- Page Content Area -->
                <div id="page-content"></div>
            </div>
            <!-- Footer Spacer -->
            <div class="h-20 flex-shrink-0"></div>
        </main>
        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-16 z-30 hidden"></nav>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed right-4 py-3 px-5 rounded-lg shadow-xl z-50 transition-all duration-300" style="background-color: var(--brand-primary); color: var(--bg-primary); bottom: 80px;">
        <p id="toast-message"></p>
    </div>

<!-- Load Supabase as a standard script before the module script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
    
    // Accessing createClient from the global window.supabase object.
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    }
    window.addEventListener('resize', setAppHeight);
    setAppHeight();

    // --- SUPABASE CONFIG (Using new keys) ---
    const SUPABASE_URL = 'https://vrvlvvlfzbdqwfsdlrkv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZydmx2dmxmemJkcXdmc2Rscmt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NzI2NzAsImV4cCI6MjA3NzU0ODY3MH0.yYnxeipLuO0DlTvGITI5ajHDeoWZ80N2PS3rPhuOyp8';
    
    // Check for the global variable exposed by the CDN
    const createClient = window.supabase ? window.supabase.createClient : null;
    let supabase = null;
    
    // Initialize Supabase only if createClient is found
    if (createClient) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("CRITICAL: Supabase client library not found on window.supabase. App cannot function.");
        document.addEventListener('DOMContentLoaded', () => {
             $('#splash-screen').innerHTML = `<div class="text-white text-center p-4">Error loading data components. Check Console.</div>`;
             $('#splash-screen').style.backgroundColor = '#FF0000';
        });
    }

    const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'more'];

    // --- STATIC DATA ---
    const STATIC_DATA = {
        // Placeholder IDs (These are just for structure and won't filter out items incorrectly now)
        bestSellers: [1, 2, 3, 4], 
        captionIdeas: {
            // UPDATED social handles
            cafe_vibes: [ "Fueling my day with the best coffee @a_bulbcafejaipur! üí°‚òïÔ∏è", "Cozy corners and great beans at Bulb Cafe. #CafeVibes" ],
            thali_time: [ "Feast mode ON! Enjoying the delicious thali at Gulabi Thali. üçΩÔ∏èüíñ #IndianFood", "Nothing beats a traditional thali! @gulabithali_thecloudkitchen." ],
            friends: [ "Great food and great company! Cheers from Bulb Cafe. üéâ", "Lunch plans sorted! @a_bulbcafejaipur" ]
        }
    };
    
    // --- SOUND EFFECTS ---
    const sound = {
        audioContext: null,
        init() {
            if (this.audioContext) return;
            try { this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
            catch (e) { console.error("Web Audio API is not supported."); }
        },
        play(type) {
            if (!this.audioContext) return;
            const o = this.audioContext.createOscillator(), g = this.audioContext.createGain();
            o.connect(g); g.connect(this.audioContext.destination); g.gain.setValueAtTime(0, this.audioContext.currentTime);
            const sounds = {
                click: { type: 'sine', freq: 900, gain: 0.1, len: 0.05 }, // Higher pitch for "Bulb" effect
                add_to_cart: { type: 'sine', freq: 700, gain: 0.2, len: 0.15 },
                success: { type: 'sine', freq: 523, gain: 0.3, len: 0.2, secondFreq: 659 },
                win: { type: 'sine', freq: 587, gain: 0.4, len: 0.3, secondFreq: 880 },
                draw: { type: 'sawtooth', freq: 220, gain: 0.1, len: 0.1 },
            };
            const s = sounds[type]; if (!s) return;
            o.type = s.type; o.frequency.setValueAtTime(s.freq, this.audioContext.currentTime);
            g.gain.linearRampToValueAtTime(s.gain, this.audioContext.currentTime + 0.01);
            if (s.secondFreq) { o.frequency.setValueAtTime(s.secondFreq, this.audioContext.currentTime + (s.len / 2)); }
            g.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + s.len);
            o.start(this.audioContext.currentTime); o.stop(this.audioContext.currentTime + s.len);
        }
    };


    // --- APP LOGIC ---
    const app = {
        state: {
            currentPage: 'home',
            cart: [],
            activeOrder: null,
            tableNumber: null,
            user: null,
            customerProfile: null,
            theme: localStorage.getItem('brand-theme') || 'bulb', // Default to Bulb brand theme
            menuData: [],
            allMenuItems: [],
            appSettings: {},
            orderSubscription: null,
            currentMenuCategory: null,
            searchQuery: '',
            searchResults: [],
            pointsToRedeem: 0,
        },

        async init() {
            document.body.addEventListener('click', () => sound.init(), { once: true });
            if (!supabase) {
                console.error("Supabase failed to initialize. Cannot start app.");
                return; 
            }

            const initialHash = location.hash.substring(1);
            if (PAGES.includes(initialHash)) {
                 this.state.currentPage = initialHash;
            } else {
                 this.state.currentPage = 'home';
                 location.hash = 'home';
            }
            window.addEventListener('popstate', this.handleHardwareBack.bind(this));

            this.startAppFlow();
        },

        async startAppFlow() {
            this.applyTheme();
            $('#splash-screen').classList.remove('hidden');
            this.getTableNumberFromURL();

            try {
                // 1. ANONYMOUS SIGN-IN
                let session = null;
                try {
                    const { data } = await supabase.auth.getSession();
                    session = data.session;
                } catch(e) { console.error("Session check failed:", e); }
                
                this.state.user = session?.user;
                if (!this.state.user) {
                    const { data: signInData, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                        console.error("Anonymous sign-in failed:", error);
                        throw new Error(`Auth failed: ${error.message}`);
                    }
                    this.state.user = signInData.user;
                }

                // 2. FETCH OR CREATE PROFILE
                await this.fetchCustomerProfile();
                
                // 3. LOAD REMAINING DATA
                await Promise.all([ this.fetchMenuData(), this.fetchAppSettings() ]);

                // 4. START UI
                $('#splash-screen').style.display = 'none';
                $('#app').classList.remove('hidden');
                $('#app').classList.add('flex');

                // FIX: Check if name is default 'Guest' or phone is missing to trigger onboarding
                if (!this.state.customerProfile || this.state.customerProfile.name === 'Guest' || !this.state.customerProfile.whatsapp_number) {
                     this.showOnboardingModal();
                } else if (this.state.tableNumber) {
                    this.startSession();
                } else {
                    this.showTableNumberModal();
                }

            } catch (error) {
                console.error("CRITICAL: App Initialization failed.", error);
                $('#splash-screen').innerHTML = `<div class="text-primary text-center p-4">Could not load app: ${error.message}</div>`;
            }
        },

        getTableNumberFromURL() {
            const params = new URLSearchParams(window.location.search);
            const tableNum = params.get('table');
            if (tableNum && !isNaN(parseInt(tableNum))) this.state.tableNumber = parseInt(tableNum);
        },

        async fetchCustomerProfile() {
            if (!this.state.user) return;
            const userId = this.state.user.id;

            try {
                const { data, error } = await supabase.from('customers')
                    .select('*, loyalty_points')
                    .eq('id', userId)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // No profile found for this auth.uid(), create one.
                    return this.createUserProfile(userId);
                }
                
                if (error) throw error;
                
                if (data) {
                    // Profile found
                    data.loyalty_points = data.loyalty_points || 0;
                    this.state.customerProfile = data;
                    return data;
                }
                
                // Fallback just in case, though 'PGRST116' should handle the "not found" case.
                return this.createUserProfile(userId);

            } catch (error) {
                console.error('Error fetching/creating profile:', error.message);
                ui.showToast('Could not load user profile.');
                // Create a local fallback profile to avoid app crash
                this.state.customerProfile = { id: userId, name: 'Guest', loyalty_points: 0, whatsapp_number: null };
            }
        },
        
        async createUserProfile(userId) {
            try {
                // Create a new user with the default name 'Guest'
                const newProfile = { id: userId, name: 'Guest', loyalty_points: 0, whatsapp_number: null };
                const { data, error } = await supabase
                    .from('customers')
                    .insert(newProfile)
                    .select('*, loyalty_points') // Select loyalty_points
                    .single();
                
                if (error) throw error;
                
                // Ensure loyalty_points is set, even if DB returns null
                data.loyalty_points = data.loyalty_points || 0;
                this.state.customerProfile = data;
                return data;
                
            } catch (error) {
                // Handle race condition where profile was created by another process
                if (error.code === '23505') { // Unique violation
                    console.warn("Race condition: Profile already exists. Fetching.");
                    return this.fetchCustomerProfile(); // Re-fetch the profile
                }
                console.error("Error creating profile:", error.message);
                throw new Error(`Profile creation failed: ${error.message}`);
            }
        },

        async fetchMenuData() {
            try {
                const { data, error } = await supabase.from('products').select('*').order('id');
                if (error) throw error;

                this.state.allMenuItems = data.filter(i => i.is_available);

                const groupedMenu = data.reduce((acc, item) => {
                    if (!item.is_available) return acc;
                    const categoryName = item.category || 'Uncategorized';
                    let category = acc.find(c => c.category === categoryName);
                    if (!category) {
                        category = { category: categoryName, items: [] };
                        acc.push(category);
                    }
                    category.items.push(item);
                    return acc;
                }, []);

                this.state.menuData = groupedMenu;

            } catch (error) {
                console.error('Error fetching menu data:', error);
                ui.showToast('Could not load the menu: ' + error.message);
                this.state.menuData = [];
                this.state.allMenuItems = [];
            }
        },

        async fetchAppSettings() {
            try {
                const { data, error } = await supabase.from('app_settings').select('key, value');
                if (error) throw error;
                this.state.appSettings = data.reduce((acc, { key, value }) => ({ ...acc, [key]: value }), {});
            } catch (error) { console.error('Error fetching app settings:', error); }
        },

        showOnboardingModal(){
            const tableInputHTML = !this.state.tableNumber
                ? `<input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>`
                : '';
            
            // Use profile data, but clear 'Guest'
            const currentName = this.state.customerProfile?.name === 'Guest' ? '' : this.state.customerProfile?.name;
            const currentPhone = this.state.customerProfile?.whatsapp_number || '';

            ui.showModal('onboarding-modal', `
                <h2 class="text-2xl font-bold text-primary mb-2">Welcome to Bulb!</h2><p class="text-secondary mb-6">A few details to get you started.</p>
                <div class="space-y-4">
                    <input type="text" id="user-name-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Name" required value="${currentName || ''}">
                    <input type="tel" id="mobile-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Mobile Number (for Loyalty Points)" required value="${currentPhone || ''}">
                    ${tableInputHTML}
                </div>
                <button onclick="app.completeOnboarding()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">Let's Go</button>
            `);
        },

        async completeOnboarding(){
            const name = $('#user-name-input').value.trim();
            const phone = $('#mobile-number-input').value.trim();
            let tableNumber = this.state.tableNumber;

            if (!tableNumber) {
                 const tableInput = $('#table-number-input');
                 if (!tableInput || !tableInput.value) return ui.showToast("Please enter your table number.");
                 tableNumber = parseInt(tableInput.value);
            }
            if (!name) return ui.showToast("Please enter your name.");
            if (!phone || !/^\d{10}$/.test(phone.replace(/\D/g,''))) return ui.showToast("Please enter a valid 10-digit mobile number for loyalty points.");
            const cleanPhone = phone.replace(/\D/g,'');

            try {
                // User is already authenticated (anonymously). We are just UPDATING their profile.
                const { data: updatedProfile, error } = await supabase
                    .from('customers')
                    .update({
                        name: name,
                        whatsapp_number: cleanPhone
                    })
                    .eq('id', this.state.user.id) // Update the record matching the auth user's ID
                    .select('*, loyalty_points')
                    .single();

                if (error) {
                    // Handle potential error where phone number is already in use by another account
                    if (error.code === '23505') { // unique_violation
                        ui.showToast('This phone number is already linked to another account.');
                        return; // Stop execution
                    }
                    throw error; // Throw other errors
                }
                
                // Update local state
                updatedProfile.loyalty_points = updatedProfile.loyalty_points || 0;
                this.state.customerProfile = updatedProfile;
                this.state.tableNumber = tableNumber;
                
                // Call startSession/showMainInterface before closing modal
                await this.startSession();
                ui.closeModal('onboarding-modal');
                this.navigateTo('home', false); // Ensure UI updates

            } catch (error) {
                console.error("Onboarding Update Error:", error);
                ui.showToast(`Could not save profile: ${error.message}`);
            }
        },


        showTableNumberModal() {
            ui.showModal('table-number-modal', `
                <h2 class="text-2xl font-bold text-primary mb-2">Welcome back, ${this.state.customerProfile.name}!</h2>
                <p class="text-secondary mb-6">Please enter your table number for today's visit.</p>
                <input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>
                <button onclick="app.completeTableNumberEntry()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">Continue</button>
            `);
        },

        completeTableNumberEntry() {
            const tableNumber = $('#table-number-input').value;
            if (!tableNumber) return ui.showToast("Please enter your table number.");
            this.state.tableNumber = parseInt(tableNumber);
            this.startSession();
            ui.closeModal('table-number-modal');
            this.navigateTo('home', false);
        },

        async startSession() {
            await this.fetchActiveOrder();
            this.showMainInterface();
        },

        showMainInterface(){
            $('#main-interface').classList.remove('hidden');
            $('#bottom-nav').classList.remove('hidden');
            ui.renderBottomNav();
            // Initial navigation is handled by the caller (onboarding/table entry)
            // or by init() when loading from hash
            this.navigateTo(this.state.currentPage, false);
        },

        navigateTo(page, pushToHistory = true){
             if (!this.state.customerProfile) return;
             sound.play('click');

             const currentHash = location.hash.substring(1);
             
             // Check if we are already on the target page (ignoring initial load false)
             if (currentHash === page && pushToHistory) return;

             // Only update browser history if it's a new page or we're explicitly pushing state
             if (pushToHistory) {
                location.hash = page;
             } else if (currentHash !== page) {
                // If not pushing history, just replace the current state to reflect the new page
                history.replaceState(null, '', '#' + page);
             }
             
             this.state.currentPage = page;
             ui.renderHeader(page);
             ui.renderPageContent(page);
             ui.updateActiveNav(page);
        },

        handleHardwareBack(event) {
             const currentHash = location.hash.substring(1);
             const openModal = $('#modal-container').children[0];

             // 1. Handle Modal Back
             if (openModal) {
                ui.closeModal(openModal.id);
                event.preventDefault();
                // Replace hash to current page after closing modal
                history.replaceState(null, '', '#' + this.state.currentPage);
                return;
             }
             
             // 2. Handle Page Back (Prevent double back/exit from home)
             if (this.state.currentPage === 'home') {
                 // Already on home, allow default back behavior (or do nothing)
                 return;
             }

             // If the current hash doesn't match the state (e.g., user used browser back/forward)
             if (PAGES.includes(currentHash) && currentHash !== this.state.currentPage) {
                 this.navigateTo(currentHash, false); // Sync state to the hash
                 event.preventDefault();
             }
             // Navigate back to home
             else if (this.state.currentPage !== 'home') {
                 event.preventDefault(); 
                 this.navigateTo('home');
             }
        },

        applyTheme(){ document.body.dataset.theme = this.state.theme; },
        toggleTheme(t){ ui.closeModal('brand-switcher-modal'); this.state.theme = t; localStorage.setItem('brand-theme', t); this.applyTheme(); this.refreshPage(); },

        addOrUpdateCart(itemId, quantityChange) {
            const item = this.state.allMenuItems.find(i => i.id === itemId);
            if (item && item.brand?.toLowerCase() === 'gulabi thali') {
                return ui.showToast("Gulabi Thali is view-only. Please select Bulb Cafe items.", 'error');
            }

            sound.play('click');
            if (!item) return;

            let cartItem = this.state.cart.find(i => i.id === itemId);
            let newQuantity = (cartItem ? cartItem.quantity : 0) + quantityChange;

            if (newQuantity <= 0) {
                this.state.cart = this.state.cart.filter(i => i.id !== itemId);
            } else {
                if (cartItem) {
                    cartItem.quantity = newQuantity;
                } else {
                    this.state.cart.push({ cartId: Date.now(), ...item, quantity: newQuantity });
                }
                if (quantityChange > 0) sound.play('add_to_cart');
            }
            this.state.pointsToRedeem = 0; // Reset points on cart change
            this.refreshPage();
        },

        setCartItemQuantity(itemId, quantity) {
            const item = this.state.allMenuItems.find(i => i.id === itemId);
            
            if (item && item.brand?.toLowerCase() === 'gulabi thali' && quantity > 0) {
                 ui.closeModal('item-detail-modal');
                 return ui.showToast("Gulabi Thali is view-only. Please select Bulb Cafe items.", 'error');
            }

            if (!item) return;

            if (quantity <= 0) {
                this.state.cart = this.state.cart.filter(i => i.id !== itemId);
            } else {
                let cartItem = this.state.cart.find(i => i.id === itemId);
                if (cartItem) {
                    cartItem.quantity = quantity;
                } else {
                    this.state.cart.push({ cartId: Date.now(), ...item, quantity: quantity });
                }
            }
            if(quantity > 0) {
                sound.play('add_to_cart');
                ui.showToast('Cart updated!');
            }
            this.state.pointsToRedeem = 0; // Reset points on quantity change
            ui.closeModal('item-detail-modal');
            this.refreshPage();
        },

        performSearch(query) {
             const searchContainer = $('#search-results-container');
             const menuContainer = $('#menu-items');
             const tabsContainer = $('#category-tabs-container');
             const activeBrand = this.state.theme === 'bulb' ? 'Bulb Cafe' : 'Gulabi Thali';
             this.state.searchQuery = query.toLowerCase().trim();

             if (this.state.searchQuery.length > 1) {
                if (searchContainer) searchContainer.classList.remove('hidden');
                if (menuContainer) menuContainer.classList.add('hidden');
                if (tabsContainer) tabsContainer.classList.add('hidden');
                
                this.state.searchResults = this.state.allMenuItems.filter(item => {
                    // Safe check for brand and null properties
                    const itemBrand = item.brand?.toLowerCase();
                    if (itemBrand !== activeBrand.toLowerCase()) return false;
                    
                    const itemName = item.name?.toLowerCase() || '';
                    const itemDesc = item.description?.toLowerCase() || '';
                    
                    return itemName.includes(this.state.searchQuery) || itemDesc.includes(this.state.searchQuery);
                });
                ui.renderMenuItems(this.state.searchResults, 'search-results-container');
             } else {
                if (searchContainer) searchContainer.classList.add('hidden');
                if (menuContainer) menuContainer.classList.remove('hidden');
                if (tabsContainer) tabsContainer.classList.remove('hidden');
                this.state.searchResults = [];
                
                // Go back to the currently selected category when search is cleared
                this.filterMenuByCategory(this.state.currentMenuCategory || 'All Menu', null);
             }
        },

        calculateCartTotal(){
            const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
            const availablePoints = this.state.customerProfile?.loyalty_points || 0;

            // 1. Calculate max discount
            const redeemablePercentage = 0.70;
            const redeemablePoints = Math.floor(availablePoints * redeemablePercentage);

            // --- FIX START ---
            // Calculate max redeemable based on subtotal (1 point = 1 rupee)
            const maxRedeemableBySubtotal = Math.floor(subtotal);
            
            // The actual max redeemable is the minimum of what they have (70%) and the order total
            const maxRedeemableForOrder = Math.min(redeemablePoints, maxRedeemableBySubtotal);
            // --- FIX END ---

            // 2. Clamp current discount
            const actualPointsToRedeem = Math.min(this.state.pointsToRedeem, maxRedeemableForOrder); // This line is now correct
            const discountAmount = actualPointsToRedeem;

            // 3. Update state if clamped
            if (this.state.pointsToRedeem !== actualPointsToRedeem) {
                this.state.pointsToRedeem = actualPointsToRedeem;
            }
            
            // 4. Calculate final totals WITH GST
            const discountedSubtotal = subtotal - discountAmount;
            const gst = discountedSubtotal * 0.05; // 5% GST
            const finalTotal = discountedSubtotal + gst;

            return { 
                subtotal, 
                discountAmount, 
                discountedSubtotal, 
                gst, 
                finalTotal: Math.max(0, finalTotal),
                maxRedeemableForOrder 
            };
        },

        updatePointsToRedeem(points) {
            this.state.pointsToRedeem = parseInt(points);
            ui.updateCartSummary();
        },

        refreshPage(){
            this.applyTheme();
            ui.refreshCartDependentUI();
            if (PAGES.includes(this.state.currentPage)) {
                ui.renderPageContent(this.state.currentPage);
            }
        },

        async placeOrder(paymentMethod, btnElement){
            if (!supabase) return ui.showToast("Order failed: Supabase not initialized.");
            if (this.state.cart.length === 0 || !this.state.tableNumber) return ui.showToast("Cart empty or table missing.");
            if (!this.state.customerProfile || !this.state.customerProfile.id) {
                return ui.showToast("Error: Your profile is not loaded correctly. Please refresh.");
            }

            btnElement.disabled = true; const originalBtnHTML = btnElement.innerHTML;
            btnElement.innerHTML = `<span class="flex items-center justify-center"><div class="spinner mr-2"></div> Processing...</span>`;
            
            // Disable the other button too
            const otherBtn = [...$$('.payment-btn')].find(b => b !== btnElement);
            if(otherBtn) otherBtn.disabled = true;

            const { subtotal, discountAmount, finalTotal } = this.calculateCartTotal();
            const pointsToRedeem = this.state.pointsToRedeem;

            let orderData;

            try {
                // 1. Verify Table
                const { data: tableData, error: tableError } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
                if (tableError || !tableData) throw new Error(`Table #${this.state.tableNumber} invalid or not found.`);

                // 2. Verify Points
                if (pointsToRedeem > 0) {
                    // Re-fetch profile to prevent race conditions with points
                    const { data: currentProfile, error: profileError } = await supabase.from('customers').select('loyalty_points').eq('id', this.state.customerProfile.id).single();
                    if (profileError || !currentProfile || currentProfile.loyalty_points < pointsToRedeem) {
                         throw new Error('Insufficient points. Please refresh cart.');
                    }
                }

                // 3. Calculate effective discount
                const effectiveDiscountPercent = (subtotal > 0) ? (discountAmount / subtotal) * 100 : 0;

                // 4. Create Order
                const orderPayload = {
                    customer_id: this.state.customerProfile.id,
                    table_id: tableData.id,
                    total_amount: finalTotal, // This is the final amount after discount+gst
                    discount_percentage: effectiveDiscountPercent,
                    discount_points_redeemed: pointsToRedeem,
                    discount_amount: discountAmount,
                    final_amount: finalTotal, // Field name redundancy for safety
                    payment_method: paymentMethod,
                    special_instructions: $('#special-instructions')?.value || '',
                    feedback_submitted: false
                };
                const { data: insertedOrder, error: orderError } = await supabase.from('orders').insert(orderPayload).select().single();
                if (orderError) {
                    throw new Error(`Order placement failed. ${orderError.message}`);
                }
                orderData = insertedOrder;

                // 5. Create Order Items
                const orderItems = this.state.cart.map(i => ({
                    order_id: orderData.id,
                    product_id: i.id,
                    quantity: i.quantity,
                    price_at_time_of_order: i.price
                    // product_name is now handled by a trigger in Supabase
                }));
                const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
                if (itemsError) {
                    // Rollback: Delete the main order if items fail
                    await supabase.from('orders').delete().eq('id', orderData.id);
                    throw new Error(`Order items failed. ${itemsError.message}`);
                }

                // 6. Handle Loyalty Points Transactions
                try {
                    // Redeem points
                    if (pointsToRedeem > 0) {
                         const { error: redeemError } = await supabase.rpc('redeem_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_redeem: pointsToRedeem });
                         if(redeemError) throw new Error(`Redeem RPC failed: ${redeemError.message}`);
                         this.state.customerProfile.loyalty_points -= pointsToRedeem;
                    }

                    // Earn points
                    // NEW: Earn 10% in points if subtotal is over 350
                    const pointsThreshold = 350;
                    let pointsEarned = 0;
                    if (subtotal >= pointsThreshold) {
                        pointsEarned = Math.floor(subtotal * 0.10);
                    }
                    
                    if (pointsEarned > 0) {
                         const { error: earnError } = await supabase.rpc('increment_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_add: pointsEarned });
                         if(earnError) throw new Error(`Earn RPC failed: ${earnError.message}`);
                         this.state.customerProfile.loyalty_points += pointsEarned;
                    }
                } catch (pointsError) {
                    // Log error, but don't fail the whole order
                    console.warn("Points transaction failed after order success:", pointsError.message);
                    ui.showToast("Order placed, but points update failed.");
                    await this.fetchCustomerProfile(); // Re-sync profile
                }

                // 7. Success Flow
                ui.closeModal('payment-modal');
                this.state.activeOrder = orderData;
                this.listenToOrderUpdates(orderData.id); // Start listening
                this.state.cart = []; // Clear cart
                this.state.pointsToRedeem = 0; // Reset points
                this.refreshPage(); // Update UI
                sound.play('success');
                this.navigateTo('cart'); // Navigate to tracking page

            } catch (error) {
                ui.showToast(`Order failed: ${error.message}`);
                // Re-enable buttons on failure
                btnElement.disabled = false;
                btnElement.innerHTML = originalBtnHTML;
                if(otherBtn) otherBtn.disabled = false;
                
                // If error was points/profile related, re-sync
                if (error.message.includes('points') || error.message.includes('profile')) {
                    await this.fetchCustomerProfile();
                    this.state.pointsToRedeem = 0;
                    this.refreshPage();
                }
            }
        },


        async fetchActiveOrder(){
            if (!this.state.user || !this.state.customerProfile?.id) return;
            const { data, error } = await supabase.from('orders')
                .select(`*, order_items(*, products(name)), feedback_submitted`)
                .eq('customer_id', this.state.customerProfile.id)
                .in('status', ['received', 'preparing'])
                .order('created_at', { ascending: false })
                .limit(1).single();

            if (error && error.code !== 'PGRST116') console.error('Fetch active order error:', error);
            this.state.activeOrder = data || null;
            if (this.state.activeOrder) {
                this.listenToOrderUpdates(this.state.activeOrder.id);
            }
        },

        listenToOrderUpdates(orderId){
            if (this.state.orderSubscription) {
                supabase.removeChannel(this.state.orderSubscription);
                this.state.orderSubscription = null;
            }
            this.state.orderSubscription = supabase.channel(`public:orders:id=eq.${orderId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, payload => {
                    if (!this.state.activeOrder || this.state.activeOrder.id !== payload.new.id) return;

                    const updatedOrder = payload.new;
                    let uiNeedsRefresh = false;

                    if (updatedOrder.status !== this.state.activeOrder.status) {
                        ui.showToast(`Your order is now: ${updatedOrder.status}`);
                        this.state.activeOrder.status = updatedOrder.status;
                        uiNeedsRefresh = true;
                    }
                    if ('feedback_submitted' in updatedOrder && updatedOrder.feedback_submitted !== this.state.activeOrder.feedback_submitted) {
                        this.state.activeOrder.feedback_submitted = updatedOrder.feedback_submitted;
                        uiNeedsRefresh = true;
                    }

                    if (['delivered', 'cancelled'].includes(updatedOrder.status)) {
                        supabase.removeChannel(this.state.orderSubscription);
                        this.state.orderSubscription = null;

                        // FIX: Redirect to Google Review
                        if (updatedOrder.status === 'delivered' && !updatedOrder.feedback_submitted) {
                             ui.showModal('review-modal', `
                                <div class="text-center">
                                    <span class="text-3xl">‚≠ê</span>
                                    <h2 class="text-2xl font-bold mt-4">Order Delivered!</h2>
                                    <p class="text-secondary my-2">Thank you for your order! We'd love to hear your feedback.</p>
                                    <button onclick="app.handleReviewRedirect('${orderId}')" class="w-full mt-4 brand-bg font-semibold py-3 rounded-lg">Leave a Review on Google</button>
                                    <button onclick="app.handleReviewSkip('${orderId}')" class="w-full mt-2 bg-secondary py-3 rounded-lg">No Thanks</button>
                                </div>`);
                        } else if (updatedOrder.status === 'cancelled') {
                            ui.showToast('Your order has been cancelled.');
                        }
                        this.state.activeOrder = null;
                        uiNeedsRefresh = true;
                    }
                    if(uiNeedsRefresh) {
                         this.refreshPage();
                    }
                }).subscribe();
        },

        // NEW: Helper function to mark feedback as submitted
        async markFeedbackAsSubmitted(orderId) {
            try {
                await supabase.from('orders')
                    .update({ feedback_submitted: true })
                    .eq('id', orderId);
            } catch (error) {
                console.warn("Could not mark feedback as submitted:", error);
            }
        },
        
        // NEW: Function to handle Google Review redirect
        handleReviewRedirect(orderId) {
            // This link is for "Bulb Cafe, Jaipur"
            const reviewUrl = 'https://g.page/r/CbzP-Vv-pS4GEBM/review'; 
            window.open(reviewUrl, '_blank');
            this.markFeedbackAsSubmitted(orderId);
            ui.closeModal('review-modal');
        },

        // NEW: Function to handle skipping the review
        handleReviewSkip(orderId) {
            this.markFeedbackAsSubmitted(orderId);
            ui.closeModal('review-modal');
        },

        // OLD submitFeedback function is no longer needed
        /* async submitFeedback(orderId){ ... } */


        copyCaption(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) ui.showToast('Copied!');
                else ui.showToast('Copy failed.');
            } catch (err) {
                ui.showToast('Copy failed.');
            }
            document.body.removeChild(textArea);
        },

        async sendStaffCall(type) {
            // FIX: This now sends a real request to the 'staff_calls' table
            if (!this.state.tableNumber) {
                return ui.showToast("Please enter table number first.");
            }
            
            try {
                const { error } = await supabase
                    .from('staff_calls')
                    .insert({
                        table_number: this.state.tableNumber,
                        call_type: type,
                        status: 'pending'
                    });
                
                if (error) throw error;
                
                ui.showToast('Staff has been notified!');
                sound.play('success');

            } catch (error) {
                console.error("Error calling staff:", error);
                ui.showToast('Could not send call. Please alert staff manually.');
            }
        }
    };

    // --- UI RENDERING ---
    const ui = {
        showModal(id, content) {
            location.hash = id;
            const existingModal = $(`#${id}`);
            if (existingModal) existingModal.remove();

            const modalHTML = `
                <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50 p-4">
                    <div class="modal-content bg-primary rounded-t-2xl shadow-xl p-6 w-full max-w-lg">
                        ${content}
                    </div>
                </div>`;
            $('#modal-container').insertAdjacentHTML('beforeend', modalHTML);
        },

        closeModal(id) {
            const modal = $(`#${id}`);
            if (modal) modal.remove();
            
            // Check if we are closing the modal that corresponds to the current hash
            if (location.hash.substring(1) === id) {
                // Use history.replaceState to clean up the URL without triggering popstate
                history.replaceState(null, '', '#' + app.state.currentPage);
                
                // Call navigateTo with pushToHistory=false to ensure UI update without history change
                app.navigateTo(app.state.currentPage, false);
            }
        },

        showToast(message, duration = 3000) {
            const toast = $('#toast'), p = $('#toast-message');
            p.textContent = message;
            toast.classList.remove('hidden');
            toast.style.backgroundColor = 'var(--brand-primary)';
            toast.style.color = 'var(--bg-primary)';

            // Simple fade in/out, avoids complex keyframes
            toast.style.opacity = 1;
            toast.style.transition = 'opacity 0.5s ease';

            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => {
                   toast.classList.add('hidden');
                }, 500);
            }, duration - 500);
        },

        renderHeader(page) {
            const header = $('#page-header');
            const currentBrandName = app.state.theme === 'bulb' ? 'BULB CAFE' : 'GULABI THALI';
            const pageConfigs = {
                home: { title: currentBrandName},
                order: { title: 'Menu'},
                cart: { title: app.state.activeOrder ? 'Track Order' : 'My Cart'},
                social: { title: 'Social'},
                cowork: { title: 'Gulabi Thali Kitchen'},
                more: { title: 'More Options'}
            };
            const config = pageConfigs[page] || { title: currentBrandName };
            header.innerHTML = `
                <div class="flex items-center space-x-2">
                    <h1 class="text-2xl font-bold brand-text">${config.title}</h1>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-primary text-sm">${app.state.customerProfile?.name || 'Guest'}</p>
                    <p class="text-xs text-secondary">Table #${app.state.tableNumber || 'N/A'}</p>
                </div>`;
        },

        renderPageContent(page) {
            const content = $('#page-content');
            content.innerHTML = '';
            const renderers = {
                home: this.renderHomePage,
                order: this.renderMenuPage,
                cart: this.renderCartPage,
                social: this.renderSocialPage,
                cowork: this.renderGulabiThaliKitchenPage, // Renamed renderer
                more: this.renderMorePage,
            };
            content.classList.remove('fade-in');
            void content.offsetWidth;
            content.classList.add('fade-in');
            renderers[page]?.call(this);
        },

        renderBottomNav(){
            const icons = {
                home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
                order: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
                cart: `<div class="relative"><svg id="cart-icon-svg" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span></div>`,
                social: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`,
                cowork: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2h-4m-12 0h4m-4 0a2 2 0 00-2 2v2a2 2 0 002 2h12a2 2 0 002-2v-2a2 2 0 00-2-2h-4m-6-6V4a2 2 0 012-2h4a2 2 0 012 2v4" /></svg>`,
                more: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>`
            };

            const labels = { home: 'Home', order: 'Menu', cart: 'Cart', social: 'Social', cowork: 'Kitchen', more: 'More' };
            $('#bottom-nav').innerHTML = PAGES.map(p => `<button onclick="app.navigateTo('${p}')" class="nav-item flex-1 p-2 text-secondary" data-page="${p}">${icons[p]}<span id="${p}-tab-label" class="text-xs font-bold capitalize">${labels[p]}</span></button>`).join('');
        },

        updateActiveNav(page) {
            const cartLabel = $('#cart-tab-label'), cartIcon = $('#cart-icon-svg');
            if (app.state.activeOrder) {
                cartLabel.textContent = 'Track';
                cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />`;
            } else {
                cartLabel.textContent = 'Cart';
                cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />`;
            }
            $$('.nav-item').forEach(item => {
                const isActive = item.dataset.page === page;
                item.classList.toggle('brand-text', isActive);
                item.classList.toggle('text-secondary', !isActive);
                item.style.transform = isActive ? 'scale(1.1)' : 'scale(1)';
            });
            this.refreshCartDependentUI();
        },

        refreshCartDependentUI() {
            const el = $('#cart-count');
            const total = app.state.cart.reduce((s, i) => s + i.quantity, 0);
            if (total > 0 && !app.state.activeOrder) {
                el.textContent = total;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        },

        renderHomePage(){
            const currentBrandName = app.state.theme === 'bulb' ? 'BULB CAFE' : 'GULABI THALI';
            const switchTheme = app.state.theme === 'bulb' ? 'gulabi' : 'bulb';
            const switchBrandName = switchTheme === 'bulb' ? 'BULB CAFE' : 'GULABI THALI';
            const switchButtonColor = switchTheme === 'bulb' ? 'bg-yellow-500' : 'bg-pink-500';

            const activeOrderHTML = app.state.activeOrder ? `<div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center"> <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2> <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p> <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button> </div>` : '';

            $('#page-content').innerHTML = `
                <div class="space-y-6">
                    <!-- Video Hero Section -->
                    <div class="relative h-48 overflow-hidden rounded-b-2xl">
                        <video src="https://vrvlvvlfzbdqwfsdlrkv.supabase.co/storage/v1/object/public/video/WhatsApp%20Video%202025-11-01%20at%2020.52.47_2473f7b8.mp4" autoplay loop muted playsinline preload="metadata" class="absolute top-1/2 left-1/2 w-full h-full object-cover -translate-x-1/2 -translate-y-1/2"></video>
                        <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                            <h1 class="text-4xl font-bold font-brand">${currentBrandName}</h1>
                        </div>
                    </div>
                    <div class="p-4 space-y-8">
                        ${activeOrderHTML ? `<div class="mt-8">${activeOrderHTML}</div>` : ''}

                        <!-- Brand Switcher -->
                        <div class="mt-8 text-center">
                            <h2 class="text-2xl font-bold text-primary mb-4 px-1">You are viewing the ${currentBrandName} menu.</h2>
                            <button onclick="app.toggleTheme('${switchTheme}')" class="w-full ${switchButtonColor} text-white font-extrabold py-4 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.02] text-lg">
                                CLICK TO SWITCH TO ${switchBrandName}
                            </button>
                        </div>
                        
                        <!-- Loyalty Program Info -->
                        <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom text-center">
                            <span class="text-4xl">ü™ô</span>
                            <h2 class="text-2xl font-bold text-primary mt-3 mb-2">Join Our Loyalty Program!</h2>
                            <p class="text-secondary">Earn <span class="font-bold text-primary">10% back in Loyalty Points</span> on all orders over ‚Çπ350. Redeem them for discounts on your next visit!</p>
                            <button onclick="app.navigateTo('more')" class="mt-4 text-sm font-semibold brand-text hover:underline">Learn More &rarr;</button>
                        </div>

                        <!-- Call Staff - Simplified -->
                        <div class="grid grid-cols-1 gap-4">
                            <button onclick="ui.showCallStaffModal()" class="bg-secondary rounded-xl p-4 text-center flex flex-col items-center justify-center h-28 border border-custom"><span class="text-3xl">üõé</span><p class="font-semibold mt-2 text-primary">Call Assistance</p></button>
                        </div>

                    </div>
                </div>`;
        },

        renderMenuPage(){
            const content = $('#page-content');
            const activeBrand = app.state.theme === 'bulb' ? 'Bulb Cafe' : 'Gulabi Thali';

            if (app.state.allMenuItems.length === 0) {
                content.innerHTML = `<div class="p-4 text-center text-secondary">Loading menu...</div>`;
                return;
            }
            
            // Filter products by active brand
            const brandItems = app.state.allMenuItems.filter(item => item.brand?.toLowerCase() === activeBrand.toLowerCase());

            if (brandItems.length === 0) {
                 content.innerHTML = `<p class="p-4 text-center text-secondary">No items found for this selection.</p>`;
                 return;
            }

            // Group filtered items by category for tab creation
            const categoryMap = brandItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});
            
            // Build tab list (All Menu + Categories)
            const allCategories = [{ category: 'All Menu' }, ...Object.keys(categoryMap).map(c => ({ category: c }))];

            if (!app.state.currentMenuCategory || !allCategories.some(c => c.category === app.state.currentMenuCategory)) {
                 app.state.currentMenuCategory = 'All Menu';
            }

            content.innerHTML = `
                <div id="active-order-banner" class="p-4 hidden"></div>
                <div class="p-4">
                    <input type="text" id="menu-search-input" placeholder="Search menu..." class="w-full p-3 border-2 border-custom rounded-lg bg-secondary text-primary text-lg" oninput="app.performSearch(this.value)" value="${app.state.searchQuery}">
                </div>
                <div id="category-tabs-container" class="horizontal-scroll sticky top-16 bg-primary z-10 flex space-x-4 px-4 pb-3 overflow-x-auto border-b border-custom">
                    ${allCategories.map(c => `
                        <button class="category-tab whitespace-nowrap font-semibold py-2 px-1 ${app.state.currentMenuCategory === c.category ? 'brand-text border-b-2 border-current' : 'text-secondary'}"
                                data-category="${c.category}"
                                onclick="ui.filterMenuByCategory('${c.category}', this)">
                            ${c.category}
                        </button>`).join('')}
                </div>
                <div id="menu-items" class="p-4 grid grid-cols-1 gap-4"></div>
                <div id="search-results-container" class="p-4 grid grid-cols-1 gap-4 hidden"></div>`;

            if (app.state.activeOrder) {
                $('#active-order-banner').classList.remove('hidden');
                $('#active-order-banner').innerHTML = `
                    <div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center">
                        <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2>
                        <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p>
                        <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button>
                    </div>`;
            }
            
            // Initial render call after DOM is built
            if (app.state.searchQuery.length > 1) {
                app.performSearch(app.state.searchQuery);
            } else {
                ui.filterMenuByCategory(app.state.currentMenuCategory, $(`.category-tab[data-category="${app.state.currentMenuCategory}"]`));
            }
        },

        filterMenuByCategory(category, tabElement) {
            const activeBrand = app.state.theme === 'bulb' ? 'Bulb Cafe' : 'Gulabi Thali';
            app.state.currentMenuCategory = category;
            
            // Clear search input on category switch
            const searchInput = $('#menu-search-input');
            if (searchInput) searchInput.value = '';
            app.state.searchQuery = '';

            $('#search-results-container')?.classList.add('hidden');
            $('#menu-items')?.classList.remove('hidden');
            $('#category-tabs-container')?.classList.remove('hidden');

            if (tabElement) {
                $$('.category-tab').forEach(tab => {
                    tab.classList.remove('brand-text', 'border-b-2', 'border-current');
                    tab.classList.add('text-secondary');
                });
                tabElement.classList.add('brand-text', 'border-b-2', 'border-current');
            }

            let itemsToShow = app.state.allMenuItems.filter(item => 
                (item.brand?.toLowerCase() === activeBrand.toLowerCase())
            );
            
            if (category !== 'All Menu') {
                itemsToShow = itemsToShow.filter(item => 
                    item.category?.toLowerCase() === category.toLowerCase()
                );
            }
            
            ui.renderMenuItems(itemsToShow, 'menu-items');
        },

        renderMenuItems(items, containerId) {
            const container = $(`#${containerId}`);
            if (!container) return;
            
            const isViewOnly = app.state.theme === 'gulabi';
            
            if (!items || items.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center col-span-full mt-8">${isViewOnly ? 'Gulabi Thali menu is view-only.' : 'No items found for this selection.'}</p>`;
                return;
            }
            container.innerHTML = items.map(item => {
                const cartItem = app.state.cart.find(ci => ci.id === item.id);
                const currentPrice = item.price || 0;
                
                let actionButtonHTML;

                if (isViewOnly) {
                    actionButtonHTML = `<button class="add-to-cart-btn bg-secondary text-secondary" disabled title="View Only">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.575 3.01 9.963 7.182.074.207.074.441 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.575-3.01-9.963-7.182Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                    </button>`;
                } else if (cartItem) {
                    actionButtonHTML = `<div class="quantity-control" onclick="event.stopPropagation();">
                           <button onclick="app.addOrUpdateCart(${item.id}, -1)">-</button>
                           <span>${cartItem.quantity}</span>
                           <button onclick="app.addOrUpdateCart(${item.id}, 1)">+</button>
                       </div>`;
                } else {
                    actionButtonHTML = `<button class="add-to-cart-btn" onclick="event.stopPropagation(); app.addOrUpdateCart(${item.id}, 1)">
                           +
                       </button>`;
                }

                return `
                    <div class="bg-secondary rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="ui.showItemDetailModal(${item.id})">
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex-1 pr-4">
                                <h3 class="font-semibold text-base truncate text-primary">${item.name || 'Untitled Item'}</h3>
                                <p class="font-bold text-sm text-secondary mt-1">‚Çπ${currentPrice.toFixed(2)}</p>
                            </div>
                            <div class="flex-shrink-0">
                                ${actionButtonHTML}
                            </div>
                        </div>
                    </div>`;
            }).join('');
        },

        renderCartPage() {
            const content = $('#page-content');
            if (app.state.activeOrder) this.renderOrderTracking(content);
            else if (app.state.cart.length > 0) this.renderCart(content);
            else content.innerHTML = `
                <div class="text-center p-10">
                    <h2 class="text-2xl font-bold text-primary">Your cart is empty</h2>
                    <p class="text-secondary mt-2">Add items from the menu to get started.</p>
                    <button onclick="app.navigateTo('order')" class="mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">View Menu</button>
                </div>`;
        },

        renderCart(container){
            const { subtotal, discountAmount, gst, finalTotal, maxRedeemableForOrder } = app.calculateCartTotal();
            const loyaltyPoints = app.state.customerProfile?.loyalty_points || 0;
            const currentDiscount = app.state.pointsToRedeem; 

            const pointsThreshold = 350;
            let loyaltyExplanation = `<p class="text-xs text-secondary mt-1 mb-3">Earn 10% back in points (1pt = ‚Çπ1) on orders over ‚Çπ${pointsThreshold}. You can redeem up to 70% of your available points on this order.</p>`;
            
            if (subtotal < pointsThreshold && subtotal > 0) {
                const amountNeeded = pointsThreshold - subtotal;
                const pointsToEarn = Math.floor(pointsThreshold * 0.10);
                loyaltyExplanation += `<p class="text-sm font-semibold text-primary p-3 bg-primary rounded-lg border border-custom">Add just <span class="brand-text">‚Çπ${amountNeeded.toFixed(2)}</span> more to your cart to earn ~<span class="brand-text">${pointsToEarn} points</span> on this order!</p>`;
            } else if (subtotal >= pointsThreshold) {
                 const pointsToEarn = Math.floor(subtotal * 0.10);
                 loyaltyExplanation += `<p class="text-sm font-semibold text-primary p-3 bg-green-500/10 text-green-700 rounded-lg border border-green-500/20">You will earn <span class="font-bold">${pointsToEarn} points</span> on this order!</p>`;
            }

            let loyaltySectionHTML = '';
            if (loyaltyPoints > 0 && maxRedeemableForOrder > 0) {
                loyaltySectionHTML = `
                    <div class="p-4 border-t border-b border-custom">
                        <h3 class="font-bold text-lg mb-2 text-primary">Redeem Loyalty Points</h3>
                        <p class="text-sm text-secondary mb-1">Available: ${loyaltyPoints} points</p>
                        ${loyaltyExplanation}
                        <p class="text-sm text-secondary mb-3">Redeemable (max ‚Çπ${maxRedeemableForOrder}):</p>
                        <input type="range" id="loyalty-slider" min="0" max="${maxRedeemableForOrder}" value="${app.state.pointsToRedeem}"
                               oninput="app.updatePointsToRedeem(this.value)" class="w-full h-2 rounded-lg cursor-pointer">
                        <div class="flex justify-between text-sm font-semibold mt-2">
                            <span>Redeem: <span id="points-to-redeem-display">${app.state.pointsToRedeem}</span> pts</span>
                            <span>Discount: - ‚Çπ<span id="discount-amount-display">${currentDiscount.toFixed(2)}</span></span>
                        </div>
                    </div>`;
            } else if (loyaltyPoints > 0) {
                 loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><p class="text-sm text-secondary text-center">You have ${loyaltyPoints} points.</p>${loyaltyExplanation}<p class="text-sm text-secondary text-center mt-2">Increase your order total to redeem them.</p></div>`;
            } else {
                 loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><p class="text-sm text-secondary text-center">Start earning points today!</p>${loyaltyExplanation}</div>`;
            }


            container.innerHTML = `
                <div class="p-4 space-y-3">
                    ${app.state.cart.map(i => `
                        <div class="bg-secondary p-3 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="font-bold text-primary">${i.name}</p>
                                <p class="font-semibold text-secondary text-sm">‚Çπ${(i.price * i.quantity).toFixed(2)}</p>
                            </div>
                            <div class="quantity-control" style="background-color: var(--bg-primary); color: var(--brand-primary); border: 1px solid var(--border-color);">
                                <button onclick="app.addOrUpdateCart(${i.id}, -1)">-</button>
                                <span>${i.quantity}</span>
                                <button onclick="app.addOrUpdateCart(${i.id}, 1)">+</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${loyaltySectionHTML}
                <div class="p-4"><textarea id="special-instructions" class="w-full p-3 border-custom rounded-lg bg-secondary" placeholder="Add special instructions..."></textarea></div>
                <div class="p-4 bg-primary border-t-custom sticky bottom-16">
                     <div id="cart-summary" class="mb-4 space-y-1 text-primary"></div>
                    <button id="place-order-btn" onclick="ui.showPaymentModal()" class="w-full brand-bg font-bold py-4 rounded-lg">Proceed to Payment</button>
                </div>`;
            this.updateCartSummary(); // Initial render of summary
        },

        updateCartSummary() {
            const { subtotal, discountAmount, gst, finalTotal } = app.calculateCartTotal();
            const currentDiscount = discountAmount;

            const pointsDisplay = $('#points-to-redeem-display');
            const discountDisplay = $('#discount-amount-display');
            if(pointsDisplay) pointsDisplay.textContent = currentDiscount.toFixed(0);
            if(discountDisplay) discountDisplay.textContent = currentDiscount.toFixed(2);

            const summaryDiv = $('#cart-summary');
            if (summaryDiv) {
                summaryDiv.innerHTML = `
                    <div class="flex justify-between items-center text-md">
                        <span>Subtotal</span>
                        <span>‚Çπ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-md text-green-600 ${currentDiscount > 0 ? '' : 'hidden'}">
                        <span>Loyalty Discount</span>
                        <span>- ‚Çπ${currentDiscount.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-md ${gst > 0 ? '' : 'hidden'}">
                        <span>GST (5%)</span>
                        <span>‚Çπ${gst.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold pt-1 border-t border-custom">
                        <span>To Pay</span>
                        <span>‚Çπ${finalTotal.toFixed(2)}</span>
                    </div>`;
            }
        },


        renderOrderTracking(container) {
            const order = app.state.activeOrder;
            if (!order) { container.innerHTML = ''; return; }
            const statuses = ['received', 'preparing', 'delivered'];
            const icons = { received: 'üìù', preparing: 'üç≥', delivered: 'üòä' };
            const currentIndex = statuses.indexOf(order.status);
            const progressPercentage = currentIndex >= 0 ? (currentIndex / (statuses.length - 1)) * 100 : 0;
            container.innerHTML = `
                <div class="p-6 flex flex-col items-center justify-center h-full">
                    <h2 class="text-3xl font-bold text-center capitalize">Your Order is ${order.status}!</h2>
                    <p class="text-secondary text-center mb-10">Order ID: #${order.id.slice(0,6)}</p>
                    <div class="tracker-container my-12 w-full max-w-sm">
                        <div class="tracker-line-container">
                            <div class="tracker-progress" style="width: ${progressPercentage}%"></div>
                        </div>
                        ${statuses.map((status, index) => `
                            <div class="tracker-step ${index <= currentIndex ? 'active' : ''}">
                                <div class="tracker-icon-container">${icons[status]}</div>
                                <span class="tracker-label capitalize">${status}</span>
                            </div>`).join('')}
                    </div>
                    <div class="mt-auto pt-10 text-center">
                        <p class="text-secondary mb-4">You can play a quick game while you wait!</p>
                        <button onclick="ui.showGamesModal()" class="brand-bg font-semibold py-3 px-8 rounded-lg">Play Games</button>
                    </div>
                </div>`;
        },

        renderSocialPage(){
            // UPDATED: Dynamically show correct social handle based on theme
            const isBulb = app.state.theme === 'bulb';
            const socialHandle = isBulb ? '@a_bulbcafejaipur' : '@gulabithali_thecloudkitchen';
            const socialUrl = isBulb ? 'https://instagram.com/a_bulbcafejaipur' : 'https://instagram.com/gulabithali_thecloudkitchen';
            
            const currentBrandName = isBulb ? 'Bulb Cafe' : 'Gulabi Thali';
            const switchTheme = isBulb ? 'gulabi' : 'bulb';
            const switchBrandName = isBulb ? 'GULABI THALI' : 'BULB CAFE';
            const switchButtonColor = isBulb ? 'bg-pink-500' : 'bg-yellow-500'; // Colors updated to match switch target

            const socialCaption = isBulb 
                ? "Post your coffee pics! Tag us for a shoutout." 
                : "Share your thali feast! Tag us to be featured.";

            $('#page-content').innerHTML = `
                <div class="p-4 space-y-6 text-center">
                     <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom">
                        <h2 class="text-2xl font-bold text-primary">Join Our Community!</h2>
                        <p class="text-secondary mt-1">${socialCaption}</p>
                        
                        <a href="${socialUrl}" target="_blank" class="social-card-gradient text-2xl font-bold my-4 block">${socialHandle}</a>
                        <p class="text-xs text-secondary mt-2">Scan to follow the official account!</p>
                    </div>

                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-custom">
                        <h2 class="text-2xl font-bold text-primary">Switch Brand View</h2>
                        <p class="text-secondary mt-1 mb-4">View the menu of the other brand quickly.</p>
                        <button onclick="app.toggleTheme('${switchTheme}')" class="w-full ${switchButtonColor} text-white font-extrabold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
                            View ${switchBrandName} Menu
                        </button>
                    </div>
                </div>
            `;
        },

        renderGulabiThaliKitchenPage() {
            const switchTheme = 'bulb';
            const switchBrandName = 'BULB CAFE';
            const switchButtonColor = 'bg-yellow-500';

            $('#page-content').innerHTML = `
                <div class="p-6 space-y-6 text-center">
                     <div class="bg-secondary p-8 rounded-xl shadow-lg border border-custom">
                        <span class="text-5xl mb-4 block">üçõ</span>
                        <h2 class="text-3xl font-bold text-primary mb-2">GULABI THALI KITCHEN</h2>
                        <p class="text-lg text-secondary mb-6">
                            Gulabi Thali operates as our specialized Dine-In Kitchen inside Bulb Cafe.
                        </p>
                        <ul class="text-left space-y-2 mb-8 list-disc list-inside text-secondary">
                            <li>Authentic Indian Cuisine</li>
                            <li>Dine-In Thali Specials Only</li>
                            <li>View menu on 'Menu' tab and order via staff.</li>
                            <li>All orders are placed through our service counter.</li>
                        </ul>
                        <p class="text-primary font-semibold mb-4">Ready to order quick bites and coffee?</p>
                        <button onclick="app.toggleTheme('${switchTheme}')" class="w-full ${switchButtonColor} text-white font-extrabold py-3 px-6 rounded-lg transition hover:opacity-90">
                            CLICK TO SWITCH TO ${switchBrandName}
                        </button>
                    </div>
                </div>
            `;
        },

        renderMorePage(){
            const loyaltyPoints = app.state.customerProfile?.loyalty_points ?? 0;
            const loyaltyExplanation = `<p class="text-xs text-secondary mt-1">Earn 10% back in points (1pt = ‚Çπ1) on orders over ‚Çπ350. Redeem up to 70% of your balance in the Cart.</p>`;
            const options = [
                { icon: "ü™ô", text: `Loyalty Points: ${loyaltyPoints}`, action: "", explanation: loyaltyExplanation },
                { icon: "üõé", text: "Call Staff for Assistance", action: "ui.showCallStaffModal()" },
                { icon: "üîÑ", text: "Switch Brand View", action: "ui.showBrandSwitcherModal()" },
                { icon: "üéÆ", text: "Play Games", action: "ui.showGamesModal()" },
                { icon: "üìú", text: "Order History", action: "ui.showOrderHistoryModal()" },
            ];
            $('#page-content').innerHTML = `
                <div class="p-4 space-y-3">
                    ${options.map(opt =>
                        opt.action
                        ? `<button onclick="${opt.action}" class="w-full flex items-center justify-between bg-secondary p-4 rounded-xl text-left border border-custom">
                               <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                               <span class="text-secondary">&rarr;</span>
                           </button>`
                        : `<div class="w-full bg-secondary p-4 rounded-xl text-left border border-custom">
                               <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                               ${opt.explanation || ''}
                           </div>`
                    ).join("")}
                </div>`;
        },

        showCallStaffModal() {
            ui.showModal('staff-modal', `
                 <h2 class="text-2xl font-bold text-center mb-4">Call Assistance</h2>
                 <p class="text-secondary text-center mb-6">Need assistance with your order, payment, or finding Gulabi Thali?</p>
                 <div class="space-y-3">
                    <button onclick="app.sendStaffCall('assistance'); ui.closeModal('staff-modal')" class="w-full flex items-center justify-center bg-secondary p-4 rounded-xl brand-text border brand-border"><span class="text-2xl mr-4">üõé</span><span class="font-semibold">General Help</span></button>
                    <button onclick="app.sendStaffCall('payment'); ui.closeModal('staff-modal')" class="w-full flex items-center justify-center bg-secondary p-4 rounded-xl brand-text border brand-border"><span class="text-2xl mr-4">üíµ</span><span class="font-semibold">Help with Payment</span></button>
                 </div>
                 <button onclick="ui.closeModal('staff-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `);
        },
        
        showBrandSwitcherModal(){
            const currentBrand = app.state.theme === 'bulb' ? 'Bulb Cafe' : 'Gulabi Thali';
            const switchTheme = app.state.theme === 'bulb' ? 'gulabi' : 'bulb';
            const switchBrandName = switchTheme === 'bulb' ? 'GULABI THALI' : 'BULB CAFE';
            const switchButtonColor = switchTheme === 'bulb' ? 'bg-pink-500' : 'bg-yellow-500'; // Colors updated to match switch target

            ui.showModal('brand-switcher-modal', `
                <h2 class="text-2xl font-bold text-center mb-4">Switch Menu View</h2>
                <p class="text-secondary text-center mb-6">You are currently viewing the **${currentBrand}** menu.</p>
                
                <button onclick="app.toggleTheme('${switchTheme}')" class="w-full ${switchButtonColor} text-white font-extrabold py-4 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
                    SWITCH TO ${switchBrandName}
                </button>
                <button onclick="ui.closeModal('brand-switcher-modal')" class="w-full mt-4 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },

        showPaymentModal(){
             ui.showModal('payment-modal', `
                <h2 class="text-xl font-bold text-primary mb-4">Select Payment</h2>
                <div class="space-y-3">
                    <button onclick="app.placeOrder('Pay at Counter', this)" class="payment-btn w-full flex items-center justify-center bg-secondary p-4 rounded-xl border border-custom"><span class="text-2xl mr-4">üíµ</span><span class="font-semibold">Pay at Counter</span></button>
                </div>
                <button onclick="ui.closeModal('payment-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
            `);
        },

        showItemDetailModal(itemId){
            const item = app.state.allMenuItems.find(i => i.id === itemId); if (!item) return;
            const cartItem = app.state.cart.find(ci => ci.id === itemId);
            const currentQuantity = cartItem ? cartItem.quantity : 0;
            const isViewOnly = app.state.theme === 'gulabi';

            let optionsHTML = Array.from({ length: 10 }, (_, i) => `<option value="${i + 1}" ${i + 1 === currentQuantity ? 'selected' : ''}>${i + 1}</option>`).join('');
            optionsHTML = `<option value="0" ${!cartItem ? 'selected' : ''}>0 (Remove)</option>` + optionsHTML;

            ui.showModal('item-detail-modal', `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-primary">${item.name || 'Item Detail'}</h2>
                        <p class="text-xl font-semibold text-secondary">‚Çπ${item.price.toFixed(2)}</p>
                    </div>
                    <div class="text-5xl">‚òïÔ∏è</div>
                </div>
                <p class="text-secondary mt-2">${item.description || 'No description available.'}</p>
                <div class="flex items-center justify-between my-6 bg-secondary p-3 rounded-lg">
                    <label for="modal-quantity-select" class="font-semibold text-primary">Quantity:</label>
                    <select id="modal-quantity-select" class="bg-primary border border-custom text-primary font-semibold rounded-lg p-2" ${isViewOnly ? 'disabled' : ''}>${optionsHTML}</select>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <button onclick="ui.closeModal('item-detail-modal')" class="w-full bg-secondary font-semibold py-3 rounded-lg">Back</button>
                    <button ${isViewOnly ? 'disabled' : ''} onclick="app.setCartItemQuantity(${item.id}, parseInt($('#modal-quantity-select').value))" class="w-full ${isViewOnly ? 'bg-gray-400' : 'brand-bg'} font-semibold py-3 rounded-lg">
                        ${isViewOnly ? 'VIEW ONLY' : (cartItem ? 'Update Quantity' : 'Add to Cart')}
                    </button>
                </div>`);
        },

        showGamesModal() {
            ui.showModal('games-modal', `
                <h2 class="text-2xl font-bold text-center mb-4">Entertainment</h2>
                <div class="space-y-3">
                    ${Object.values(GAMES).map(game => `
                        <div class="bg-secondary p-4 rounded-xl border border-custom">
                            <h3 class="text-lg font-bold text-primary mb-1">${game.title}</h3>
                            <p class="text-secondary text-sm mb-3">${game.description}</p>
                            <button onclick="GAMES['${game.id}'].start()" class="brand-bg font-semibold py-2 px-4 rounded-lg text-sm">Play</button>
                        </div>`).join("")}
                </div>
                <button onclick="ui.closeModal('games-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        },

        async showOrderHistoryModal() {
            if (!app.state.customerProfile || !app.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
            
            // Fetch orders and related items in one go
            const { data, error } = await supabase
                .from('orders')
                .select(`
                    id,
                    created_at,
                    final_amount,
                    total_amount,
                    discount_amount,
                    discount_points_redeemed,
                    order_items ( product_name, quantity )
                `)
                .eq('customer_id', app.state.customerProfile.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching history:", error);
                return ui.showToast("Could not load order history.");
            }
            
            const historyHTML = data?.length > 0 ? data.map(o => {
                const itemsList = o.order_items?.length > 0 ? o.order_items.map(i => `${i.product_name || 'Item'} (x${i.quantity})`).join(', ') : 'No items found';
                return `
                    <div class="bg-secondary p-3 rounded-lg border border-custom">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-bold">Order #${o.id.slice(0, 6)}</p>
                                <p class="text-xs text-secondary">${new Date(o.created_at).toLocaleString()}</p>
                            </div>
                            <p class="font-semibold">‚Çπ${(o.final_amount ?? o.total_amount).toFixed(2)}</p>
                        </div>
                        <div class="text-sm text-secondary mt-2">${itemsList}</div>
                        ${o.discount_amount > 0 ? `<p class="text-xs text-green-600 mt-1">Discount: -‚Çπ${o.discount_amount.toFixed(2)} (${o.discount_points_redeemed} points)</p>` : ''}
                    </div>`;
            }).join('') : '<p class="text-secondary text-center">No past orders found.</p>';

            ui.showModal('history-modal', `
                <h2 class="text-2xl font-bold text-center mb-4">Order History</h2>
                <div class="space-y-3 max-h-60 overflow-y-auto">${historyHTML}</div>
                <button onclick="ui.closeModal('history-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            `);
        }
    };

    // --- GAMES LOGIC ---
    const GAMES = {
        ticTacToe: {
            id: 'ticTacToe', title: 'Tic-Tac-Toe', description: 'Classic 2-player game for your table.',
            board: Array(9).fill(null),
            currentPlayer: "X",
            winner: null,
            start() {
                this.reset();
                ui.showModal('ttt-modal', `
                    <h2 class="text-2xl font-bold mb-2 text-center">Tic-Tac-Toe</h2>
                    <p id="ttt-status" class="font-semibold text-secondary mb-4 text-center">Player X's turn</p>
                    <div class="w-full max-w-[250px] mx-auto">
                        <div id="ttt-board" class="grid grid-cols-3 gap-2 my-4">
                            ${this.board.map((_, i) => `<div class="aspect-square bg-secondary flex items-center justify-center text-5xl sm:text-6xl font-bold rounded-lg cursor-pointer border border-custom" onclick="GAMES.ticTacToe.play(${i})"></div>`).join("")}
                        </div>
                    </div>
                    <button onclick="GAMES.ticTacToe.start()" class="w-full mt-2 brand-bg font-semibold py-3 rounded-lg">New Game</button>
                    <button onclick="ui.closeModal('ttt-modal')" class="w-full mt-2 bg-secondary py-3 rounded-lg">Close</button>
                `);
            },
            play(i) {
                if (this.board[i] || this.winner) return;
                this.board[i] = this.currentPlayer;
                this.checkWinner();
                this.currentPlayer = this.currentPlayer === "X" ? "O" : "X";
                this.updateUI();
            },
            checkWinner() {
                const lines = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8],
                    [0, 3, 6], [1, 4, 7], [2, 5, 8],
                    [0, 4, 8], [2, 4, 6]
                ];
                for (let line of lines) {
                    const [a, b, c] = line;
                    if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                        this.winner = this.board[a];
                        sound.play("win");
                        return;
                    }
                }
                if (this.board.every(cell => cell)) {
                    this.winner = "Draw";
                    sound.play("draw");
                }
            },
            updateUI() {
                $$("#ttt-board > div").forEach((cell, i) => {
                    cell.textContent = this.board[i];
                    cell.style.color = this.board[i] === "X" ? "var(--brand-primary)" : "var(--text-secondary)";
                });
                $("#ttt-status").textContent = this.winner ? (this.winner === "Draw" ? "It's a Draw!" : `Player ${this.winner} wins!`) : `Player ${this.currentPlayer}'s turn`;
            },
            reset() {
                this.board.fill(null);
                this.currentPlayer = "X";
                this.winner = null;
            }
        },
        coffeeTrivia: {
            id: 'coffeeTrivia', title: 'Coffee Trivia', description: 'Test your coffee knowledge!',
            currentQuestion: null,
            trivia: [
                { q: "Which country is the largest coffee producer?", o: ["Brazil", "Vietnam", "Colombia", "Ethiopia"], a: 0 },
                { q: "What does 'espresso' mean in Italian?", o: ["Fast", "Forced Out", "Dark", "Strong"], a: 1 },
                { q: "What is a 'Flat White'?", o: ["Espresso with milk foam", "Espresso with steamed milk", "Black coffee variant", "Milkshake"], a: 1 },
                { q: "What color are coffee cherries when ripe?", o: ["Green", "Blue", "Red", "Yellow"], a: 2 }
            ],
            start() {
                this.currentQuestion = this.trivia[Math.floor(Math.random() * this.trivia.length)];
                const item = this.currentQuestion;
                ui.showModal('trivia-modal', `
                    <div class="text-center">
                        <h2 class="text-xl font-bold mb-2">Coffee Trivia</h2>
                        <p class="text-secondary mb-6 h-12">${item.q}</p>
                        <div id="trivia-options" class="space-y-3">
                            ${item.o.map((opt, index) => `<button class="trivia-option w-full bg-secondary font-semibold p-3 rounded-lg text-left border border-custom" onclick="GAMES.coffeeTrivia.checkAnswer(${index}, ${item.a})">${opt}</button>`).join('')}
                        </div>
                        <button onclick="ui.closeModal('trivia-modal')" class="w-full mt-6 bg-secondary py-3 rounded-lg">Close</button>
                    </div>
                `);
            },
            checkAnswer(selectedIndex, correctIndex) {
                const options = $$('.trivia-option');
                options.forEach((btn, index) => {
                    btn.disabled = true;
                    if (index === correctIndex) {
                        btn.classList.remove('bg-secondary');
                        btn.classList.add('bg-green-500', 'text-white');
                    } else if (index === selectedIndex) {
                        btn.classList.remove('bg-secondary');
                        btn.classList.add('bg-red-500', 'text-white');
                    }
                });

                if (selectedIndex === correctIndex) {
                    sound.play('success');
                } else {
                    sound.play('draw');
                }

                setTimeout(() => GAMES.coffeeTrivia.start(), 2000);
            }
        },
    };

    // --- START APP ---
    document.addEventListener('DOMContentLoaded', () => {
        app.init();
    });

    // CRITICAL FIX: Move global exposure to the end of the script
    window.app = app;
    window.ui = ui;
    window.GAMES = GAMES; 

</script>
</body>
</html>


